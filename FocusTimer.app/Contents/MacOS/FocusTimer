#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
FocusTimer.app -  ì§‘ì¤‘ ëª¨ë“œ ì‹œìŠ¤í…œ(hybrid) v2.0.0
í†µí•© ë¡œì§ + ì™¸ë¶€ ì„¤ì • ë¶„ë¦¬ = ìµœì ì˜ í™•ì¥ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±
"""

import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import threading
import time
import datetime
import os
import sys
import signal
import random
import subprocess
import json
import hashlib
import fcntl
import stat
import socket
import urllib.request
import urllib.error
from pathlib import Path
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import psutil
from dataclasses import dataclass, asdict
from typing import List, Optional, Dict, Any
from datetime import timedelta
import requests

# ----- ì•± ê²½ë¡œ ì„¤ì • -----
APP_ROOT = Path(__file__).parent.parent
RESOURCES_PATH = APP_ROOT / "Resources"

# ì•± ë‚´ë¶€ ê°€ìƒí™˜ê²½ ê²½ë¡œ ì„¤ì •
APP_VENV_PATH = Path(__file__).parent / "venv"
EXTERNAL_VENV_PATH = APP_ROOT.parent / "focus_timer_env"

# Python ê²½ë¡œ ì„¤ì • (ìš°ì„ ìˆœìœ„: ì•± ë‚´ë¶€ ê°€ìƒí™˜ê²½ > ì™¸ë¶€ ê°€ìƒí™˜ê²½ > ì‹œìŠ¤í…œ Python)
if (APP_VENV_PATH / "bin" / "python").exists():
    PYTHON_PATH = APP_VENV_PATH / "bin" / "python"
    print(f"ğŸ”— ì•± ë‚´ë¶€ ê°€ìƒí™˜ê²½ ì‚¬ìš©: {PYTHON_PATH}")
elif (EXTERNAL_VENV_PATH / "bin" / "python").exists():
    PYTHON_PATH = EXTERNAL_VENV_PATH / "bin" / "python"
    print(f"ğŸ”— ì™¸ë¶€ ê°€ìƒí™˜ê²½ ì‚¬ìš©: {PYTHON_PATH}")
else:
    PYTHON_PATH = Path("/usr/bin/python3")
    print(f"ğŸ”— ì‹œìŠ¤í…œ Python ì‚¬ìš©: {PYTHON_PATH}")

# ----- ì•± ì •ë³´ ìƒìˆ˜ -----
PRODUCT_NAME = "FocusTimer"
VERSION = "2.0.0"

# ----- ì‹œìŠ¤í…œ ê²½ë¡œ ìƒìˆ˜ -----
STATE_PATH = "/Library/Application Support/FocusTimer/state.json"
LOG_PATH = "/var/log/FocusTimer/focus_timer.log"

# ----- ì„¤ì • ê´€ë¦¬ í´ë˜ìŠ¤ -----
class ConfigManager:
    def __init__(self):
        self.config_path = RESOURCES_PATH / "config.json"
        self.state_path = STATE_PATH
        self.config = self.load_config()
        self.ensure_directories()

    def ensure_directories(self):
        """í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±"""
        os.makedirs(os.path.dirname(self.state_path), exist_ok=True)
        os.makedirs("/var/log/FocusTimer", exist_ok=True)

    def load_config(self):
        """ì„¤ì • íŒŒì¼ ë¡œë“œ"""
        try:
            if self.config_path.exists():
                with open(self.config_path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                return self.get_default_config()
        except Exception as e:
            print(f"ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: {e}")
            return self.get_default_config()

    def get_default_config(self):
        """ê¸°ë³¸ ì„¤ì • ë°˜í™˜"""
        return {
            "app_info": {
                "name": "FocusTimer",
                "version": "2.0.0",
                "description": "Hybrid êµ¬ì¡° ì§‘ì¤‘ ëª¨ë“œ ì‹œìŠ¤í…œ"
            },
            "system_paths": {
                "hosts_file": "/etc/hosts",
                "redirect_ip": "127.0.0.1",
                "backup_path": "/Library/Application Support/FocusTimer/hosts_backup",
                "lock_file": "/Library/Application Support/FocusTimer/focus_timer.lock",
                "log_path": LOG_PATH,
                "pid_file": "/var/run/focus_timer.pid"
            },
            "blocked_websites": {
                "youtube": [
                    "youtube.com", "www.youtube.com", "m.youtube.com", "youtu.be",
                    "youtube-nocookie.com", "www.youtube-nocookie.com",
                    "youtube.googleapis.com", "www.youtube.googleapis.com",
                    "youtubei.googleapis.com", "www.youtubei.googleapis.com",
                    "yt3.ggpht.com", "i.ytimg.com", "ytimg.com", "www.ytimg.com",
                    "googlevideo.com", "www.googlevideo.com",
                    "shorts.youtube.com", "www.shorts.youtube.com"
                ],
                "social_media": [
                    "facebook.com", "www.facebook.com", "instagram.com", "www.instagram.com",
                    "twitter.com", "www.twitter.com", "x.com", "www.x.com",
                    "tiktok.com", "www.tiktok.com", "reddit.com", "www.reddit.com"
                ],
                "gaming": [
                    "twitch.tv", "www.twitch.tv", "discord.com", "www.discord.com",
                    "steamcommunity.com", "www.steamcommunity.com"
                ],
                "entertainment": [
                    "netflix.com", "www.netflix.com", "disneyplus.com", "www.disneyplus.com",
                    "spotify.com", "www.spotify.com"
                ]
            },
            "focus_mode": {
                "default_start_time": "09:00",
                "default_end_time": "18:00",
                "default_difficulty": 1,
                "max_difficulty": 5,
                "max_attempts": 3,
                "auto_restart_browser": True,
                "force_browser_restart": True
            },
            "security": {
                "enable_system_protection": True,
                "enable_file_monitoring": True,
                "enable_firewall_rules": False,
                "enable_dns_cache_flush": True,
                "enable_browser_cache_clear": True,
                "lock_hosts_file": True,
                "monitor_hosts_changes": True,
                "enable_auto_recovery": True
            },
            "gui_settings": {
                "window_size": {
                    "width": 900,
                    "height": 700
                },
                "theme": "clam",
                "auto_refresh_interval": 5,
                "log_lines_to_show": 20,
                "enable_notifications": True
            },
            "browsers": {
                "supported": [
                    "Google Chrome", "Safari", "Firefox", "Whale", "Microsoft Edge"
                ],
                "cache_paths": {
                    "Google Chrome": [
                        "~/Library/Caches/Google/Chrome/Default/Cache",
                        "~/Library/Application Support/Google/Chrome/Default/Cache"
                    ],
                    "Safari": [
                        "~/Library/Caches/com.apple.Safari",
                        "~/Library/Safari/LocalStorage"
                    ]
                }
            }
        }

    def get(self, key_path, default=None):
        """ì  í‘œê¸°ë²•ìœ¼ë¡œ ì„¤ì • ê°’ ê°€ì ¸ì˜¤ê¸°"""
        keys = key_path.split('.')
        value = self.config
        try:
            for key in keys:
                value = value[key]
            return value
        except (KeyError, TypeError):
            return default

    def save_config(self):
        """ì„¤ì • íŒŒì¼ ì €ì¥"""
        try:
            with open(self.config_path, 'w', encoding='utf-8') as f:
                json.dump(self.config, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")

    def get_all_blocked_websites(self):
        """ëª¨ë“  ì°¨ë‹¨í•  ì›¹ì‚¬ì´íŠ¸ ëª©ë¡ ë°˜í™˜"""
        websites = []
        blocked_sites = self.get("blocked_websites", {})
        if blocked_sites:
            for category, sites in blocked_sites.items():
                if sites:
                    websites.extend(sites)
        return websites

# ----- ì „ì—­ ì„¤ì • ì¸ìŠ¤í„´ìŠ¤ -----
config_manager = ConfigManager()

# ----- ì „ì—­ ìƒíƒœ í´ë˜ìŠ¤ -----
class FocusTimerState:
    def __init__(self):
        self.is_focus_mode = False
        self.focus_start_time = None
        self.focus_end_time = None
        self.is_blocked = False
        self.hosts_hash = None
        self.last_check = None
        self.block_count = 0
        self.bypass_attempts = 0
        self.difficulty_level = 1
        self.failed_attempts = 0

# ----- ë¡œê¹… ì‹œìŠ¤í…œ -----
class Logger:
    def __init__(self, log_file):
        self.log_file = log_file
        self.ensure_log_directory()

    def ensure_log_directory(self):
        os.makedirs(os.path.dirname(self.log_file), exist_ok=True)

    def log(self, level, message):
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        log_entry = f"[{timestamp}] [{level}] {message}"

        # ì½˜ì†” ì¶œë ¥
        print(log_entry)

        # íŒŒì¼ ë¡œê¹…
        try:
            with open(self.log_file, "a", encoding="utf-8") as f:
                f.write(log_entry + "\n")
        except:
            pass

# ----- ì‹œìŠ¤í…œ ë ˆë²¨ ë³´í˜¸ -----
class SystemProtection:
    def __init__(self):
        self.original_hosts_permissions = None
        self.firewall_rules = []
        # ì „ì—­ logger ì‚¬ìš© (Aì½”ë“œ ë°©ì‹)
        self.logger = global_logger

    def backup_hosts_permissions(self):
        """hosts íŒŒì¼ ì›ë³¸ ê¶Œí•œ ë°±ì—…"""
        try:
            hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")
            if hosts_path:
                stat_info = os.stat(str(hosts_path))
                self.original_hosts_permissions = stat_info.st_mode
                self.logger.log("INFO", "hosts íŒŒì¼ ê¶Œí•œ ë°±ì—… ì™„ë£Œ")
        except Exception as e:
            self.logger.log("ERROR", f"hosts íŒŒì¼ ê¶Œí•œ ë°±ì—… ì‹¤íŒ¨: {e}")

    def lock_hosts_file(self):
        """hosts íŒŒì¼ì„ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì ê¸ˆ"""
        try:
            hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")
            if hosts_path:
                os.chmod(str(hosts_path), stat.S_IRUSR | stat.S_IRGRP | stat.S_IROTH)  # 444
                self.logger.log("INFO", "hosts íŒŒì¼ ì ê¸ˆ ì™„ë£Œ")
        except Exception as e:
            self.logger.log("ERROR", f"hosts íŒŒì¼ ì ê¸ˆ ì‹¤íŒ¨: {e}")

    def unlock_hosts_file(self):
        """hosts íŒŒì¼ ì ê¸ˆ í•´ì œ"""
        try:
            hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")
            if hosts_path:
                if self.original_hosts_permissions:
                    os.chmod(str(hosts_path), self.original_hosts_permissions)
                else:
                    os.chmod(str(hosts_path), stat.S_IRUSR | stat.S_IWUSR | stat.S_IRGRP | stat.S_IROTH)  # 644
                self.logger.log("INFO", "hosts íŒŒì¼ ì ê¸ˆ í•´ì œ ì™„ë£Œ")
        except Exception as e:
            self.logger.log("ERROR", f"hosts íŒŒì¼ ì ê¸ˆ í•´ì œ ì‹¤íŒ¨: {e}")

    def setup_firewall_rules(self):
        """ë°©í™”ë²½ ê·œì¹™ ì„¤ì •"""
        if not config_manager.get("security.enable_firewall_rules", False):
            return

        try:
            # pfctlì„ ì‚¬ìš©í•œ ë°©í™”ë²½ ê·œì¹™ ì¶”ê°€
            rules = []
            websites = config_manager.get_all_blocked_websites()

            for domain in websites:
                rules.append(f'block drop out proto tcp to {domain} port 80')
                rules.append(f'block drop out proto tcp to {domain} port 443')

            # ì„ì‹œ ê·œì¹™ íŒŒì¼ ìƒì„±
            rules_file = "/tmp/focus_timer_pf.conf"
            with open(rules_file, "w") as f:
                f.write("\n".join(rules))

            # ë°©í™”ë²½ ê·œì¹™ ì ìš©
            subprocess.run(["sudo", "pfctl", "-f", rules_file], check=True)
            subprocess.run(["sudo", "pfctl", "-e"], check=True)  # ë°©í™”ë²½ í™œì„±í™”

            self.firewall_rules = rules
            self.logger.log("INFO", f"ë°©í™”ë²½ ê·œì¹™ {len(rules)}ê°œ ì ìš© ì™„ë£Œ")

        except Exception as e:
            self.logger.log("ERROR", f"ë°©í™”ë²½ ê·œì¹™ ì„¤ì • ì‹¤íŒ¨: {e}")

    def remove_firewall_rules(self):
        """ë°©í™”ë²½ ê·œì¹™ ì œê±°"""
        if not config_manager.get("security.enable_firewall_rules", False):
            return

        try:
            subprocess.run(["sudo", "pfctl", "-d"], check=True)  # ë°©í™”ë²½ ë¹„í™œì„±í™”
            self.logger.log("INFO", "ë°©í™”ë²½ ê·œì¹™ ì œê±° ì™„ë£Œ")
        except Exception as e:
            self.logger.log("ERROR", f"ë°©í™”ë²½ ê·œì¹™ ì œê±° ì‹¤íŒ¨: {e}")

# ----- ì§€ì†ì  ëª¨ë‹ˆí„°ë§ -----
class HostsFileMonitor(FileSystemEventHandler):
    def __init__(self, on_modify_callback):
        self.on_modify_callback = on_modify_callback
        self.last_modified = 0
        # ì „ì—­ logger ì‚¬ìš© (Aì½”ë“œ ë°©ì‹)
        self.logger = global_logger

    def on_modified(self, event):
        hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")
        if event.src_path == hosts_path:
            current_time = time.time()
            if current_time - self.last_modified > 1:  # ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€
                self.last_modified = current_time
                self.logger.log("WARNING", "hosts íŒŒì¼ ë³€ê²½ ê°ì§€ë¨")
                self.on_modify_callback()

class FocusTimerMonitor:
    def __init__(self):
        self.observer = None
        self.monitoring = False
        self.system_protection = SystemProtection()
        # ì „ì—­ logger ì‚¬ìš© (Aì½”ë“œ ë°©ì‹)
        self.logger = global_logger

    def start_monitoring(self):
        """íŒŒì¼ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì‹œì‘"""
        if not config_manager.get("security.monitor_hosts_changes", True):
            return

        try:
            self.observer = Observer()
            event_handler = HostsFileMonitor(self.handle_hosts_modification)
            hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")
            if hosts_path:
                hosts_dir = os.path.dirname(str(hosts_path))
                self.observer.schedule(event_handler, path=hosts_dir, recursive=False)
                self.observer.start()
                self.monitoring = True
                self.logger.log("INFO", "íŒŒì¼ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì‹œì‘")
        except Exception as e:
            self.logger.log("ERROR", f"ëª¨ë‹ˆí„°ë§ ì‹œì‘ ì‹¤íŒ¨: {e}")

    def stop_monitoring(self):
        """íŒŒì¼ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€"""
        if self.observer:
            self.observer.stop()
            self.observer.join()
            self.monitoring = False
            self.logger.log("INFO", "íŒŒì¼ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€")

    def handle_hosts_modification(self):
        """hosts íŒŒì¼ ìˆ˜ì • ì²˜ë¦¬"""
        if state.is_focus_mode and state.is_blocked:
            self.logger.log("WARNING", "ì§‘ì¤‘ ëª¨ë“œ ì¤‘ hosts íŒŒì¼ ìˆ˜ì • ì‹œë„ ê°ì§€")
            state.bypass_attempts += 1

            # ìë™ìœ¼ë¡œ ì°¨ë‹¨ ì¬ì ìš©
            self.reapply_blocking()

            # ë³´ì•ˆ ê°•í™”
            self.enhance_security()

    def reapply_blocking(self):
        """ì°¨ë‹¨ ì¬ì ìš©"""
        try:
            # hosts íŒŒì¼ ì ê¸ˆ í•´ì œ
            self.system_protection.unlock_hosts_file()

            # ì°¨ë‹¨ ì„¤ì • ì¬ì ìš©
            block_websites()

            # hosts íŒŒì¼ ë‹¤ì‹œ ì ê¸ˆ
            if config_manager.get("security.lock_hosts_file", True):
                self.system_protection.lock_hosts_file()

            # DNS ìºì‹œ ì´ˆê¸°í™”
            if config_manager.get("security.enable_dns_cache_flush", True):
                self.flush_dns_cache()

            self.logger.log("INFO", "ì°¨ë‹¨ ì¬ì ìš© ì™„ë£Œ")

        except Exception as e:
            self.logger.log("ERROR", f"ì°¨ë‹¨ ì¬ì ìš© ì‹¤íŒ¨: {e}")

    def enhance_security(self):
        """ë³´ì•ˆ ê°•í™”"""
        try:
            # ë°©í™”ë²½ ê·œì¹™ ê°•í™”
            self.system_protection.setup_firewall_rules()

            # ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘
            if config_manager.get("focus_mode.force_browser_restart", True):
                self.restart_browsers()

            # ì‹œìŠ¤í…œ ì•Œë¦¼
            self.send_system_notification("ë³´ì•ˆ ê²½ê³ ", "ì§‘ì¤‘ ëª¨ë“œ ì¤‘ ì°¨ë‹¨ í•´ì œ ì‹œë„ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.")

            self.logger.log("INFO", "ë³´ì•ˆ ê°•í™” ì™„ë£Œ")

        except Exception as e:
            self.logger.log("ERROR", f"ë³´ì•ˆ ê°•í™” ì‹¤íŒ¨: {e}")

    def flush_dns_cache(self):
        """DNS ìºì‹œ ì´ˆê¸°í™”"""
        try:
            subprocess.run(["sudo", "dscacheutil", "-flushcache"], check=True)
            subprocess.run(["sudo", "killall", "-HUP", "mDNSResponder"], check=True)
            self.logger.log("INFO", "DNS ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")
        except Exception as e:
            self.logger.log("ERROR", f"DNS ìºì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

    def restart_browsers(self):
        """ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘ (BrowserManager ì‚¬ìš©)"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.restart_browsers()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def send_system_notification(self, title, message):
        """ì‹œìŠ¤í…œ ì•Œë¦¼ ì „ì†¡"""
        try:
            subprocess.run([
                "osascript", "-e",
                f'display notification "{message}" with title "{title}"'
            ], capture_output=True)
        except:
            pass

# ----- ë¸Œë¼ìš°ì € ê´€ë¦¬ ì‹œìŠ¤í…œ -----
class BrowserManager:
    def __init__(self):
        supported_browsers = config_manager.get("browsers.supported")
        self.supported_browsers = supported_browsers if supported_browsers else [
            "Google Chrome", "Safari", "Firefox", "Whale", "Microsoft Edge"
        ]

        cache_paths = config_manager.get("browsers.cache_paths")
        self.cache_paths = cache_paths if cache_paths else {
            "Google Chrome": [
                "~/Library/Caches/Google/Chrome/Default/Cache",
                "~/Library/Application Support/Google/Chrome/Default/Cache",
                "~/Library/Application Support/Google/Chrome/Default/Code Cache",
                "~/Library/Application Support/Google/Chrome/Default/GPUCache"
            ],
            "Safari": [
                "~/Library/Caches/com.apple.Safari",
                "~/Library/Safari/LocalStorage",
                "~/Library/Safari/WebpageIcons.db"
            ],
            "Firefox": [
                "~/Library/Caches/Firefox/Profiles",
                "~/Library/Application Support/Firefox/Profiles"
            ],
            "Whale": [
                "~/Library/Caches/com.naver.whale",
                "~/Library/Application Support/Naver/Whale/Default/Cache"
            ],
            "Microsoft Edge": [
                "~/Library/Caches/com.microsoft.edgemac",
                "~/Library/Application Support/Microsoft Edge/Default/Cache"
            ]
        }

    def get_running_browsers(self):
        """í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì € ëª©ë¡ì„ ë°˜í™˜"""
        running_browsers = []

        for browser in self.supported_browsers:
            try:
                if browser == "Safari":
                    # SafariëŠ” ì‹¤ì œ ë¸Œë¼ìš°ì € í”„ë¡œì„¸ìŠ¤ë§Œ í™•ì¸
                    result = subprocess.run(["pgrep", "-f", "Safari.app/Contents/MacOS/Safari"],
                                          capture_output=True)
                else:
                    # ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ëŠ” ê¸°ì¡´ ë°©ì‹
                    result = subprocess.run(["pgrep", "-f", browser], capture_output=True)

                if result.returncode == 0:  # ì‹¤í–‰ ì¤‘ì´ë©´
                    running_browsers.append(browser)

            except Exception as e:
                logger.log("ERROR", f"{browser} ì‹¤í–‰ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {e}")

        return running_browsers

    def restart_browsers(self):
        """ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ë¥¼ ê°•ì œë¡œ ì¬ì‹œì‘"""
        running_browsers = self.get_running_browsers()

        if not running_browsers:
            logger.log("INFO", "ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return

        logger.log("INFO", f"ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘ ì‹œì‘: {', '.join(running_browsers)}")

        for browser in running_browsers:
            try:
                # ë¸Œë¼ìš°ì € ì¢…ë£Œ
                subprocess.run(["osascript", "-e", f'quit app "{browser}"'],
                             capture_output=True, timeout=5)
                time.sleep(2)

                # ê°•ì œ ì¢…ë£Œ
                subprocess.run(["pkill", "-f", browser], capture_output=True)
                time.sleep(1)

                # ì¬ì‹œì‘
                subprocess.run(["open", "-a", browser], capture_output=True)
                time.sleep(3)

                logger.log("INFO", f"{browser} ì¬ì‹œì‘ ì™„ë£Œ")

            except Exception as e:
                logger.log("ERROR", f"{browser} ì¬ì‹œì‘ ì‹¤íŒ¨: {e}")

    def force_browser_restart_with_focus(self):
        """ì§‘ì¤‘ ëª¨ë“œìš© ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            logger.log("INFO", f"ì§‘ì¤‘ ëª¨ë“œ: ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘ ì¤‘... ({', '.join(running_browsers)})")

            for browser in running_browsers:
                try:
                    # ë¸Œë¼ìš°ì €ë¥¼ ê°•ì œ ì¢…ë£Œ
                    subprocess.run(["osascript", "-e", f'quit app "{browser}"'],
                                 capture_output=True, timeout=5)
                    time.sleep(2)

                    # ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì´ë©´ ê°•ì œ ì¢…ë£Œ
                    result = subprocess.run(["pgrep", "-f", browser], capture_output=True)
                    if result.returncode == 0:
                        subprocess.run(["pkill", "-f", browser], capture_output=True)
                        time.sleep(1)

                    # ë¸Œë¼ìš°ì € ì¬ì‹œì‘
                    subprocess.run(["open", "-a", browser], capture_output=True)
                    time.sleep(3)

                    logger.log("INFO", f"{browser} ê°•ì œ ì¬ì‹œì‘ ì™„ë£Œ")

                except Exception as e:
                    logger.log("ERROR", f"{browser} ê°•ì œ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜: {e}")

            logger.log("INFO", "ëª¨ë“  ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜: {e}")

    def clear_browser_cache(self):
        """ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ì˜ ìºì‹œë§Œ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                logger.log("INFO", "ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return

            logger.log("INFO", f"ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™” ì¤‘... ({', '.join(running_browsers)})")

            for browser in running_browsers:
                if browser in self.cache_paths:
                    for path in self.cache_paths[browser]:
                        expanded_path = os.path.expanduser(path)
                        if os.path.exists(expanded_path):
                            try:
                                subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)
                                logger.log("INFO", f"{browser} ìºì‹œ ê²½ë¡œ ì´ˆê¸°í™”: {path}")
                            except Exception as e:
                                logger.log("ERROR", f"{browser} ìºì‹œ ê²½ë¡œ ì´ˆê¸°í™” ì‹¤íŒ¨: {path} - {e}")

            # ì‹œìŠ¤í…œ DNS ìºì‹œ ì´ˆê¸°í™”
            self.simple_dns_flush()

            logger.log("INFO", "ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

    def force_browser_cache_clear(self):
        """ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ì˜ ìºì‹œë§Œ ì´ˆê¸°í™” (ë¸Œë¼ìš°ì € ì¢…ë£Œ ì—†ì´)"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            logger.log("INFO", f"ë¸Œë¼ìš°ì € ìºì‹œ ê°•ì œ ì´ˆê¸°í™” ì¤‘... ({', '.join(running_browsers)})")

            for browser in running_browsers:
                try:
                    if browser in self.cache_paths:
                        for path in self.cache_paths[browser]:
                            expanded_path = os.path.expanduser(path)
                            if os.path.exists(expanded_path):
                                subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)

                    logger.log("INFO", f"{browser} ê°•ì œ ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

                except Exception as e:
                    logger.log("ERROR", f"{browser} ê°•ì œ ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

            logger.log("INFO", "ë¸Œë¼ìš°ì € ê°•ì œ ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ê°•ì œ ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

    def force_dns_cache_clear(self):
        """ë¸Œë¼ìš°ì €ë³„ DNS ìºì‹œ ì´ˆê¸°í™”"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            logger.log("INFO", f"ë¸Œë¼ìš°ì € DNS ìºì‹œ ì´ˆê¸°í™” ì¤‘... ({', '.join(running_browsers)})")

            for browser in running_browsers:
                try:
                    # ë¸Œë¼ìš°ì €ë³„ DNS ìºì‹œ ì´ˆê¸°í™”
                    if browser == "Google Chrome":
                        chrome_dns_paths = [
                            "~/Library/Application Support/Google/Chrome/Default/Network",
                            "~/Library/Caches/Google/Chrome/Default/Network"
                        ]
                        for path in chrome_dns_paths:
                            expanded_path = os.path.expanduser(path)
                            if os.path.exists(expanded_path):
                                subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)

                    elif browser == "Safari":
                        safari_dns_paths = [
                            "~/Library/Caches/com.apple.Safari/WebpageIcons.db",
                            "~/Library/Safari/LocalStorage"
                        ]
                        for path in safari_dns_paths:
                            expanded_path = os.path.expanduser(path)
                            if os.path.exists(expanded_path):
                                subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)

                    logger.log("INFO", f"{browser} DNS ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

                except Exception as e:
                    logger.log("ERROR", f"{browser} DNS ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

            logger.log("INFO", "ë¸Œë¼ìš°ì € DNS ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € DNS ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

    def save_browser_sessions(self):
        """ë¸Œë¼ìš°ì € ì„¸ì…˜ ì •ë³´ë¥¼ ì €ì¥"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            # ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì € ëª©ë¡ë§Œ ì €ì¥
            session_info = {
                "running_browsers": running_browsers,
                "timestamp": datetime.datetime.now().isoformat()
            }

            # ì„¸ì…˜ ì •ë³´ë¥¼ íŒŒì¼ì— ì €ì¥
            session_path = os.path.expanduser("~/focus_timer_sessions.json")
            with open(session_path, "w") as f:
                json.dump(session_info, f)

            logger.log("INFO", f"ë¸Œë¼ìš°ì € ì„¸ì…˜ ì •ë³´ ì €ì¥ ì™„ë£Œ ({len(running_browsers)}ê°œ ë¸Œë¼ìš°ì €)")

        except Exception as e:
            logger.log("ERROR", f"ì„¸ì…˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜: {e}")

    def restore_browser_sessions(self):
        """ë¸Œë¼ìš°ì € ì„¸ì…˜ì„ ìë™ìœ¼ë¡œ ë³µêµ¬"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            logger.log("INFO", f"ë¸Œë¼ìš°ì € ì„¸ì…˜ ë³µêµ¬ ì¤‘... ({', '.join(running_browsers)})")

            for browser in running_browsers:
                try:
                    # ë¸Œë¼ìš°ì € í™œì„±í™”
                    subprocess.run(["osascript", "-e", f'tell application "{browser}" to activate'],
                                 capture_output=True)
                    time.sleep(0.5)

                    # ìƒˆ ì°½ ë‹«ê¸° (Cmd+W)
                    for _ in range(3):
                        subprocess.run(["osascript", "-e",
                                      'tell application "System Events" to key code 13 using {command down}'],
                                     capture_output=True)
                        time.sleep(0.1)

                    # ë¸Œë¼ìš°ì € í™œì„±í™” ëŒ€ê¸°
                    time.sleep(1.5)

                    # Cmd+Shift+Të¡œ ì„¸ì…˜ ë³µêµ¬
                    subprocess.run(["osascript", "-e",
                                  'tell application "System Events" to key code 17 using {command down, shift down}'],
                                 capture_output=True)

                    logger.log("INFO", f"{browser} ì„¸ì…˜ ë³µêµ¬ ì™„ë£Œ")

                except Exception as e:
                    logger.log("ERROR", f"{browser} ì„¸ì…˜ ë³µêµ¬ ì¤‘ ì˜¤ë¥˜: {e}")

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì„¸ì…˜ ë³µêµ¬ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì„¸ì…˜ ë³µêµ¬ ì¤‘ ì˜¤ë¥˜: {e}")

    def simple_dns_flush(self):
        """DNS ìºì‹œë§Œ ì´ˆê¸°í™” (ê°€ì¥ ì•ˆì „í•˜ê³  ë¹ ë¥¸ ë°©ë²•)"""
        try:
            subprocess.run(["sudo", "dscacheutil", "-flushcache"], check=True)
            subprocess.run(["sudo", "killall", "-HUP", "mDNSResponder"], check=True)
            logger.log("INFO", "DNS ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")
        except Exception as e:
            logger.log("ERROR", f"DNS ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

    def optimized_browser_clear(self):
        """ìµœì í™”ëœ ë¸Œë¼ìš°ì € ì¡°ì‘ (DNS + ìƒˆë¡œê³ ì¹¨ë§Œ)"""
        try:
            # DNS ìºì‹œ ì´ˆê¸°í™”
            self.simple_dns_flush()

            # ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ë§Œ
            running_browsers = self.get_running_browsers()
            if running_browsers:
                logger.log("INFO", f"ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì¤‘... ({', '.join(running_browsers)})")
                for browser in running_browsers:
                    try:
                        subprocess.run(["osascript", "-e", f'tell application "{browser}" to activate'],
                                     capture_output=True)
                        time.sleep(1)  # ë¸Œë¼ìš°ì € í™œì„±í™” ëŒ€ê¸°
                        subprocess.run(["osascript", "-e",
                                      'tell application "System Events" to key code 15 using {command down}'],
                                     capture_output=True)
                        logger.log("INFO", f"{browser} ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ")
                    except Exception as e:
                        logger.log("ERROR", f"{browser} ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜: {e}")
                logger.log("INFO", "ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ")
        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì¡°ì‘ ì¤‘ ì˜¤ë¥˜: {e}")

    def force_browser_restart(self):
        """ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ë¥¼ ì•ˆì „í•˜ê²Œ ì¬ì‹œì‘í•˜ê³  ì„¸ì…˜ ë³µêµ¬"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            logger.log("INFO", f"ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ì¤‘... ({', '.join(running_browsers)})")

            # ë¸Œë¼ìš°ì € ì„¸ì…˜ ì €ì¥
            self.save_browser_sessions()

            for browser in running_browsers:
                try:
                    # ë¸Œë¼ìš°ì €ë¥¼ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ (AppleScript ì‚¬ìš©)
                    subprocess.run(["osascript", "-e", f'tell application "{browser}" to quit'],
                                 capture_output=True)
                    time.sleep(2)  # ì•ˆì „í•œ ì¢…ë£Œ ëŒ€ê¸°

                    # ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì´ë©´ ê°•ì œ ì¢…ë£Œ
                    result = subprocess.run(["pgrep", "-f", browser], capture_output=True)
                    if result.returncode == 0:
                        subprocess.run(["pkill", "-f", browser], capture_output=True)
                        time.sleep(1)

                    # ë¸Œë¼ìš°ì € ì¬ì‹œì‘
                    subprocess.run(["open", "-a", browser], capture_output=True)
                    logger.log("INFO", f"{browser} ì¬ì‹œì‘ ì™„ë£Œ")

                except Exception as e:
                    logger.log("ERROR", f"{browser} ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜: {e}")

            # ë¸Œë¼ìš°ì € ì¬ì‹œì‘ í›„ ì„¸ì…˜ ë³µêµ¬
            time.sleep(5)  # ë¸Œë¼ìš°ì € ë¡œë”© ëŒ€ê¸°
            self.restore_browser_sessions()

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ë° ì„¸ì…˜ ë³µêµ¬ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜: {e}")

    def force_browser_refresh(self):
        """ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ì—ë§Œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹ í˜¸ ì „ì†¡"""
        try:
            running_browsers = self.get_running_browsers()

            if not running_browsers:
                return

            logger.log("INFO", f"ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì¤‘... ({', '.join(running_browsers)})")

            for browser in running_browsers:
                try:
                    # ë¸Œë¼ìš°ì € í™œì„±í™”
                    subprocess.run(["osascript", "-e", f'tell application "{browser}" to activate'],
                                 capture_output=True)
                    time.sleep(1)  # ë¸Œë¼ìš°ì € í™œì„±í™” ëŒ€ê¸°

                    # ì˜¬ë°”ë¥¸ ìƒˆë¡œê³ ì¹¨ ë‹¨ì¶•í‚¤ ì‚¬ìš© (Cmd+R) - key code 15 ì‚¬ìš©
                    subprocess.run(["osascript", "-e",
                                  'tell application "System Events" to key code 15 using {command down}'],
                                 capture_output=True)

                    logger.log("INFO", f"{browser} ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ")

                except Exception as e:
                    logger.log("ERROR", f"{browser} ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜: {e}")

            logger.log("INFO", "ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜: {e}")

    def get_browser_status(self):
        """ë¸Œë¼ìš°ì € ìƒíƒœ ì •ë³´ ë°˜í™˜"""
        running_browsers = self.get_running_browsers()
        return {
            "running_browsers": running_browsers,
            "total_running": len(running_browsers),
            "supported_browsers": self.supported_browsers,
            "total_supported": len(self.supported_browsers)
        }

    # ----- ì§‘ì¤‘ ëª¨ë“œ ì—°ë™ ë¸Œë¼ìš°ì € ì œì–´ -----
    def focus_mode_browser_control(self, enable_focus=True):
        """ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ (ìë™í™”ëœ í†µí•© ì œì–´)"""
        try:
            if enable_focus:
                logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ: ë¸Œë¼ìš°ì € ê°•í™” ì œì–´ ì‹œì‘")

                # 1. ë¸Œë¼ìš°ì € ì„¸ì…˜ ì €ì¥ (ë³µêµ¬ìš©)
                self.save_browser_sessions()

                # 2. ê°•í™”ëœ ìºì‹œ ì´ˆê¸°í™”
                self.enhanced_cache_clear()

                # 3. ë¸Œë¼ìš°ì € ê°•ì œ ì¬ì‹œì‘ (ì§‘ì¤‘ ëª¨ë“œìš©)
                self.force_browser_restart_with_focus()

                # 4. ë¸Œë¼ìš°ì € ì°¨ë‹¨ ê°•í™”
                self.enhance_browser_blocking()

                # 5. ìë™ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                self.start_browser_monitoring()

                logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ: ë¸Œë¼ìš°ì € ê°•í™” ì œì–´ ì™„ë£Œ")
            else:
                logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ í•´ì œ: ë¸Œë¼ìš°ì € ì œì–´ ë³µêµ¬ ì‹œì‘")

                # 1. ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
                self.stop_browser_monitoring()

                # 2. ë¸Œë¼ìš°ì € ì°¨ë‹¨ í•´ì œ
                self.remove_browser_blocking()

                # 3. ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ë§Œ (ì¬ì‹œì‘ ëŒ€ì‹ )
                self.force_browser_refresh()

                # 4. ë¸Œë¼ìš°ì € ì •ìƒí™”
                self.normalize_browsers()

                logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ í•´ì œ: ë¸Œë¼ìš°ì € ì œì–´ ë³µêµ¬ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ ì‹¤íŒ¨: {e}")

    def enhanced_cache_clear(self):
        """ê°•í™”ëœ ìºì‹œ ì´ˆê¸°í™” (ì§‘ì¤‘ ëª¨ë“œìš©)"""
        try:
            logger.log("INFO", "ê°•í™”ëœ ìºì‹œ ì´ˆê¸°í™” ì‹œì‘")

            # 1. ì‹œìŠ¤í…œ DNS ìºì‹œ ì´ˆê¸°í™”
            self.simple_dns_flush()

            # 2. ë¸Œë¼ìš°ì €ë³„ DNS ìºì‹œ ì´ˆê¸°í™”
            self.force_dns_cache_clear()

            # 3. ë¸Œë¼ìš°ì € ìºì‹œ ê°•ì œ ì´ˆê¸°í™”
            self.force_browser_cache_clear()

            # 4. ì¶”ê°€ ë¸Œë¼ìš°ì € ë°ì´í„° ì •ë¦¬
            self.clear_additional_browser_data()

            logger.log("INFO", "ê°•í™”ëœ ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ê°•í™”ëœ ìºì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

    def clear_additional_browser_data(self):
        """ì¶”ê°€ ë¸Œë¼ìš°ì € ë°ì´í„° ì •ë¦¬"""
        try:
            running_browsers = self.get_running_browsers()

            for browser in running_browsers:
                if browser == "Google Chrome":
                    # Chrome ì¶”ê°€ ë°ì´í„° ì •ë¦¬
                    chrome_additional_paths = [
                        "~/Library/Application Support/Google/Chrome/Default/History",
                        "~/Library/Application Support/Google/Chrome/Default/Web Data",
                        "~/Library/Application Support/Google/Chrome/Default/Shortcuts"
                    ]
                    for path in chrome_additional_paths:
                        expanded_path = os.path.expanduser(path)
                        if os.path.exists(expanded_path):
                            subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)

                elif browser == "Safari":
                    # Safari ì¶”ê°€ ë°ì´í„° ì •ë¦¬
                    safari_additional_paths = [
                        "~/Library/Safari/History.db",
                        "~/Library/Safari/Downloads.plist",
                        "~/Library/Safari/LastSession.plist"
                    ]
                    for path in safari_additional_paths:
                        expanded_path = os.path.expanduser(path)
                        if os.path.exists(expanded_path):
                            subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)

            logger.log("INFO", "ì¶”ê°€ ë¸Œë¼ìš°ì € ë°ì´í„° ì •ë¦¬ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ì¶”ê°€ ë¸Œë¼ìš°ì € ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨: {e}")

    def enhance_browser_blocking(self):
        """ë¸Œë¼ìš°ì € ì°¨ë‹¨ ê°•í™”"""
        try:
            logger.log("INFO", "ë¸Œë¼ìš°ì € ì°¨ë‹¨ ê°•í™” ì‹œì‘")

            # 1. ë¸Œë¼ìš°ì €ë³„ ì°¨ë‹¨ í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜/í™œì„±í™”
            self.install_browser_extensions()

            # 2. ë¸Œë¼ìš°ì € ì„¤ì • ë³€ê²½
            self.modify_browser_settings()

            # 3. ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì ìš©
            self.apply_additional_blocking_rules()

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì°¨ë‹¨ ê°•í™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì°¨ë‹¨ ê°•í™” ì‹¤íŒ¨: {e}")

    def install_browser_extensions(self):
        """ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜/í™œì„±í™”"""
        try:
            # Chrome í™•ì¥ í”„ë¡œê·¸ë¨ (ì˜ˆì‹œ)
            chrome_extensions = [
                "cjpalhdlnbpafiamejdnhcphjbkeiagm",  # uBlock Origin
                "nngceckbapebfimnlniiiahkandclblb"   # Block Site
            ]

            # Safari í™•ì¥ í”„ë¡œê·¸ë¨ (ì˜ˆì‹œ)
            safari_extensions = [
                "com.el1t.uBlock-Safari",
                "com.block-site.safari"
            ]

            logger.log("INFO", "ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì¤€ë¹„ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì‹¤íŒ¨: {e}")

    def modify_browser_settings(self):
        """ë¸Œë¼ìš°ì € ì„¤ì • ë³€ê²½"""
        try:
            running_browsers = self.get_running_browsers()

            for browser in running_browsers:
                if browser == "Google Chrome":
                    # Chrome ì„¤ì • ë³€ê²½ (ì˜ˆì‹œ)
                    chrome_settings = {
                        "disable_plugins": True,
                        "disable_javascript": False,  # ê¸°ë³¸ ê¸°ëŠ¥ ìœ ì§€
                        "disable_images": False,
                        "disable_cookies": False
                    }

                elif browser == "Safari":
                    # Safari ì„¤ì • ë³€ê²½ (ì˜ˆì‹œ)
                    safari_settings = {
                        "disable_plugins": True,
                        "disable_javascript": False,
                        "disable_images": False,
                        "disable_cookies": False
                    }

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì„¤ì • ë³€ê²½ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì„¤ì • ë³€ê²½ ì‹¤íŒ¨: {e}")

    def apply_additional_blocking_rules(self):
        """ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì ìš©"""
        try:
            # ì¶”ê°€ ì°¨ë‹¨í•  ë„ë©”ì¸ ëª©ë¡
            additional_domains = [
                "*.youtube.com",
                "*.facebook.com",
                "*.instagram.com",
                "*.twitter.com",
                "*.netflix.com",
                "*.twitch.tv"
            ]

            # hosts íŒŒì¼ì— ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì ìš©
            hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")
            redirect_ip = config_manager.get("system_paths.redirect_ip", "127.0.0.1")

            with open(hosts_path, "a") as f:
                f.write("\n# FocusTimer Additional Blocking Rules\n")
                for domain in additional_domains:
                    f.write(f"{redirect_ip} {domain}\n")

            logger.log("INFO", "ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì ìš© ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì ìš© ì‹¤íŒ¨: {e}")

    def start_browser_monitoring(self):
        """ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì‹œì‘"""
        try:
            logger.log("INFO", "ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì‹œì‘")

            # ë¸Œë¼ìš°ì € í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œì‘
            self.browser_monitoring_active = True

            # ì£¼ê¸°ì  ë¸Œë¼ìš°ì € ìƒíƒœ ì²´í¬
            def monitor_browsers():
                while self.browser_monitoring_active:
                    try:
                        running_browsers = self.get_running_browsers()

                        # ìƒˆë¡œìš´ ë¸Œë¼ìš°ì €ê°€ ì‹¤í–‰ë˜ë©´ ì°¨ë‹¨ ì ìš©
                        for browser in running_browsers:
                            if browser not in self.monitored_browsers:
                                self.apply_browser_restrictions(browser)
                                self.monitored_browsers.add(browser)

                        time.sleep(5)  # 5ì´ˆë§ˆë‹¤ ì²´í¬

                    except Exception as e:
                        logger.log("ERROR", f"ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: {e}")
                        time.sleep(10)

            # ëª¨ë‹ˆí„°ë§ ìŠ¤ë ˆë“œ ì‹œì‘
            self.monitoring_thread = threading.Thread(target=monitor_browsers, daemon=True)
            self.monitoring_thread.start()

            logger.log("INFO", "ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ìŠ¤ë ˆë“œ ì‹œì‘")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì‹œì‘ ì‹¤íŒ¨: {e}")

    def stop_browser_monitoring(self):
        """ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì¤‘ì§€"""
        try:
            self.browser_monitoring_active = False
            if hasattr(self, 'monitoring_thread'):
                self.monitoring_thread.join(timeout=5)
            logger.log("INFO", "ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì¤‘ì§€")
        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ ì‹¤íŒ¨: {e}")

    def apply_browser_restrictions(self, browser):
        """ë¸Œë¼ìš°ì €ë³„ ì œí•œ ì‚¬í•­ ì ìš©"""
        try:
            logger.log("INFO", f"{browser} ì œí•œ ì‚¬í•­ ì ìš©")

            # ë¸Œë¼ìš°ì €ë³„ ì°¨ë‹¨ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì œí•œ
            if browser == "Google Chrome":
                # Chrome íŠ¹í™” ì œí•œ
                pass
            elif browser == "Safari":
                # Safari íŠ¹í™” ì œí•œ
                pass

            logger.log("INFO", f"{browser} ì œí•œ ì‚¬í•­ ì ìš© ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"{browser} ì œí•œ ì‚¬í•­ ì ìš© ì‹¤íŒ¨: {e}")

    def remove_browser_blocking(self):
        """ë¸Œë¼ìš°ì € ì°¨ë‹¨ í•´ì œ"""
        try:
            logger.log("INFO", "ë¸Œë¼ìš°ì € ì°¨ë‹¨ í•´ì œ ì‹œì‘")

            # 1. ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì œê±°
            self.remove_additional_blocking_rules()

            # 2. ë¸Œë¼ìš°ì € ì„¤ì • ë³µêµ¬
            self.restore_browser_settings()

            # 3. í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™”
            self.disable_browser_extensions()

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì°¨ë‹¨ í•´ì œ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨: {e}")

    def remove_additional_blocking_rules(self):
        """ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì œê±°"""
        try:
            hosts_path = config_manager.get("system_paths.hosts_file", "/etc/hosts")

            with open(hosts_path, "r") as f:
                lines = f.readlines()

            # ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì œê±°
            filtered_lines = []
            skip_section = False

            for line in lines:
                if "# FocusTimer Additional Blocking Rules" in line:
                    skip_section = True
                    continue
                elif skip_section and line.strip() == "":
                    skip_section = False
                    continue
                elif skip_section:
                    continue
                else:
                    filtered_lines.append(line)

            with open(hosts_path, "w") as f:
                f.writelines(filtered_lines)

            logger.log("INFO", "ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì œê±° ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì œê±° ì‹¤íŒ¨: {e}")

    def restore_browser_settings(self):
        """ë¸Œë¼ìš°ì € ì„¤ì • ë³µêµ¬"""
        try:
            logger.log("INFO", "ë¸Œë¼ìš°ì € ì„¤ì • ë³µêµ¬ ì‹œì‘")

            # ë¸Œë¼ìš°ì € ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬
            running_browsers = self.get_running_browsers()

            for browser in running_browsers:
                if browser == "Google Chrome":
                    # Chrome ì„¤ì • ë³µêµ¬
                    pass
                elif browser == "Safari":
                    # Safari ì„¤ì • ë³µêµ¬
                    pass

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì„¤ì • ë³µêµ¬ ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì„¤ì • ë³µêµ¬ ì‹¤íŒ¨: {e}")

    def disable_browser_extensions(self):
        """ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™”"""
        try:
            logger.log("INFO", "ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™” ì‹œì‘")

            # í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™” ë¡œì§
            # (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë¸Œë¼ìš°ì €ë³„ í™•ì¥ í”„ë¡œê·¸ë¨ ê´€ë¦¬ í•„ìš”)

            logger.log("INFO", "ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ë¹„í™œì„±í™” ì‹¤íŒ¨: {e}")

    def normalize_browsers(self):
        """ë¸Œë¼ìš°ì € ì •ìƒí™” (ê°„ì†Œí™”ëœ ë²„ì „)"""
        try:
            logger.log("INFO", "ë¸Œë¼ìš°ì € ì •ìƒí™” ì‹œì‘")

            # 1. DNS ìºì‹œ ì´ˆê¸°í™”ë§Œ
            self.simple_dns_flush()

            # 2. ë¸Œë¼ìš°ì € ìƒíƒœ í™•ì¸
            running_browsers = self.get_running_browsers()
            logger.log("INFO", f"ì •ìƒí™”ëœ ë¸Œë¼ìš°ì €: {', '.join(running_browsers)}")

            logger.log("INFO", "ë¸Œë¼ìš°ì € ì •ìƒí™” ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì •ìƒí™” ì‹¤íŒ¨: {e}")

    def __init__(self):
        # ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ...
        supported_browsers = config_manager.get("browsers.supported")
        self.supported_browsers = supported_browsers if supported_browsers else [
            "Google Chrome", "Safari", "Firefox", "Whale", "Microsoft Edge"
        ]

        cache_paths = config_manager.get("browsers.cache_paths")
        self.cache_paths = cache_paths if cache_paths else {
            "Google Chrome": [
                "~/Library/Caches/Google/Chrome/Default/Cache",
                "~/Library/Application Support/Google/Chrome/Default/Cache",
                "~/Library/Application Support/Google/Chrome/Default/Code Cache",
                "~/Library/Application Support/Google/Chrome/Default/GPUCache"
            ],
            "Safari": [
                "~/Library/Caches/com.apple.Safari",
                "~/Library/Safari/LocalStorage",
                "~/Library/Safari/WebpageIcons.db"
            ],
            "Firefox": [
                "~/Library/Caches/Firefox/Profiles",
                "~/Library/Application Support/Firefox/Profiles"
            ],
            "Whale": [
                "~/Library/Caches/com.naver.whale",
                "~/Library/Application Support/Naver/Whale/Default/Cache"
            ],
            "Microsoft Edge": [
                "~/Library/Caches/com.microsoft.edgemac",
                "~/Library/Application Support/Microsoft Edge/Default/Cache"
            ]
        }

        # ì§‘ì¤‘ ëª¨ë“œ ì—°ë™ì„ ìœ„í•œ ì¶”ê°€ ë³€ìˆ˜ë“¤
        self.browser_monitoring_active = False
        self.monitored_browsers = set()
        self.monitoring_thread = None

# ----- ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ -----
state = FocusTimerState()
challenge = None
global_browser_manager = BrowserManager()  # ì „ì—­ ë¸Œë¼ìš°ì € ê´€ë¦¬ì

# ----- ë¡œê¹… ì‹œìŠ¤í…œ -----
# ì „ì—­ Logger ì‹±ê¸€í„´ íŒ¨í„´
global_logger = Logger(config_manager.get("system_paths.log_path", "/var/log/FocusTimer/focus_timer.log"))
logger = global_logger  # í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­

# ----- ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ì‹œìŠ¤í…œ -----
class AlgorithmChallenge:
    def __init__(self):
        self.difficulty_level = config_manager.get("focus_mode.default_difficulty", 1)
        self.max_attempts = config_manager.get("focus_mode.max_attempts", 3)
        self.failed_attempts = 0

    def generate_problem(self):
        """ë‚œì´ë„ì— ë”°ë¥¸ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ìƒì„±"""
        if self.difficulty_level == 1:
            # ê¸°ë³¸ ì‚¬ì¹™ì—°ì‚°
            a = random.randint(10, 99)
            b = random.randint(10, 99)
            operation = random.choice(["+", "-", "*"])

            if operation == "+":
                answer = a + b
            elif operation == "-":
                answer = a - b
            else:
                answer = a * b

            return f"{a} {operation} {b} = ?", answer

        elif self.difficulty_level == 2:
            # 3ìë¦¬ ìˆ˜ ì—°ì‚°
            a = random.randint(100, 999)
            b = random.randint(10, 99)
            operation = random.choice(["+", "-", "*"])

            if operation == "+":
                answer = a + b
            elif operation == "-":
                answer = a - b
            else:
                answer = a * b

            return f"{a} {operation} {b} = ?", answer

        elif self.difficulty_level == 3:
            # ë³µí•© ì—°ì‚°
            a = random.randint(10, 50)
            b = random.randint(5, 20)
            c = random.randint(2, 10)

            answer = (a + b) * c
            return f"({a} + {b}) Ã— {c} = ?", answer

        elif self.difficulty_level == 4:
            # í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´
            n = random.randint(5, 10)
            fib_sequence = [0, 1]
            for i in range(2, n + 1):
                fib_sequence.append(fib_sequence[i-1] + fib_sequence[i-2])
            answer = fib_sequence[n]
            return f"í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´ì˜ {n}ë²ˆì§¸ ìˆ˜ëŠ”? (F(0)=0, F(1)=1)", answer

        else:  # ë‚œì´ë„ 5
            # ì •ë ¬ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ
            numbers = [random.randint(1, 100) for _ in range(5)]
            sorted_numbers = sorted(numbers)
            answer = sorted_numbers[2]  # ì¤‘ê°„ê°’
            return f"ìˆ«ì {numbers}ë¥¼ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í–ˆì„ ë•Œ ì¤‘ê°„ê°’ì€?", answer

    def increase_difficulty(self):
        """ë‚œì´ë„ ì¦ê°€"""
        max_difficulty = config_manager.get("focus_mode.max_difficulty", 5)
        if self.difficulty_level < max_difficulty:
            self.difficulty_level += 1
            logger.log("INFO", f"ë‚œì´ë„ê°€ {self.difficulty_level}ë¡œ ì¦ê°€")

    def ask_challenge(self):
        """ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ì¶œì œ ë° ì •ë‹µ í™•ì¸"""
        logger.log("INFO", f"ë‚œì´ë„ {self.difficulty_level} ë¬¸ì œ ì¶œì œ")

        attempts = 0
        while attempts < self.max_attempts:
            problem, answer = self.generate_problem()
            print(f"\nğŸ“ ë¬¸ì œ: {problem}")

            try:
                user_input = input("ë‹µ: ").strip()

                if user_input.isdigit():
                    user_answer = int(user_input)
                else:
                    print("âš ï¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                    attempts += 1
                    continue

                if user_answer == answer:
                    logger.log("INFO", "ë¬¸ì œ í•´ê²° ì„±ê³µ")
                    return True
                else:
                    attempts += 1
                    remaining = self.max_attempts - attempts
                    print(f"âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: {answer}")
                    if remaining > 0:
                        print(f"ğŸ”„ ë‚¨ì€ ì‹œë„: {remaining}")
                    else:
                        print("ğŸš« ëª¨ë“  ì‹œë„ ì‹¤íŒ¨!")

            except KeyboardInterrupt:
                print("\nâš ï¸ ë¬¸ì œ í’€ì´ë¥¼ ì¤‘ë‹¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
                attempts += 1
            except:
                print("âš ï¸ ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                attempts += 1

        # ëª¨ë“  ì‹œë„ ì‹¤íŒ¨
        self.failed_attempts += 1
        if self.failed_attempts >= 2:
            self.increase_difficulty()
            self.failed_attempts = 0

        logger.log("WARNING", "ë¬¸ì œ í•´ê²° ì‹¤íŒ¨ - ì¢…ë£Œ ê±°ë¶€")
        return False

# ----- ë‹¤ì¤‘ ì°¨ë‹¨ ë ˆì´ì–´ -----
def block_websites():
    """ë‹¤ì¤‘ ë ˆì´ì–´ ì°¨ë‹¨ ì ìš© (ë¸Œë¼ìš°ì € ì œì–´ ì—°ë™)"""
    try:
        # 1. hosts íŒŒì¼ ì°¨ë‹¨
        block_hosts_file()

        # 2. ë°©í™”ë²½ ê·œì¹™ ì ìš©
        if config_manager.get("security.enable_firewall_rules", False):
            apply_firewall_rules()

        # 3. DNS ìºì‹œ ì´ˆê¸°í™”
        if config_manager.get("security.enable_dns_cache_flush", True):
            flush_dns_cache()

        # 4. ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™”
        if config_manager.get("security.enable_browser_cache_clear", True):
            clear_browser_cache()

        # 5. ë¸Œë¼ìš°ì € ê°•í™” ì œì–´ (ì§‘ì¤‘ ëª¨ë“œ ì—°ë™)
        if config_manager.get("browser_control.enable_focus_mode_integration", True):
            if 'global_browser_manager' in globals():
                global_browser_manager.focus_mode_browser_control(enable_focus=True)
            else:
                browser_manager = BrowserManager()
                browser_manager.focus_mode_browser_control(enable_focus=True)

        state.is_blocked = True
        state.block_count += 1
        logger.log("INFO", "ë‹¤ì¤‘ ë ˆì´ì–´ ì°¨ë‹¨ ì ìš© ì™„ë£Œ (ë¸Œë¼ìš°ì € ì œì–´ ì—°ë™)")

    except Exception as e:
        logger.log("ERROR", f"ì°¨ë‹¨ ì ìš© ì‹¤íŒ¨: {e}")

def unblock_websites():
    """ë‹¤ì¤‘ ë ˆì´ì–´ ì°¨ë‹¨ í•´ì œ (ê°•í™”ëœ ì§‘ì¤‘ëª¨ë“œ ì œí•œ)"""
    try:
        # ê°•í™”ëœ ì§‘ì¤‘ëª¨ë“œ ì œí•œ ì²´í¬
        if hasattr(state, 'is_focus_mode') and state.is_focus_mode:
            # ì§‘ì¤‘ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì°¨ë‹¨í•´ì œ ê¸ˆì§€
            logger.log("WARNING", "ì§‘ì¤‘ëª¨ë“œ í™œì„±í™” ìƒíƒœì—ì„œ ì°¨ë‹¨í•´ì œ ì‹œë„ ì°¨ë‹¨")

            # ì‚¬ìš´ë“œ ì¬ìƒ (ê°€ëŠ¥í•œ ê²½ìš°)
            try:
                import os
                os.system("afplay /System/Library/Sounds/Basso.aiff")
                os.system("afplay /System/Library/Sounds/Sosumi.aiff")
            except:
                pass

            return False

        # 1. hosts íŒŒì¼ ë³µêµ¬
        restore_hosts_file()

        # 2. ë°©í™”ë²½ ê·œì¹™ ì œê±°
        if config_manager.get("security.enable_firewall_rules", False):
            remove_firewall_rules()

        # 3. DNS ìºì‹œ ì´ˆê¸°í™”
        if config_manager.get("security.enable_dns_cache_flush", True):
            flush_dns_cache()

        # 4. ë¸Œë¼ìš°ì € ì œì–´ ë³µêµ¬ (ì§‘ì¤‘ ëª¨ë“œ í•´ì œ)
        if config_manager.get("browser_control.enable_focus_mode_integration", True):
            if 'global_browser_manager' in globals():
                global_browser_manager.focus_mode_browser_control(enable_focus=False)
            else:
                browser_manager = BrowserManager()
                browser_manager.focus_mode_browser_control(enable_focus=False)

        state.is_blocked = False
        logger.log("INFO", "ë‹¤ì¤‘ ë ˆì´ì–´ ì°¨ë‹¨ í•´ì œ ì™„ë£Œ (ë¸Œë¼ìš°ì € ì œì–´ ì—°ë™)")

    except Exception as e:
        logger.log("ERROR", f"ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨: {e}")

def apply_firewall_rules():
    """ë°©í™”ë²½ ê·œì¹™ ì ìš©"""
    try:
        # pfctlì„ ì‚¬ìš©í•œ ë°©í™”ë²½ ê·œì¹™
        rules = []
        websites = config_manager.get_all_blocked_websites()

        for domain in websites:
            rules.append(f'block drop out proto tcp to {domain} port 80')
            rules.append(f'block drop out proto tcp to {domain} port 443')

        rules_file = "/tmp/focus_timer_pf.conf"
        with open(rules_file, "w") as f:
            f.write("\n".join(rules))

        subprocess.run(["sudo", "pfctl", "-f", rules_file], check=True)
        subprocess.run(["sudo", "pfctl", "-e"], check=True)

        logger.log("INFO", "ë°©í™”ë²½ ê·œì¹™ ì ìš© ì™„ë£Œ")

    except Exception as e:
        logger.log("ERROR", f"ë°©í™”ë²½ ê·œì¹™ ì ìš© ì‹¤íŒ¨: {e}")

def remove_firewall_rules():
    """ë°©í™”ë²½ ê·œì¹™ ì œê±°"""
    try:
        subprocess.run(["sudo", "pfctl", "-d"], check=True)
        logger.log("INFO", "ë°©í™”ë²½ ê·œì¹™ ì œê±° ì™„ë£Œ")
    except Exception as e:
        logger.log("ERROR", f"ë°©í™”ë²½ ê·œì¹™ ì œê±° ì‹¤íŒ¨: {e}")

def block_hosts_file():
    """hosts íŒŒì¼ì— ì°¨ë‹¨ ì„¤ì • ì¶”ê°€"""
    try:
        hosts_path = config_manager.get("system_paths.hosts_file")
        redirect_ip = config_manager.get("system_paths.redirect_ip")
        websites = config_manager.get_all_blocked_websites()

        with open(hosts_path, "r+") as file:
            lines = file.readlines()

            # FocusTimer ë¸”ë¡ ì‹œì‘/ë ë§ˆì»¤
            block_start = "# FocusTimer Block Start\n"
            block_end = "# FocusTimer Block End\n"

            # ê¸°ì¡´ ë¸”ë¡ ì œê±°
            start_idx = -1
            end_idx = -1
            for i, line in enumerate(lines):
                if line == block_start:
                    start_idx = i
                elif line == block_end:
                    end_idx = i
                    break

            if start_idx != -1 and end_idx != -1:
                lines = lines[:start_idx] + lines[end_idx + 1:]

            # ìƒˆë¡œìš´ ì°¨ë‹¨ ì„¤ì • ì¶”ê°€
            new_entries = [block_start]
            for site in websites:
                new_entries.append(f"{redirect_ip} {site}\n")
            new_entries.append(block_end)

            # íŒŒì¼ì— ì“°ê¸°
            file.seek(0)
            file.writelines(lines + new_entries)
            file.truncate()
            file.flush()
            os.fsync(file.fileno())

            logger.log("INFO", "hosts íŒŒì¼ ì°¨ë‹¨ ì„¤ì • ì™„ë£Œ")

    except Exception as e:
        logger.log("ERROR", f"hosts íŒŒì¼ ì°¨ë‹¨ ì‹¤íŒ¨: {e}")

def restore_hosts_file():
    """hosts íŒŒì¼ì—ì„œ ì°¨ë‹¨ ì„¤ì • ì œê±°"""
    try:
        hosts_path = config_manager.get("system_paths.hosts_file")

        with open(hosts_path, "r+") as file:
            lines = file.readlines()

            block_start = "# FocusTimer Block Start\n"
            block_end = "# FocusTimer Block End\n"

            start_idx = -1
            end_idx = -1
            for i, line in enumerate(lines):
                if line == block_start:
                    start_idx = i
                elif line == block_end:
                    end_idx = i
                    break

            if start_idx != -1 and end_idx != -1:
                new_lines = lines[:start_idx] + lines[end_idx + 1:]
                file.seek(0)
                file.writelines(new_lines)
                file.truncate()
                file.flush()
                os.fsync(file.fileno())

                logger.log("INFO", "hosts íŒŒì¼ ë³µêµ¬ ì™„ë£Œ")
            else:
                logger.log("INFO", "ì°¨ë‹¨ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.")

    except Exception as e:
        logger.log("ERROR", f"hosts íŒŒì¼ ë³µêµ¬ ì‹¤íŒ¨: {e}")

def flush_dns_cache():
    """DNS ìºì‹œ ì´ˆê¸°í™”"""
    try:
        subprocess.run(["sudo", "dscacheutil", "-flushcache"], check=True)
        subprocess.run(["sudo", "killall", "-HUP", "mDNSResponder"], check=True)
        logger.log("INFO", "DNS ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ")
    except Exception as e:
        logger.log("ERROR", f"DNS ìºì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

def clear_browser_cache():
    """ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™” (BrowserManager ì‚¬ìš©)"""
    # ì „ì—­ BrowserManager ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if 'global_browser_manager' in globals():
        global_browser_manager.clear_browser_cache()
    else:
        browser_manager = BrowserManager()
        browser_manager.clear_browser_cache()

# ----- ìƒíƒœ ê´€ë¦¬ -----
def save_state():
    """ìƒíƒœ ì €ì¥"""
    try:
        state_data = {
            "is_focus_mode": state.is_focus_mode,
            "focus_start_time": state.focus_start_time.isoformat() if state.focus_start_time else None,
            "focus_end_time": state.focus_end_time.isoformat() if state.focus_end_time else None,
            "is_blocked": state.is_blocked,
            "block_count": state.block_count,
            "bypass_attempts": state.bypass_attempts,
            "difficulty_level": challenge.difficulty_level if challenge else 1,
            "failed_attempts": challenge.failed_attempts if challenge else 0,
            "last_check": datetime.datetime.now().isoformat()
        }

        with open(config_manager.state_path, "w") as f:
            json.dump(state_data, f, indent=2)

        logger.log("INFO", "ìƒíƒœ ì €ì¥ ì™„ë£Œ")

    except Exception as e:
        logger.log("ERROR", f"ìƒíƒœ ì €ì¥ ì‹¤íŒ¨: {e}")

def load_state():
    """ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°"""
    try:
        if os.path.exists(config_manager.state_path):
            with open(config_manager.state_path, "r") as f:
                state_data = json.load(f)

            state.is_focus_mode = state_data.get("is_focus_mode", False)
            state.is_blocked = state_data.get("is_blocked", False)
            state.block_count = state_data.get("block_count", 0)
            state.bypass_attempts = state_data.get("bypass_attempts", 0)

            if state_data.get("focus_start_time"):
                state.focus_start_time = datetime.datetime.fromisoformat(state_data["focus_start_time"])
            if state_data.get("focus_end_time"):
                state.focus_end_time = datetime.datetime.fromisoformat(state_data["focus_end_time"])

            if challenge:
                challenge.difficulty_level = state_data.get("difficulty_level", 1)
                challenge.failed_attempts = state_data.get("failed_attempts", 0)

            logger.log("INFO", "ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ")

    except Exception as e:
        logger.log("ERROR", f"ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: {e}")

# ----- GUI ì• í”Œë¦¬ì¼€ì´ì…˜ -----
class FocusTimerApp:
    def __init__(self):
        global challenge
        challenge = AlgorithmChallenge()
        self.monitor = FocusTimerMonitor()
        self.browser_manager = BrowserManager()  # ë¸Œë¼ìš°ì € ê´€ë¦¬ì ì´ˆê¸°í™”
        self.running = False
        self.monitor_thread = None

        # ë¸Œë¼ìš°ì € ê´€ë¦¬ ë©”ì„œë“œë“¤ì„ ë¯¸ë¦¬ ì •ì˜ (GUI ì´ˆê¸°í™” ì „)
        self._setup_browser_methods()

        # GUI ì´ˆê¸°í™”
        self.root = tk.Tk()

        # macOS íŠ¹í™” GUI ì„¤ì •
        self.setup_macos_gui()
        self.setup_gui()

        # ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
        load_state()

        # ì‹œìŠ¤í…œ ë³´í˜¸ ì´ˆê¸°í™”
        if config_manager.get("security.enable_system_protection", True):
            self.monitor.system_protection.backup_hosts_permissions()

        # ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
        self.user_preferences = self.load_user_preferences()

        # ì¢…ë£Œ ì œì–´ ë³€ìˆ˜
        self.exit_problem_solved = False
        self.exit_problem = None

        # ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        self.init_sound_system()

        # ëª¨ë‹ˆí„°ë§ ì‹œì‘
        if config_manager.get("security.monitor_hosts_changes", True):
            self.monitor.start_monitoring()

    def _setup_browser_methods(self):
        """ë¸Œë¼ìš°ì € ê´€ë¦¬ ë©”ì„œë“œë“¤ì„ ë¯¸ë¦¬ ì •ì˜"""
        # ----- ë¸Œë¼ìš°ì € ê´€ë¦¬ ë©”ì„œë“œ ì—°ê²° -----
        def restart_browsers(self):
            """ë¸Œë¼ìš°ì € ì¬ì‹œì‘ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.restart_browsers()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ì‹¤íŒ¨: {e}")

        def clear_browser_cache(self):
            """ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™” (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.clear_browser_cache()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

        def refresh_browsers(self):
            """ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.force_browser_refresh()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: {e}")

        def save_browser_sessions(self):
            """ë¸Œë¼ìš°ì € ì„¸ì…˜ ì €ì¥ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.save_browser_sessions()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨: {e}")

        def restore_browser_sessions(self):
            """ë¸Œë¼ìš°ì € ì„¸ì…˜ ë³µêµ¬ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.restore_browser_sessions()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì„¸ì…˜ ë³µêµ¬ ì‹¤íŒ¨: {e}")

        def safe_browser_restart(self):
            """ì•ˆì „í•œ ë¸Œë¼ìš°ì € ì¬ì‹œì‘ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.force_browser_restart()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ì•ˆì „í•œ ë¸Œë¼ìš°ì € ì¬ì‹œì‘ ì‹¤íŒ¨: {e}")

        def flush_dns_cache(self):
            """DNS ìºì‹œ ì´ˆê¸°í™” (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.simple_dns_flush()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"DNS ìºì‹œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

        def optimized_browser_clear(self):
            """ìµœì í™”ëœ ë¸Œë¼ìš°ì € ì •ë¦¬ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.optimized_browser_clear()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ìµœì í™”ëœ ë¸Œë¼ìš°ì € ì •ë¦¬ ì‹¤íŒ¨: {e}")

        def refresh_browser_status(self):
            """ë¸Œë¼ìš°ì € ìƒíƒœ ìƒˆë¡œê³ ì¹¨ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    status = self.browser_manager.get_browser_status()
                    logger.log("INFO", f"ë¸Œë¼ìš°ì € ìƒíƒœ: {status}")
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: {e}")

        def focus_mode_browser_control(self):
            """ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.focus_mode_browser_control(enable_focus=True)
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ ì‹¤íŒ¨: {e}")

        def release_focus_mode_browser(self):
            """ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € í•´ì œ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.focus_mode_browser_control(enable_focus=False)
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € í•´ì œ ì‹¤íŒ¨: {e}")

        def enhanced_browser_blocking(self):
            """ê°•í™”ëœ ë¸Œë¼ìš°ì € ì°¨ë‹¨ (BrowserManager ì—°ê²°)"""
            try:
                if hasattr(self, 'browser_manager') and self.browser_manager:
                    self.browser_manager.enhance_browser_blocking()
                else:
                    logger.log("ERROR", "ë¸Œë¼ìš°ì € ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            except Exception as e:
                logger.log("ERROR", f"ê°•í™”ëœ ë¸Œë¼ìš°ì € ì°¨ë‹¨ ì‹¤íŒ¨: {e}")

        # ë©”ì„œë“œë“¤ì„ ì¸ìŠ¤í„´ìŠ¤ì— ë°”ì¸ë”©
        self.restart_browsers = restart_browsers.__get__(self, type(self))
        self.clear_browser_cache = clear_browser_cache.__get__(self, type(self))
        self.refresh_browsers = refresh_browsers.__get__(self, type(self))
        self.save_browser_sessions = save_browser_sessions.__get__(self, type(self))
        self.restore_browser_sessions = restore_browser_sessions.__get__(self, type(self))
        self.safe_browser_restart = safe_browser_restart.__get__(self, type(self))
        self.flush_dns_cache = flush_dns_cache.__get__(self, type(self))
        self.optimized_browser_clear = optimized_browser_clear.__get__(self, type(self))
        self.refresh_browser_status = refresh_browser_status.__get__(self, type(self))
        self.focus_mode_browser_control = focus_mode_browser_control.__get__(self, type(self))
        self.release_focus_mode_browser = release_focus_mode_browser.__get__(self, type(self))
        self.enhanced_browser_blocking = enhanced_browser_blocking.__get__(self, type(self))



    def setup_macos_gui(self):
        """macOS íŠ¹í™” GUI ì„¤ì •"""
        try:
            # macOSì—ì„œ GUI ì°½ì„ ì•ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
            self.root.lift()
            self.root.attributes('-topmost', True)
            self.root.after_idle(self.root.attributes, '-topmost', False)

            # macOS ë„¤ì´í‹°ë¸Œ ë©”ë‰´ë°” ì„¤ì •
            self.root.createcommand('tk::mac::Quit', self.quit_app)
            self.root.createcommand('tk::mac::ShowPreferences', self.show_preferences)

            # ì°½ í¬ê¸° ì¡°ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            self.root.resizable(True, True)

            # ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì¢…ë£Œ ë°©ì§€)
            self.root.protocol("WM_DELETE_WINDOW", self.on_closing)

            # macOS ìŠ¤íƒ€ì¼ ì ìš©
            self.root.tk.call('tk', 'scaling', 2.0)  # ê³ í•´ìƒë„ ë””ìŠ¤í”Œë ˆì´ ì§€ì›

        except Exception as e:
            logger.log("ERROR", f"macOS GUI ì„¤ì • ì‹¤íŒ¨: {e}")

    def show_preferences(self):
        """ì„¤ì • ì°½ í‘œì‹œ"""
        # ì„¤ì • íƒ­ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        pass

    def setup_gui(self):
        """GUI ì„¤ì •"""
        app_name = config_manager.get("app_info.name", "FocusTimer")
        app_version = config_manager.get("app_info.version", "2.0.0")

        self.root.title(f"{app_name} v{app_version}")

        window_size = config_manager.get("gui_settings.window_size", {"width": 900, "height": 700})
        self.root.geometry(f"{window_size['width']}x{window_size['height']}")
        self.root.resizable(True, True)

        # ìŠ¤íƒ€ì¼ ì„¤ì •
        style = ttk.Style()
        theme = config_manager.get("gui_settings.theme", "clam")
        style.theme_use(theme)

        # ë©”ë‰´ë°” ì„¤ì •
        self.setup_menu()

        # ë©”ì¸ í”„ë ˆì„
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # ì œëª©
        title_label = ttk.Label(main_frame, text=f"â° {app_name}",
                               font=('Helvetica', 20, 'bold'))
        title_label.grid(row=0, column=0, columnspan=2, pady=(0, 20))

        # íƒ­ ìƒì„±
        self.notebook = ttk.Notebook(main_frame)
        self.notebook.grid(row=1, column=0, columnspan=2, sticky=(tk.W, tk.E, tk.N, tk.S))

        # íƒ­ ì¶”ê°€
        self.create_dashboard_tab()
        self.create_timer_tab()
        self.create_browser_tab()  # ë¸Œë¼ìš°ì € ê´€ë¦¬ íƒ­ ì¶”ê°€

                                # ì•Œê³ ë¦¬ì¦˜ ì‹œìŠ¤í…œ íƒ­ ì¶”ê°€ (ì•ˆì „í•œ ìë™ êµ¬ì„±)
        try:
            # Resources í´ë”ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
            if str(RESOURCES_PATH) not in sys.path:
                sys.path.insert(0, str(RESOURCES_PATH))

            # ì§ì ‘ import ì‹œë„ (ê°€ì¥ ì•ˆì „í•œ ë°©ë²•)
            try:
                from algorithm_tab import AlgorithmTab

                # AlgorithmTab ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° notebookì— ì‚½ì…
                self.algorithm_tab = AlgorithmTab(self.notebook)
                self.notebook.add(self.algorithm_tab.frame, text="ğŸ§® ì•Œê³ ë¦¬ì¦˜")

                print("âœ… ì•Œê³ ë¦¬ì¦˜ íƒ­ì´ ì„±ê³µì ìœ¼ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤. (ì§ì ‘ import)")

            except ImportError as direct_error:
                print(f"âŒ ì§ì ‘ import ì‹¤íŒ¨: {direct_error}")

                # ëŒ€ì²´ ë°©ë²•: Safe Import System ì‹œë„
                try:
                    from import_utils import get_importer

                    # SafeImporter ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                    importer = get_importer()

                    # algorithm_tab ëª¨ë“ˆ ì•ˆì „í•˜ê²Œ import
                    algorithm_tab_module = importer.import_module('algorithm_tab')

                    if algorithm_tab_module and hasattr(algorithm_tab_module, 'AlgorithmTab'):
                        # AlgorithmTab ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° notebookì— ì‚½ì…
                        self.algorithm_tab = algorithm_tab_module.AlgorithmTab(self.notebook)
                        self.notebook.add(self.algorithm_tab.frame, text="ğŸ§® ì•Œê³ ë¦¬ì¦˜")

                        print("âœ… ì•Œê³ ë¦¬ì¦˜ íƒ­ì´ ì„±ê³µì ìœ¼ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤. (Safe Import)")

                    else:
                        print("âŒ AlgorithmTab í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

                except ImportError as safe_error:
                    print(f"âŒ Safe Import Systemë„ ì‹¤íŒ¨: {safe_error}")
                    print("âš ï¸ ì•Œê³ ë¦¬ì¦˜ íƒ­ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Resources í´ë”ì˜ ëª¨ë“ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.")

        except Exception as e:
            print(f"âŒ ì•Œê³ ë¦¬ì¦˜ íƒ­ í†µí•© ì‹¤íŒ¨: {e}")
            print("âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")

        self.create_settings_tab()
        self.create_stats_tab()
        self.create_logs_tab()

        # ìƒíƒœë°”
        self.status_var = tk.StringVar(value="ì¤€ë¹„ë¨")
        status_bar = ttk.Label(main_frame, textvariable=self.status_var,
                              relief=tk.SUNKEN, anchor=tk.W)
        status_bar.grid(row=2, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(10, 0))

        # ê·¸ë¦¬ë“œ ê°€ì¤‘ì¹˜
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(1, weight=1)

    def setup_menu(self):
        """ë©”ë‰´ë°” ì„¤ì •"""
        menubar = tk.Menu(self.root)
        self.root.config(menu=menubar)

        # íŒŒì¼ ë©”ë‰´
        file_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="íŒŒì¼", menu=file_menu)
        file_menu.add_command(label="ì„¤ì • ë‚´ë³´ë‚´ê¸°", command=self.export_config)
        file_menu.add_command(label="ì„¤ì • ê°€ì ¸ì˜¤ê¸°", command=self.import_config)
        file_menu.add_separator()
        file_menu.add_command(label="ì¢…ë£Œ", command=self.quit_app)

        # ë„êµ¬ ë©”ë‰´
        tools_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="ë„êµ¬", menu=tools_menu)
        tools_menu.add_command(label="CLI ëª¨ë“œ", command=self.open_cli)
        tools_menu.add_command(label="ì›¹ ì¸í„°í˜ì´ìŠ¤", command=self.open_web)
        tools_menu.add_separator()
        tools_menu.add_command(label="ë¡œê·¸ ë³´ê¸°", command=self.view_logs)

        # ë„ì›€ë§ ë©”ë‰´
        help_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="ë„ì›€ë§", menu=help_menu)
        help_menu.add_command(label="ì‚¬ìš©ë²•", command=self.show_help)
        help_menu.add_command(label="ì •ë³´", command=self.show_about)

    def create_dashboard_tab(self):
        """ëŒ€ì‹œë³´ë“œ íƒ­"""
        dashboard_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(dashboard_frame, text="ğŸ“Š ëŒ€ì‹œë³´ë“œ")

        # í˜„ì¬ ìƒíƒœ
        status_frame = ttk.LabelFrame(dashboard_frame, text="ğŸ“Š í˜„ì¬ ìƒíƒœ", padding="10")
        status_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.status_label = ttk.Label(status_frame, text="ì§‘ì¤‘ ëª¨ë“œ ë¹„í™œì„±í™”",
                                     font=('Helvetica', 14))
        self.status_label.grid(row=0, column=0, sticky=tk.W)

        # ì‹œê°„ í‘œì‹œ
        self.time_var = tk.StringVar(value="")
        time_label = ttk.Label(status_frame, textvariable=self.time_var,
                              font=('Helvetica', 10))
        time_label.grid(row=1, column=0, sticky=tk.W, pady=(5, 0))

        # ì‹¤ì‹œê°„ í†µê³„
        stats_frame = ttk.LabelFrame(dashboard_frame, text="ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„", padding="10")
        stats_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ì°¨ë‹¨ íšŸìˆ˜
        ttk.Label(stats_frame, text="ì°¨ë‹¨ íšŸìˆ˜:").grid(row=0, column=0, sticky=tk.W)
        self.block_count_var = tk.StringVar(value="0")
        ttk.Label(stats_frame, textvariable=self.block_count_var,
                 font=('Helvetica', 12, 'bold')).grid(row=0, column=1, padx=(10, 0))

        # ìš°íšŒ ì‹œë„
        ttk.Label(stats_frame, text="ìš°íšŒ ì‹œë„:").grid(row=1, column=0, sticky=tk.W, pady=(5, 0))
        self.bypass_attempts_var = tk.StringVar(value="0")
        ttk.Label(stats_frame, textvariable=self.bypass_attempts_var,
                 font=('Helvetica', 12, 'bold')).grid(row=1, column=1, padx=(10, 0), pady=(5, 0))

        # í˜„ì¬ ë‚œì´ë„
        ttk.Label(stats_frame, text="í˜„ì¬ ë‚œì´ë„:").grid(row=2, column=0, sticky=tk.W, pady=(5, 0))
        self.current_difficulty_var = tk.StringVar(value="1")
        ttk.Label(stats_frame, textvariable=self.current_difficulty_var,
                 font=('Helvetica', 12, 'bold')).grid(row=2, column=1, padx=(10, 0), pady=(5, 0))

        # ë³´ì•ˆ ìƒíƒœ
        ttk.Label(stats_frame, text="ë³´ì•ˆ ìƒíƒœ:").grid(row=3, column=0, sticky=tk.W, pady=(5, 0))
        self.security_status_var = tk.StringVar(value="ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í™œì„±í™”")
        ttk.Label(stats_frame, textvariable=self.security_status_var,
                 font=('Helvetica', 12, 'bold')).grid(row=3, column=1, padx=(10, 0), pady=(5, 0))

        # ë¹ ë¥¸ ì•¡ì…˜
        action_frame = ttk.LabelFrame(dashboard_frame, text="ğŸ¯ ë¹ ë¥¸ ì•¡ì…˜", padding="10")
        action_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Button(action_frame, text="ğŸš€ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘",
                  command=self.start_focus_mode).grid(row=0, column=0, padx=(0, 10))
        ttk.Button(action_frame, text="â¹ï¸ ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€",
                  command=self.stop_focus_mode).grid(row=0, column=1, padx=(0, 10))
        ttk.Button(action_frame, text="ğŸ”’ ì¦‰ì‹œ ì°¨ë‹¨",
                  command=self.block_now).grid(row=0, column=2, padx=(0, 10))
        ttk.Button(action_frame, text="ğŸ”“ ì¦‰ì‹œ í•´ì œ",
                  command=self.unblock_now).grid(row=0, column=3)

    def create_timer_tab(self):
        """íƒ€ì´ë¨¸ ì„¤ì • íƒ­"""
        timer_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(timer_frame, text="â° íƒ€ì´ë¨¸")

        # ì‹œê°„ ì„¤ì •
        time_frame = ttk.LabelFrame(timer_frame, text="ì‹œê°„ ì„¤ì •", padding="10")
        time_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Label(time_frame, text="ì‹œì‘ ì‹œê°„:").grid(row=0, column=0, sticky=tk.W)
        self.start_time_var = tk.StringVar(value=config_manager.get("focus_mode.default_start_time", "09:00"))
        ttk.Entry(time_frame, textvariable=self.start_time_var, width=10).grid(row=0, column=1, padx=(10, 0))

        ttk.Label(time_frame, text="ì¢…ë£Œ ì‹œê°„:").grid(row=1, column=0, sticky=tk.W, pady=(5, 0))
        self.end_time_var = tk.StringVar(value=config_manager.get("focus_mode.default_end_time", "18:00"))
        ttk.Entry(time_frame, textvariable=self.end_time_var, width=10).grid(row=1, column=1, padx=(10, 0), pady=(5, 0))

        # ë‚œì´ë„ ì„¤ì •
        difficulty_frame = ttk.LabelFrame(timer_frame, text="ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ë‚œì´ë„", padding="10")
        difficulty_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.difficulty_var = tk.IntVar(value=config_manager.get("focus_mode.default_difficulty", 1))
        max_difficulty = config_manager.get("focus_mode.max_difficulty", 5)
        for i in range(1, max_difficulty + 1):
            ttk.Radiobutton(difficulty_frame, text=f"ë‚œì´ë„ {i}",
                           variable=self.difficulty_var, value=i).grid(row=0, column=i-1, padx=(0, 10))

    def create_browser_tab(self):
        """ë¸Œë¼ìš°ì € ê´€ë¦¬ íƒ­"""
        browser_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(browser_frame, text="ğŸŒ ë¸Œë¼ìš°ì €")

        # ë¸Œë¼ìš°ì € ìƒíƒœ
        status_frame = ttk.LabelFrame(browser_frame, text="ğŸ“Š ë¸Œë¼ìš°ì € ìƒíƒœ", padding="10")
        status_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì € ëª©ë¡
        self.running_browsers_var = tk.StringVar(value="í™•ì¸ ì¤‘...")
        ttk.Label(status_frame, text="ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €:").grid(row=0, column=0, sticky=tk.W)
        ttk.Label(status_frame, textvariable=self.running_browsers_var,
                 font=('Helvetica', 10, 'bold')).grid(row=0, column=1, padx=(10, 0), sticky=tk.W)

        # ë¸Œë¼ìš°ì € ì œì–´ ë²„íŠ¼
        control_frame = ttk.LabelFrame(browser_frame, text="ğŸ® ë¸Œë¼ìš°ì € ì œì–´", padding="10")
        control_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ì²« ë²ˆì§¸ í–‰
        ttk.Button(control_frame, text="ğŸ”„ ë¸Œë¼ìš°ì € ì¬ì‹œì‘",
                  command=self.restart_browsers).grid(row=0, column=0, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸ§¹ ìºì‹œ ì´ˆê¸°í™”",
                  command=self.clear_browser_cache).grid(row=0, column=1, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸ”„ ìƒˆë¡œê³ ì¹¨",
                  command=self.refresh_browsers).grid(row=0, column=2, padx=(0, 10), pady=(0, 5))

        # ë‘ ë²ˆì§¸ í–‰
        ttk.Button(control_frame, text="ğŸ’¾ ì„¸ì…˜ ì €ì¥",
                  command=self.save_browser_sessions).grid(row=1, column=0, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸ“‚ ì„¸ì…˜ ë³µêµ¬",
                  command=self.restore_browser_sessions).grid(row=1, column=1, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸš€ ì•ˆì „ ì¬ì‹œì‘",
                  command=self.safe_browser_restart).grid(row=1, column=2, padx=(0, 10), pady=(0, 5))

        # ì„¸ ë²ˆì§¸ í–‰
        ttk.Button(control_frame, text="ğŸŒ DNS ì´ˆê¸°í™”",
                  command=self.flush_dns_cache).grid(row=2, column=0, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="âš¡ ìµœì í™” ì •ë¦¬",
                  command=self.optimized_browser_clear).grid(row=2, column=1, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨",
                  command=self.refresh_browser_status).grid(row=2, column=2, padx=(0, 10), pady=(0, 5))

        # ë„¤ ë²ˆì§¸ í–‰ (ì§‘ì¤‘ ëª¨ë“œ ì—°ë™)
        ttk.Button(control_frame, text="ğŸ¯ ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´",
                  command=self.focus_mode_browser_control).grid(row=3, column=0, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸ”“ ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € í•´ì œ",
                  command=self.release_focus_mode_browser).grid(row=3, column=1, padx=(0, 10), pady=(0, 5))
        ttk.Button(control_frame, text="ğŸ›¡ï¸ ê°•í™”ëœ ì°¨ë‹¨ ì ìš©",
                  command=self.enhanced_browser_blocking).grid(row=3, column=2, padx=(0, 10), pady=(0, 5))

        # ê³ ê¸‰ ì„¤ì •
        advanced_frame = ttk.LabelFrame(browser_frame, text="âš™ï¸ ê³ ê¸‰ ì„¤ì •", padding="10")
        advanced_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.auto_session_save_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(advanced_frame, text="ìë™ ì„¸ì…˜ ì €ì¥",
                       variable=self.auto_session_save_var).grid(row=0, column=0, sticky=tk.W)

        self.auto_cache_clear_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(advanced_frame, text="ìë™ ìºì‹œ ì´ˆê¸°í™”",
                       variable=self.auto_cache_clear_var).grid(row=0, column=1, sticky=tk.W, padx=(20, 0))

                # ë¸Œë¼ìš°ì € ì •ë³´
        info_frame = ttk.LabelFrame(browser_frame, text="â„¹ï¸ ë¸Œë¼ìš°ì € ì •ë³´", padding="10")
        info_frame.grid(row=3, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.browser_info_var = tk.StringVar(value="ë¡œë”© ì¤‘...")
        info_text = tk.Text(info_frame, height=6, width=60, wrap=tk.WORD)
        info_text.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # ìŠ¤í¬ë¡¤ë°” ì¶”ê°€
        scrollbar = ttk.Scrollbar(info_frame, orient=tk.VERTICAL, command=info_text.yview)
        scrollbar.grid(row=0, column=1, sticky=(tk.N, tk.S))
        info_text.configure(yscrollcommand=scrollbar.set)

        self.browser_info_text = info_text

        # ì‹¤ì‹œê°„ ë¸Œë¼ìš°ì € ì œì–´ ëŒ€ì‹œë³´ë“œ
        dashboard_frame = ttk.LabelFrame(browser_frame, text="ğŸ“Š ì‹¤ì‹œê°„ ë¸Œë¼ìš°ì € ëŒ€ì‹œë³´ë“œ", padding="10")
        dashboard_frame.grid(row=4, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ì²« ë²ˆì§¸ í–‰ - ë¸Œë¼ìš°ì €ë³„ ìƒíƒœ
        browser_status_frame = ttk.Frame(dashboard_frame)
        browser_status_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # Chrome ìƒíƒœ
        chrome_frame = ttk.LabelFrame(browser_status_frame, text="Chrome", padding="5")
        chrome_frame.grid(row=0, column=0, padx=(0, 10))
        self.chrome_status_var = tk.StringVar(value="í™•ì¸ ì¤‘...")
        ttk.Label(chrome_frame, textvariable=self.chrome_status_var, font=('Helvetica', 9)).grid(row=0, column=0)

        # Safari ìƒíƒœ
        safari_frame = ttk.LabelFrame(browser_status_frame, text="Safari", padding="5")
        safari_frame.grid(row=0, column=1, padx=(0, 10))
        self.safari_status_var = tk.StringVar(value="í™•ì¸ ì¤‘...")
        ttk.Label(safari_frame, textvariable=self.safari_status_var, font=('Helvetica', 9)).grid(row=0, column=0)

        # Firefox ìƒíƒœ
        firefox_frame = ttk.LabelFrame(browser_status_frame, text="Firefox", padding="5")
        firefox_frame.grid(row=0, column=2, padx=(0, 10))
        self.firefox_status_var = tk.StringVar(value="í™•ì¸ ì¤‘...")
        ttk.Label(firefox_frame, textvariable=self.firefox_status_var, font=('Helvetica', 9)).grid(row=0, column=0)

        # Whale ìƒíƒœ
        whale_frame = ttk.LabelFrame(browser_status_frame, text="Whale", padding="5")
        whale_frame.grid(row=0, column=3, padx=(0, 10))
        self.whale_status_var = tk.StringVar(value="í™•ì¸ ì¤‘...")
        ttk.Label(whale_frame, textvariable=self.whale_status_var, font=('Helvetica', 9)).grid(row=0, column=0)

        # Edge ìƒíƒœ
        edge_frame = ttk.LabelFrame(browser_status_frame, text="Edge", padding="5")
        edge_frame.grid(row=0, column=4)
        self.edge_status_var = tk.StringVar(value="í™•ì¸ ì¤‘...")
        ttk.Label(edge_frame, textvariable=self.edge_status_var, font=('Helvetica', 9)).grid(row=0, column=0)

        # ë‘ ë²ˆì§¸ í–‰ - ì‹¤ì‹œê°„ í†µê³„
        stats_frame = ttk.Frame(dashboard_frame)
        stats_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ëª¨ë‹ˆí„°ë§ ìƒíƒœ
        monitoring_frame = ttk.LabelFrame(stats_frame, text="ëª¨ë‹ˆí„°ë§ ìƒíƒœ", padding="5")
        monitoring_frame.grid(row=0, column=0, padx=(0, 10))
        self.monitoring_status_var = tk.StringVar(value="ë¹„í™œì„±í™”")
        ttk.Label(monitoring_frame, textvariable=self.monitoring_status_var, font=('Helvetica', 10, 'bold')).grid(row=0, column=0)

        # ì°¨ë‹¨ëœ ë¸Œë¼ìš°ì € ìˆ˜
        blocked_frame = ttk.LabelFrame(stats_frame, text="ì°¨ë‹¨ëœ ë¸Œë¼ìš°ì €", padding="5")
        blocked_frame.grid(row=0, column=1, padx=(0, 10))
        self.blocked_browsers_var = tk.StringVar(value="0ê°œ")
        ttk.Label(blocked_frame, textvariable=self.blocked_browsers_var, font=('Helvetica', 10, 'bold')).grid(row=0, column=0)

        # ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸
        update_frame = ttk.LabelFrame(stats_frame, text="ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸", padding="5")
        update_frame.grid(row=0, column=2)
        self.last_update_var = tk.StringVar(value="ì—†ìŒ")
        ttk.Label(update_frame, textvariable=self.last_update_var, font=('Helvetica', 9)).grid(row=0, column=0)

        # ê³ ê¸‰ ë¸Œë¼ìš°ì € ì„¤ì • íŒ¨ë„
        advanced_settings_frame = ttk.LabelFrame(browser_frame, text="âš™ï¸ ê³ ê¸‰ ë¸Œë¼ìš°ì € ì„¤ì •", padding="10")
        advanced_settings_frame.grid(row=5, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ì²« ë²ˆì§¸ í–‰ - ìë™í™” ì„¤ì •
        automation_frame = ttk.LabelFrame(advanced_settings_frame, text="ğŸ¤– ìë™í™” ì„¤ì •", padding="10")
        automation_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.auto_browser_monitoring_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(automation_frame, text="ìë™ ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§",
                       variable=self.auto_browser_monitoring_var).grid(row=0, column=0, sticky=tk.W)

        self.auto_cache_clear_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(automation_frame, text="ìë™ ìºì‹œ ì´ˆê¸°í™”",
                       variable=self.auto_cache_clear_var).grid(row=0, column=1, sticky=tk.W, padx=(20, 0))

        self.auto_session_save_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(automation_frame, text="ìë™ ì„¸ì…˜ ì €ì¥",
                       variable=self.auto_session_save_var).grid(row=0, column=2, sticky=tk.W, padx=(20, 0))

        # ë‘ ë²ˆì§¸ í–‰ - ì°¨ë‹¨ ì„¤ì •
        blocking_frame = ttk.LabelFrame(advanced_settings_frame, text="ğŸš« ì°¨ë‹¨ ì„¤ì •", padding="10")
        blocking_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.enable_enhanced_blocking_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(blocking_frame, text="ê°•í™”ëœ ì°¨ë‹¨ í™œì„±í™”",
                       variable=self.enable_enhanced_blocking_var).grid(row=0, column=0, sticky=tk.W)

        self.enable_browser_extensions_var = tk.BooleanVar(value=False)
        ttk.Checkbutton(blocking_frame, text="ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì‚¬ìš©",
                       variable=self.enable_browser_extensions_var).grid(row=0, column=1, sticky=tk.W, padx=(20, 0))

        self.enable_additional_rules_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(blocking_frame, text="ì¶”ê°€ ì°¨ë‹¨ ê·œì¹™ ì ìš©",
                       variable=self.enable_additional_rules_var).grid(row=0, column=2, sticky=tk.W, padx=(20, 0))

        # ì„¸ ë²ˆì§¸ í–‰ - ì„±ëŠ¥ ì„¤ì •
        performance_frame = ttk.LabelFrame(advanced_settings_frame, text="âš¡ ì„±ëŠ¥ ì„¤ì •", padding="10")
        performance_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.enable_dns_flush_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(performance_frame, text="DNS ìºì‹œ ìë™ ì´ˆê¸°í™”",
                       variable=self.enable_dns_flush_var).grid(row=0, column=0, sticky=tk.W)

        self.enable_optimized_clear_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(performance_frame, text="ìµœì í™”ëœ ì •ë¦¬ ì‚¬ìš©",
                       variable=self.enable_optimized_clear_var).grid(row=0, column=1, sticky=tk.W, padx=(20, 0))

        self.enable_force_refresh_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(performance_frame, text="ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‚¬ìš©",
                       variable=self.enable_force_refresh_var).grid(row=0, column=2, sticky=tk.W, padx=(20, 0))

        # ë¸Œë¼ìš°ì €ë³„ ìƒì„¸ ì„¤ì •
        browser_specific_frame = ttk.LabelFrame(browser_frame, text="ğŸ”§ ë¸Œë¼ìš°ì €ë³„ ìƒì„¸ ì„¤ì •", padding="10")
        browser_specific_frame.grid(row=6, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # ë¸Œë¼ìš°ì € ì„ íƒ
        browser_select_frame = ttk.Frame(browser_specific_frame)
        browser_select_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Label(browser_select_frame, text="ë¸Œë¼ìš°ì € ì„ íƒ:").grid(row=0, column=0, sticky=tk.W)
        self.selected_browser_var = tk.StringVar(value="Google Chrome")
        browser_combo = ttk.Combobox(browser_select_frame, textvariable=self.selected_browser_var,
                                    values=["Google Chrome", "Safari", "Firefox", "Whale", "Microsoft Edge"],
                                    state="readonly", width=15)
        browser_combo.grid(row=0, column=1, padx=(10, 0))
        browser_combo.bind('<<ComboboxSelected>>', self.on_browser_selected)

        # ë¸Œë¼ìš°ì €ë³„ ì„¤ì • ë²„íŠ¼ë“¤
        browser_buttons_frame = ttk.Frame(browser_specific_frame)
        browser_buttons_frame.grid(row=1, column=0, sticky=(tk.W, tk.E))

        ttk.Button(browser_buttons_frame, text="ğŸ”§ ê°œë³„ ì„¤ì •",
                  command=self.configure_browser).grid(row=0, column=0, padx=(0, 10))
        ttk.Button(browser_buttons_frame, text="ğŸ“Š ìƒì„¸ ì •ë³´",
                  command=self.show_browser_details).grid(row=0, column=1, padx=(0, 10))
        ttk.Button(browser_buttons_frame, text="ğŸ§¹ ê°œë³„ ì •ë¦¬",
                  command=self.clean_browser).grid(row=0, column=2, padx=(0, 10))
        ttk.Button(browser_buttons_frame, text="ğŸ”„ ê°œë³„ ì¬ì‹œì‘",
                  command=self.restart_browser).grid(row=0, column=3)

        # ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
        settings_buttons_frame = ttk.Frame(browser_specific_frame)
        settings_buttons_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(10, 0))

        ttk.Button(settings_buttons_frame, text="ğŸ’¾ ì„¤ì • ì €ì¥",
                  command=self.save_browser_settings).grid(row=0, column=0, padx=(0, 10))
        ttk.Button(settings_buttons_frame, text="ğŸ“‚ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°",
                  command=self.load_browser_settings).grid(row=0, column=1, padx=(0, 10))
        ttk.Button(settings_buttons_frame, text="ğŸ”„ ì„¤ì • ì´ˆê¸°í™”",
                  command=self.reset_browser_settings).grid(row=0, column=2)

    def create_settings_tab(self):
        """ì„¤ì • íƒ­"""
        settings_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(settings_frame, text="âš™ï¸ ì„¤ì •")

        # ì„¤ì • ì €ì¥ ìƒíƒœ í‘œì‹œ
        status_frame = ttk.Frame(settings_frame)
        status_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.settings_status_var = tk.StringVar(value="ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")
        ttk.Label(status_frame, textvariable=self.settings_status_var,
                 font=('Helvetica', 10, 'italic')).grid(row=0, column=0, sticky=tk.W)

        # ì¼ë°˜ ì„¤ì •
        general_frame = ttk.LabelFrame(settings_frame, text="ì¼ë°˜ ì„¤ì •", padding="10")
        general_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.auto_start_var = tk.BooleanVar(value=config_manager.get("general.auto_start", True))
        auto_start_cb = ttk.Checkbutton(general_frame, text="ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰",
                       variable=self.auto_start_var, command=lambda: self.on_setting_changed("general.auto_start", self.auto_start_var))
        auto_start_cb.grid(row=0, column=0, sticky=tk.W)

        self.browser_restart_var = tk.BooleanVar(value=config_manager.get("focus_mode.auto_restart_browser", True))
        browser_restart_cb = ttk.Checkbutton(general_frame, text="ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ ì‹œ ë¸Œë¼ìš°ì € ì¬ì‹œì‘",
                       variable=self.browser_restart_var, command=lambda: self.on_setting_changed("focus_mode.auto_restart_browser", self.browser_restart_var))
        browser_restart_cb.grid(row=1, column=0, sticky=tk.W, pady=(5, 0))

        # ë³´ì•ˆ ì„¤ì •
        security_frame = ttk.LabelFrame(settings_frame, text="ë³´ì•ˆ ì„¤ì •", padding="10")
        security_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.file_monitoring_var = tk.BooleanVar(value=config_manager.get("security.enable_file_monitoring", True))
        file_monitoring_cb = ttk.Checkbutton(security_frame, text="íŒŒì¼ ëª¨ë‹ˆí„°ë§ í™œì„±í™”",
                       variable=self.file_monitoring_var, command=lambda: self.on_setting_changed("security.enable_file_monitoring", self.file_monitoring_var))
        file_monitoring_cb.grid(row=0, column=0, sticky=tk.W)

        self.auto_recovery_var = tk.BooleanVar(value=config_manager.get("security.enable_auto_recovery", True))
        auto_recovery_cb = ttk.Checkbutton(security_frame, text="ìë™ ë³µêµ¬ í™œì„±í™”",
                       variable=self.auto_recovery_var, command=lambda: self.on_setting_changed("security.enable_auto_recovery", self.auto_recovery_var))
        auto_recovery_cb.grid(row=1, column=0, sticky=tk.W, pady=(5, 0))

        self.lock_hosts_var = tk.BooleanVar(value=config_manager.get("security.lock_hosts_file", True))
        lock_hosts_cb = ttk.Checkbutton(security_frame, text="hosts íŒŒì¼ ì ê¸ˆ",
                       variable=self.lock_hosts_var, command=lambda: self.on_setting_changed("security.lock_hosts_file", self.lock_hosts_var))
        lock_hosts_cb.grid(row=2, column=0, sticky=tk.W, pady=(5, 0))

        self.firewall_rules_var = tk.BooleanVar(value=config_manager.get("security.enable_firewall_rules", False))
        firewall_rules_cb = ttk.Checkbutton(security_frame, text="ë°©í™”ë²½ ê·œì¹™ ì ìš©",
                       variable=self.firewall_rules_var, command=lambda: self.on_setting_changed("security.enable_firewall_rules", self.firewall_rules_var))
        firewall_rules_cb.grid(row=3, column=0, sticky=tk.W, pady=(5, 0))

        self.dns_flush_var = tk.BooleanVar(value=config_manager.get("security.enable_dns_cache_flush", True))
        dns_flush_cb = ttk.Checkbutton(security_frame, text="DNS ìºì‹œ ì´ˆê¸°í™”",
                       variable=self.dns_flush_var, command=lambda: self.on_setting_changed("security.enable_dns_cache_flush", self.dns_flush_var))
        dns_flush_cb.grid(row=4, column=0, sticky=tk.W, pady=(5, 0))

        self.browser_cache_var = tk.BooleanVar(value=config_manager.get("security.enable_browser_cache_clear", True))
        browser_cache_cb = ttk.Checkbutton(security_frame, text="ë¸Œë¼ìš°ì € ìºì‹œ ì´ˆê¸°í™”",
                       variable=self.browser_cache_var, command=lambda: self.on_setting_changed("security.enable_browser_cache_clear", self.browser_cache_var))
        browser_cache_cb.grid(row=5, column=0, sticky=tk.W, pady=(5, 0))

        # ë¸Œë¼ìš°ì € ì„¤ì •
        browser_settings_frame = ttk.LabelFrame(settings_frame, text="ğŸŒ ë¸Œë¼ìš°ì € ì„¤ì •", padding="10")
        browser_settings_frame.grid(row=3, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.auto_browser_monitoring_var = tk.BooleanVar(value=config_manager.get("browser.auto_monitoring", True))
        auto_browser_monitoring_cb = ttk.Checkbutton(browser_settings_frame, text="ìë™ ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§",
                       variable=self.auto_browser_monitoring_var, command=lambda: self.on_setting_changed("browser.auto_monitoring", self.auto_browser_monitoring_var))
        auto_browser_monitoring_cb.grid(row=0, column=0, sticky=tk.W)

        self.auto_cache_clear_var = tk.BooleanVar(value=config_manager.get("browser.auto_cache_clear", True))
        auto_cache_clear_cb = ttk.Checkbutton(browser_settings_frame, text="ìë™ ìºì‹œ ì´ˆê¸°í™”",
                       variable=self.auto_cache_clear_var, command=lambda: self.on_setting_changed("browser.auto_cache_clear", self.auto_cache_clear_var))
        auto_cache_clear_cb.grid(row=0, column=1, sticky=tk.W, padx=(20, 0))

        self.auto_session_save_var = tk.BooleanVar(value=config_manager.get("browser.auto_session_save", True))
        auto_session_save_cb = ttk.Checkbutton(browser_settings_frame, text="ìë™ ì„¸ì…˜ ì €ì¥",
                       variable=self.auto_session_save_var, command=lambda: self.on_setting_changed("browser.auto_session_save", self.auto_session_save_var))
        auto_session_save_cb.grid(row=0, column=2, sticky=tk.W, padx=(20, 0))

        # ì„±ëŠ¥ ì„¤ì •
        performance_frame = ttk.LabelFrame(settings_frame, text="âš¡ ì„±ëŠ¥ ì„¤ì •", padding="10")
        performance_frame.grid(row=4, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.enable_dns_flush_var = tk.BooleanVar(value=config_manager.get("performance.enable_dns_flush", True))
        enable_dns_flush_cb = ttk.Checkbutton(performance_frame, text="DNS ìºì‹œ ìë™ ì´ˆê¸°í™”",
                       variable=self.enable_dns_flush_var, command=lambda: self.on_setting_changed("performance.enable_dns_flush", self.enable_dns_flush_var))
        enable_dns_flush_cb.grid(row=0, column=0, sticky=tk.W)

        self.enable_optimized_clear_var = tk.BooleanVar(value=config_manager.get("performance.enable_optimized_clear", True))
        enable_optimized_clear_cb = ttk.Checkbutton(performance_frame, text="ìµœì í™”ëœ ì •ë¦¬ ì‚¬ìš©",
                       variable=self.enable_optimized_clear_var, command=lambda: self.on_setting_changed("performance.enable_optimized_clear", self.enable_optimized_clear_var))
        enable_optimized_clear_cb.grid(row=0, column=1, sticky=tk.W, padx=(20, 0))

        self.enable_force_refresh_var = tk.BooleanVar(value=config_manager.get("performance.enable_force_refresh", True))
        enable_force_refresh_cb = ttk.Checkbutton(performance_frame, text="ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‚¬ìš©",
                       variable=self.enable_force_refresh_var, command=lambda: self.on_setting_changed("performance.enable_force_refresh", self.enable_force_refresh_var))
        enable_force_refresh_cb.grid(row=0, column=2, sticky=tk.W, padx=(20, 0))

        # ì„¤ì • ê´€ë¦¬ ë²„íŠ¼
        settings_control_frame = ttk.Frame(settings_frame)
        settings_control_frame.grid(row=5, column=0, sticky=(tk.W, tk.E), pady=(10, 0))

        ttk.Button(settings_control_frame, text="ğŸ’¾ ì„¤ì • ì €ì¥",
                  command=self.save_all_settings).grid(row=0, column=0, padx=(0, 10))
        ttk.Button(settings_control_frame, text="ğŸ“‚ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°",
                  command=self.load_all_settings).grid(row=0, column=1, padx=(0, 10))
        ttk.Button(settings_control_frame, text="ğŸ”„ ì„¤ì • ì´ˆê¸°í™”",
                  command=self.reset_all_settings).grid(row=0, column=2, padx=(0, 10))
        ttk.Button(settings_control_frame, text="ğŸ“‹ ì„¤ì • ë‚´ë³´ë‚´ê¸°",
                  command=self.export_settings).grid(row=0, column=3, padx=(0, 10))

    # ----- ì„¤ì • ê´€ë¦¬ ë©”ì„œë“œë“¤ -----
    def on_setting_changed(self, setting_key, variable):
        """ì„¤ì • ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬"""
        try:
            # ì„¤ì •ê°’ì„ ì§ì ‘ JSON íŒŒì¼ì— ì €ì¥í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
            self.save_setting_to_file(setting_key, variable.get())

            # ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸
            self.settings_status_var.set("ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤ - ìë™ ì €ì¥ë¨")

            # 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ë³µì›
            self.root.after(3000, lambda: self.settings_status_var.set("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"))

            # ì„¤ì • ë³€ê²½ì— ë”°ë¥¸ ì¦‰ì‹œ ì ìš©
            self.apply_setting_change(setting_key, variable.get())

            logger.log("INFO", f"ì„¤ì • ë³€ê²½ë¨: {setting_key} = {variable.get()}")

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • ë³€ê²½ ì‹¤íŒ¨: {setting_key} - {e}")
            self.settings_status_var.set("ì„¤ì • ë³€ê²½ ì‹¤íŒ¨")

    def save_setting_to_file(self, setting_key, value):
        """ì„¤ì •ì„ JSON íŒŒì¼ì— ì§ì ‘ ì €ì¥"""
        try:
            # ì„¤ì • íŒŒì¼ ê²½ë¡œ
            config_file = "config.json"
            if not os.path.exists(config_file):
                config_file = os.path.join(os.path.dirname(__file__), "config.json")

            # ê¸°ì¡´ ì„¤ì • ë¡œë“œ
            config_data = {}
            if os.path.exists(config_file):
                try:
                    with open(config_file, 'r', encoding='utf-8') as f:
                        config_data = json.load(f)
                except:
                    config_data = {}

            # ì  í‘œê¸°ë²•ìœ¼ë¡œ ì„¤ì •ê°’ ì„¤ì •
            keys = setting_key.split('.')
            current = config_data

            # ì¤‘ê°„ í‚¤ë“¤ ìƒì„±
            for key in keys[:-1]:
                if key not in current:
                    current[key] = {}
                current = current[key]

            # ë§ˆì§€ë§‰ í‚¤ì— ê°’ ì„¤ì •
            current[keys[-1]] = value

            # íŒŒì¼ì— ì €ì¥
            with open(config_file, 'w', encoding='utf-8') as f:
                json.dump(config_data, f, indent=2, ensure_ascii=False)

            logger.log("INFO", f"ì„¤ì • ì €ì¥ë¨: {setting_key} = {value}")

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: {e}")
            raise

    def apply_setting_change(self, setting_key, value):
        """ì„¤ì • ë³€ê²½ì— ë”°ë¥¸ ì¦‰ì‹œ ì ìš©"""
        try:
            if setting_key == "security.enable_file_monitoring":
                if value:
                    if hasattr(self, 'monitor'):
                        self.monitor.start_monitoring()
                else:
                    if hasattr(self, 'monitor'):
                        self.monitor.stop_monitoring()

            elif setting_key == "security.lock_hosts_file":
                if value and hasattr(self, 'monitor'):
                    self.monitor.system_protection.lock_hosts_file()
                elif not value and hasattr(self, 'monitor'):
                    self.monitor.system_protection.unlock_hosts_file()

            elif setting_key == "browser.auto_monitoring":
                # ë¸Œë¼ìš°ì € ëª¨ë‹ˆí„°ë§ì€ ì§‘ì¤‘ ëª¨ë“œì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ
                # ì—¬ê¸°ì„œëŠ” ì„¤ì •ë§Œ ì €ì¥í•˜ê³  ì‹¤ì œ ì ìš©ì€ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘/ì¢…ë£Œ ì‹œ ì²˜ë¦¬
                logger.log("INFO", f"ë¸Œë¼ìš°ì € ìë™ ëª¨ë‹ˆí„°ë§ ì„¤ì •: {value}")

            elif setting_key == "general.auto_start":
                # ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰ ì„¤ì • (macOS LaunchAgent)
                self.setup_auto_start(value)

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • ì ìš© ì‹¤íŒ¨: {setting_key} - {e}")

    def setup_auto_start(self, enable):
        """ì‹œìŠ¤í…œ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰ ì„¤ì •"""
        try:
            if enable:
                # LaunchAgent ìƒì„±
                launch_agent_dir = os.path.expanduser("~/Library/LaunchAgents")
                os.makedirs(launch_agent_dir, exist_ok=True)

                launch_agent_plist = os.path.join(launch_agent_dir, "com.focustimer.plist")
                plist_content = f"""<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.focustimer</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/python3</string>
        <string>{os.path.abspath(__file__)}</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
</dict>
</plist>"""

                with open(launch_agent_plist, 'w') as f:
                    f.write(plist_content)

                # LaunchAgent ë¡œë“œ
                os.system(f"launchctl load {launch_agent_plist}")
                logger.log("INFO", "ìë™ ì‹¤í–‰ ì„¤ì •ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤")

            else:
                # LaunchAgent ì œê±°
                launch_agent_plist = os.path.expanduser("~/Library/LaunchAgents/com.focustimer.plist")
                if os.path.exists(launch_agent_plist):
                    os.system(f"launchctl unload {launch_agent_plist}")
                    os.remove(launch_agent_plist)
                    logger.log("INFO", "ìë™ ì‹¤í–‰ ì„¤ì •ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤")

        except Exception as e:
            logger.log("ERROR", f"ìë™ ì‹¤í–‰ ì„¤ì • ì‹¤íŒ¨: {e}")

    def save_all_settings(self):
        """ëª¨ë“  ì„¤ì •ì„ ì €ì¥"""
        try:
            # í˜„ì¬ GUI ìƒíƒœì˜ ëª¨ë“  ì„¤ì •ì„ ì €ì¥
            settings_to_save = {
                "general.auto_start": self.auto_start_var.get(),
                "focus_mode.auto_restart_browser": self.browser_restart_var.get(),
                "security.enable_file_monitoring": self.file_monitoring_var.get(),
                "security.enable_auto_recovery": self.auto_recovery_var.get(),
                "security.lock_hosts_file": self.lock_hosts_var.get(),
                "security.enable_firewall_rules": self.firewall_rules_var.get(),
                "security.enable_dns_cache_flush": self.dns_flush_var.get(),
                "security.enable_browser_cache_clear": self.browser_cache_var.get(),
                "browser.auto_monitoring": self.auto_browser_monitoring_var.get(),
                "browser.auto_cache_clear": self.auto_cache_clear_var.get(),
                "browser.auto_session_save": self.auto_session_save_var.get(),
                "performance.enable_dns_flush": self.enable_dns_flush_var.get(),
                "performance.enable_optimized_clear": self.enable_optimized_clear_var.get(),
                "performance.enable_force_refresh": self.enable_force_refresh_var.get()
            }

            # ì§ì ‘ íŒŒì¼ì— ì €ì¥
            for key, value in settings_to_save.items():
                self.save_setting_to_file(key, value)

            self.settings_status_var.set("ëª¨ë“  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")
            logger.log("INFO", "ëª¨ë“  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤")

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")
            self.settings_status_var.set("ì„¤ì • ì €ì¥ ì‹¤íŒ¨")

    def load_all_settings(self):
        """ëª¨ë“  ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ê¸°"""
        try:
            # ì„¤ì • íŒŒì¼ì—ì„œ ì§ì ‘ ë¶ˆëŸ¬ì˜¤ê¸°
            config_data = self.load_settings_from_file()

            # GUI ì—…ë°ì´íŠ¸
            self.auto_start_var.set(config_data.get("general", {}).get("auto_start", True))
            self.browser_restart_var.set(config_data.get("focus_mode", {}).get("auto_restart_browser", True))
            self.file_monitoring_var.set(config_data.get("security", {}).get("enable_file_monitoring", True))
            self.auto_recovery_var.set(config_data.get("security", {}).get("enable_auto_recovery", True))
            self.lock_hosts_var.set(config_data.get("security", {}).get("lock_hosts_file", True))
            self.firewall_rules_var.set(config_data.get("security", {}).get("enable_firewall_rules", False))
            self.dns_flush_var.set(config_data.get("security", {}).get("enable_dns_cache_flush", True))
            self.browser_cache_var.set(config_data.get("security", {}).get("enable_browser_cache_clear", True))
            self.auto_browser_monitoring_var.set(config_data.get("browser", {}).get("auto_monitoring", True))
            self.auto_cache_clear_var.set(config_data.get("browser", {}).get("auto_cache_clear", True))
            self.auto_session_save_var.set(config_data.get("browser", {}).get("auto_session_save", True))
            self.enable_dns_flush_var.set(config_data.get("performance", {}).get("enable_dns_flush", True))
            self.enable_optimized_clear_var.set(config_data.get("performance", {}).get("enable_optimized_clear", True))
            self.enable_force_refresh_var.set(config_data.get("performance", {}).get("enable_force_refresh", True))

            self.settings_status_var.set("ì„¤ì •ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤")
            logger.log("INFO", "ëª¨ë“  ì„¤ì •ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤")

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: {e}")
            self.settings_status_var.set("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨")

    def load_settings_from_file(self):
        """ì„¤ì • íŒŒì¼ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°"""
        try:
            # ì„¤ì • íŒŒì¼ ê²½ë¡œ
            config_file = "config.json"
            if not os.path.exists(config_file):
                config_file = os.path.join(os.path.dirname(__file__), "config.json")

            # ì„¤ì • íŒŒì¼ ë¡œë“œ
            if os.path.exists(config_file):
                with open(config_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                return {}

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return {}

    def reset_all_settings(self):
        """ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”"""
        if messagebox.askyesno("í™•ì¸", "ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            try:
                # ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                default_settings = {
                    "general.auto_start": True,
                    "focus_mode.auto_restart_browser": True,
                    "security.enable_file_monitoring": True,
                    "security.enable_auto_recovery": True,
                    "security.lock_hosts_file": True,
                    "security.enable_firewall_rules": False,
                    "security.enable_dns_cache_flush": True,
                    "security.enable_browser_cache_clear": True,
                    "browser.auto_monitoring": True,
                    "browser.auto_cache_clear": True,
                    "browser.auto_session_save": True,
                    "performance.enable_dns_flush": True,
                    "performance.enable_optimized_clear": True,
                    "performance.enable_force_refresh": True
                }

                # GUI ì—…ë°ì´íŠ¸
                self.auto_start_var.set(default_settings["general.auto_start"])
                self.browser_restart_var.set(default_settings["focus_mode.auto_restart_browser"])
                self.file_monitoring_var.set(default_settings["security.enable_file_monitoring"])
                self.auto_recovery_var.set(default_settings["security.enable_auto_recovery"])
                self.lock_hosts_var.set(default_settings["security.lock_hosts_file"])
                self.firewall_rules_var.set(default_settings["security.enable_firewall_rules"])
                self.dns_flush_var.set(default_settings["security.enable_dns_cache_flush"])
                self.browser_cache_var.set(default_settings["security.enable_browser_cache_clear"])
                self.auto_browser_monitoring_var.set(default_settings["browser.auto_monitoring"])
                self.auto_cache_clear_var.set(default_settings["browser.auto_cache_clear"])
                self.auto_session_save_var.set(default_settings["browser.auto_session_save"])
                self.enable_dns_flush_var.set(default_settings["performance.enable_dns_flush"])
                self.enable_optimized_clear_var.set(default_settings["performance.enable_optimized_clear"])
                self.enable_force_refresh_var.set(default_settings["performance.enable_force_refresh"])

                                # ì§ì ‘ íŒŒì¼ì— ì €ì¥
                for key, value in default_settings.items():
                    self.save_setting_to_file(key, value)

                self.settings_status_var.set("ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤")
                logger.log("INFO", "ëª¨ë“  ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤")

            except Exception as e:
                logger.log("ERROR", f"ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                self.settings_status_var.set("ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨")

    def export_settings(self):
        """ì„¤ì •ì„ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°"""
        try:
            from tkinter import filedialog
            filename = filedialog.asksaveasfilename(
                defaultextension=".json",
                filetypes=[("JSON files", "*.json"), ("All files", "*.*")],
                title="ì„¤ì • ë‚´ë³´ë‚´ê¸°"
            )

            if filename:
                # í˜„ì¬ ì„¤ì • ìˆ˜ì§‘
                current_settings = {
                    "general.auto_start": self.auto_start_var.get(),
                    "focus_mode.auto_restart_browser": self.browser_restart_var.get(),
                    "security.enable_file_monitoring": self.file_monitoring_var.get(),
                    "security.enable_auto_recovery": self.auto_recovery_var.get(),
                    "security.lock_hosts_file": self.lock_hosts_var.get(),
                    "security.enable_firewall_rules": self.firewall_rules_var.get(),
                    "security.enable_dns_cache_flush": self.dns_flush_var.get(),
                    "security.enable_browser_cache_clear": self.browser_cache_var.get(),
                    "browser.auto_monitoring": self.auto_browser_monitoring_var.get(),
                    "browser.auto_cache_clear": self.auto_cache_clear_var.get(),
                    "browser.auto_session_save": self.auto_session_save_var.get(),
                    "performance.enable_dns_flush": self.enable_dns_flush_var.get(),
                    "performance.enable_optimized_clear": self.enable_optimized_clear_var.get(),
                    "performance.enable_force_refresh": self.enable_force_refresh_var.get()
                }

                # JSON íŒŒì¼ë¡œ ì €ì¥
                with open(filename, 'w', encoding='utf-8') as f:
                    json.dump(current_settings, f, indent=2, ensure_ascii=False)

                self.settings_status_var.set(f"ì„¤ì •ì´ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤: {os.path.basename(filename)}")
                logger.log("INFO", f"ì„¤ì •ì´ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤: {filename}")

        except Exception as e:
            logger.log("ERROR", f"ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: {e}")
            self.settings_status_var.set("ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨")

    def create_stats_tab(self):
        """í†µê³„ íƒ­"""
        stats_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(stats_frame, text="ğŸ“ˆ í†µê³„")

        # ê¸°ë³¸ í†µê³„
        basic_stats_frame = ttk.LabelFrame(stats_frame, text="ğŸ“Š ê¸°ë³¸ í†µê³„", padding="10")
        basic_stats_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.total_focus_time_var = tk.StringVar(value="0ì‹œê°„")
        ttk.Label(basic_stats_frame, text="ì´ ì§‘ì¤‘ ì‹œê°„:").grid(row=0, column=0, sticky=tk.W)
        ttk.Label(basic_stats_frame, textvariable=self.total_focus_time_var,
                 font=('Helvetica', 12, 'bold')).grid(row=0, column=1, padx=(10, 0))

        self.block_count_var = tk.StringVar(value="0íšŒ")
        ttk.Label(basic_stats_frame, text="ì°¨ë‹¨ íšŸìˆ˜:").grid(row=1, column=0, sticky=tk.W, pady=(5, 0))
        ttk.Label(basic_stats_frame, textvariable=self.block_count_var,
                 font=('Helvetica', 12, 'bold')).grid(row=1, column=1, padx=(10, 0), pady=(5, 0))

        self.bypass_attempts_var = tk.StringVar(value="0íšŒ")
        ttk.Label(basic_stats_frame, text="ìš°íšŒ ì‹œë„:").grid(row=2, column=0, sticky=tk.W, pady=(5, 0))
        ttk.Label(basic_stats_frame, textvariable=self.bypass_attempts_var,
                 font=('Helvetica', 12, 'bold')).grid(row=2, column=1, padx=(10, 0), pady=(5, 0))

        # ë³´ì•ˆ í†µê³„
        security_stats_frame = ttk.LabelFrame(stats_frame, text="ğŸ›¡ï¸ ë³´ì•ˆ í†µê³„", padding="10")
        security_stats_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.current_difficulty_var = tk.StringVar(value="1")
        ttk.Label(security_stats_frame, text="í˜„ì¬ ë‚œì´ë„:").grid(row=0, column=0, sticky=tk.W)
        ttk.Label(security_stats_frame, textvariable=self.current_difficulty_var,
                 font=('Helvetica', 12, 'bold')).grid(row=0, column=1, padx=(10, 0))

        self.security_status_var = tk.StringVar(value="ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í™œì„±í™”")
        ttk.Label(security_stats_frame, text="ë³´ì•ˆ ìƒíƒœ:").grid(row=1, column=0, sticky=tk.W, pady=(5, 0))
        ttk.Label(security_stats_frame, textvariable=self.security_status_var,
                 font=('Helvetica', 12, 'bold')).grid(row=1, column=1, padx=(10, 0), pady=(5, 0))

        self.failed_attempts_var = tk.StringVar(value="0íšŒ")
        ttk.Label(security_stats_frame, text="ì‹¤íŒ¨í•œ ì‹œë„:").grid(row=2, column=0, sticky=tk.W, pady=(5, 0))
        ttk.Label(security_stats_frame, textvariable=self.failed_attempts_var,
                 font=('Helvetica', 12, 'bold')).grid(row=2, column=1, padx=(10, 0), pady=(5, 0))

        # ì‹œìŠ¤í…œ í†µê³„
        system_stats_frame = ttk.LabelFrame(stats_frame, text="âš™ï¸ ì‹œìŠ¤í…œ í†µê³„", padding="10")
        system_stats_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        self.last_check_var = tk.StringVar(value="ì—†ìŒ")
        ttk.Label(system_stats_frame, text="ë§ˆì§€ë§‰ ì²´í¬:").grid(row=0, column=0, sticky=tk.W)
        ttk.Label(system_stats_frame, textvariable=self.last_check_var,
                 font=('Helvetica', 10)).grid(row=0, column=1, padx=(10, 0))

        self.monitoring_status_var = tk.StringVar(value="í™œì„±í™”")
        ttk.Label(system_stats_frame, text="ëª¨ë‹ˆí„°ë§ ìƒíƒœ:").grid(row=1, column=0, sticky=tk.W, pady=(5, 0))
        ttk.Label(system_stats_frame, textvariable=self.monitoring_status_var,
                 font=('Helvetica', 10)).grid(row=1, column=1, padx=(10, 0), pady=(5, 0))

        # í†µê³„ ì œì–´
        control_frame = ttk.Frame(stats_frame)
        control_frame.grid(row=3, column=0, sticky=(tk.W, tk.E), pady=(10, 0))

        ttk.Button(control_frame, text="ğŸ”„ í†µê³„ ìƒˆë¡œê³ ì¹¨",
                  command=self.refresh_stats).grid(row=0, column=0, padx=(0, 10))
        ttk.Button(control_frame, text="ğŸ“Š í†µê³„ ë‚´ë³´ë‚´ê¸°",
                  command=self.export_stats).grid(row=0, column=1, padx=(0, 10))
        ttk.Button(control_frame, text="ğŸ—‘ï¸ í†µê³„ ì´ˆê¸°í™”",
                  command=self.reset_stats).grid(row=0, column=2)

    def create_logs_tab(self):
        """ë¡œê·¸ ë·°ì–´ íƒ­"""
        logs_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(logs_frame, text="ğŸ“ ì‹œìŠ¤í…œ ë¡œê·¸")

        # ë¡œê·¸ ì œì–´
        control_frame = ttk.Frame(logs_frame)
        control_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Button(control_frame, text="ğŸ”„ ìƒˆë¡œê³ ì¹¨",
                  command=self.refresh_logs).grid(row=0, column=0, padx=(0, 10))
        ttk.Button(control_frame, text="ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°",
                  command=self.clear_logs).grid(row=0, column=1, padx=(0, 10))
        ttk.Button(control_frame, text="ğŸ’¾ ë¡œê·¸ ì €ì¥",
                  command=self.save_logs).grid(row=0, column=2)

        # ë¡œê·¸ í‘œì‹œ
        log_frame = ttk.LabelFrame(logs_frame, text="ì‹¤ì‹œê°„ ë¡œê·¸", padding="10")
        log_frame.grid(row=1, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), pady=(0, 10))

        # ë¡œê·¸ í…ìŠ¤íŠ¸ ìœ„ì ¯
        self.log_text = tk.Text(log_frame, height=15, width=80, font=('Courier', 9))
        log_scrollbar = ttk.Scrollbar(log_frame, orient=tk.VERTICAL, command=self.log_text.yview)
        self.log_text.configure(yscrollcommand=log_scrollbar.set)

        self.log_text.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        log_scrollbar.grid(row=0, column=1, sticky=(tk.N, tk.S))

        # ë¡œê·¸ í”„ë ˆì„ ê·¸ë¦¬ë“œ ê°€ì¤‘ì¹˜
        log_frame.columnconfigure(0, weight=1)
        log_frame.rowconfigure(0, weight=1)
        logs_frame.columnconfigure(0, weight=1)
        logs_frame.rowconfigure(1, weight=1)

    def refresh_logs(self):
        """ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ (Aì½”ë“œ ë°©ì‹ - ìµœê·¼ 50ì¤„ í‘œì‹œ)"""
        try:
            log_path = config_manager.get("system_paths.log_path", "/var/log/FocusTimer/focus_timer.log")
            if os.path.exists(log_path):
                with open(log_path, 'r', encoding='utf-8') as f:
                    logs = f.readlines()[-50:]  # ìµœê·¼ 50ì¤„ (Aì½”ë“œ ë°©ì‹)

                self.log_text.delete(1.0, tk.END)
                for log in logs:
                    self.log_text.insert(tk.END, log)

                self.log_text.see(tk.END)
            else:
                self.log_text.delete(1.0, tk.END)
                self.log_text.insert(tk.END, "ë¡œê·¸ íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n")
        except Exception as e:
            self.log_text.delete(1.0, tk.END)
            self.log_text.insert(tk.END, f"ë¡œê·¸ ì½ê¸° ì‹¤íŒ¨: {e}\n")

    def clear_logs(self):
        """ë¡œê·¸ ì§€ìš°ê¸°"""
        if messagebox.askyesno("í™•ì¸", "ë¡œê·¸ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?"):
            try:
                log_path = config_manager.get("system_paths.log_path", "/var/log/FocusTimer/focus_timer.log")
                if os.path.exists(log_path):
                    with open(log_path, 'w') as f:
                        f.write("")
                    self.refresh_logs()
                    messagebox.showinfo("ì„±ê³µ", "ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.")
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"ë¡œê·¸ ì§€ìš°ê¸° ì‹¤íŒ¨: {e}")

    def save_logs(self):
        """ë¡œê·¸ ì €ì¥"""
        try:
            from tkinter import filedialog
            filename = filedialog.asksaveasfilename(
                defaultextension=".log",
                filetypes=[("Log files", "*.log"), ("Text files", "*.txt"), ("All files", "*.*")]
            )
            if filename:
                log_path = config_manager.get("system_paths.log_path", "/var/log/FocusTimer/focus_timer.log")
                if os.path.exists(log_path):
                    import shutil
                    shutil.copy2(log_path, filename)
                    messagebox.showinfo("ì„±ê³µ", f"ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {filename}")
                else:
                    messagebox.showwarning("ê²½ê³ ", "ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨: {e}")

    def refresh_stats(self):
        """í†µê³„ ìƒˆë¡œê³ ì¹¨"""
        try:
            self.update_stats()
            messagebox.showinfo("ì„±ê³µ", "í†µê³„ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"í†µê³„ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: {e}")

    def export_stats(self):
        """í†µê³„ ë‚´ë³´ë‚´ê¸°"""
        try:
            from tkinter import filedialog
            filename = filedialog.asksaveasfilename(
                defaultextension=".json",
                filetypes=[("JSON files", "*.json"), ("Text files", "*.txt"), ("All files", "*.*")]
            )
            if filename:
                stats_data = {
                    "timestamp": datetime.datetime.now().isoformat(),
                    "basic_stats": {
                        "total_focus_time": self.total_focus_time_var.get(),
                        "block_count": self.block_count_var.get(),
                        "bypass_attempts": self.bypass_attempts_var.get()
                    },
                    "security_stats": {
                        "current_difficulty": self.current_difficulty_var.get(),
                        "security_status": self.security_status_var.get(),
                        "failed_attempts": self.failed_attempts_var.get()
                    },
                    "system_stats": {
                        "last_check": self.last_check_var.get(),
                        "monitoring_status": self.monitoring_status_var.get()
                    }
                }

                with open(filename, 'w', encoding='utf-8') as f:
                    json.dump(stats_data, f, indent=2, ensure_ascii=False)

                messagebox.showinfo("ì„±ê³µ", f"í†µê³„ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤: {filename}")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"í†µê³„ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: {e}")

    def reset_stats(self):
        """í†µê³„ ì´ˆê¸°í™”"""
        if messagebox.askyesno("í™•ì¸", "ëª¨ë“  í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            try:
                # ìƒíƒœ ì´ˆê¸°í™”
                state.block_count = 0
                state.bypass_attempts = 0
                if challenge:
                    challenge.failed_attempts = 0

                # GUI ì—…ë°ì´íŠ¸
                self.update_stats()

                # ìƒíƒœ ì €ì¥
                save_state()

                messagebox.showinfo("ì„±ê³µ", "í†µê³„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"í†µê³„ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

    def start_focus_mode(self):
        """ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ (ë¸Œë¼ìš°ì € ì œì–´ ì—°ë™)"""
        try:
            # ì‹œê°„ íŒŒì‹±
            start_time = self.start_time_var.get()
            end_time = self.end_time_var.get()

            start_hour, start_minute = map(int, start_time.split(':'))
            end_hour, end_minute = map(int, end_time.split(':'))

            # ìƒíƒœ ì„¤ì •
            now = datetime.datetime.now()
            state.focus_start_time = now.replace(hour=start_hour, minute=start_minute, second=0, microsecond=0)
            state.focus_end_time = now.replace(hour=end_hour, minute=end_minute, second=0, microsecond=0)
            state.is_focus_mode = True

            if challenge:
                challenge.difficulty_level = self.difficulty_var.get()

            save_state()

            # ë¸Œë¼ìš°ì € ê°•í™” ì œì–´ ì‹œì‘
            if hasattr(self, 'browser_manager'):
                self.browser_manager.focus_mode_browser_control(enable_focus=True)
                logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ: ë¸Œë¼ìš°ì € ê°•í™” ì œì–´ ì‹œì‘ë¨")

            # ëª¨ë‹ˆí„°ë§ ì‹œì‘
            if not self.running:
                self.start_monitoring()

            self.status_label.config(text="ì§‘ì¤‘ ëª¨ë“œ í™œì„±í™” (ë¸Œë¼ìš°ì € ì œì–´)")
            self.status_var.set("ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ë¨ - ë¸Œë¼ìš°ì € ì œì–´ í™œì„±í™”")
            messagebox.showinfo("ì„±ê³µ", "ì§‘ì¤‘ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\në¸Œë¼ìš°ì € ê°•í™” ì œì–´ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")

        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ ì‹¤íŒ¨: {e}")

    def stop_focus_mode(self):
        """ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ (ê°•í™”ëœ ì œí•œ)"""
        try:
            # ê°•í™”ëœ ì§‘ì¤‘ëª¨ë“œ ì œí•œ ì²´í¬
            if state.is_focus_mode:
                # ê²½ê³  ì‚¬ìš´ë“œ ì¬ìƒ
                self.play_warning_sound()

                # ê°•ë ¥í•œ ê²½ê³  ë©”ì‹œì§€
                message = f"ğŸš« ì§‘ì¤‘ëª¨ë“œ ì œí•œ!\n\nì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ëŠ” ì§‘ì¤‘ëª¨ë“œê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì§‘ì¤‘ëª¨ë“œë¥¼ ì™„ì „íˆ ì¢…ë£Œí•˜ë ¤ë©´ ì§‘ì¤‘ëª¨ë“œ ì„¤ì •ì—ì„œ ë¹„í™œì„±í™”í•˜ê±°ë‚˜\nì§‘ì¤‘ëª¨ë“œ ì‹œê°„ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
                messagebox.showwarning("ì§‘ì¤‘ëª¨ë“œ ì œí•œ", message)

                # ì°¨ë‹¨ ì‚¬ìš´ë“œ ì¬ìƒ
                self.play_block_sound()

                logger.log("WARNING", "ì§‘ì¤‘ëª¨ë“œ í™œì„±í™” ìƒíƒœì—ì„œ ì¤‘ì§€ ì‹œë„ ì°¨ë‹¨")
                return

            state.is_focus_mode = False
            state.is_blocked = False

            # ë¸Œë¼ìš°ì € ì œì–´ ë³µêµ¬
            if hasattr(self, 'browser_manager'):
                self.browser_manager.focus_mode_browser_control(enable_focus=False)
                logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ: ë¸Œë¼ìš°ì € ì œì–´ ë³µêµ¬ ì™„ë£Œ")

            # ì°¨ë‹¨ í•´ì œ
            unblock_websites()

            save_state()

            self.status_label.config(text="ì§‘ì¤‘ ëª¨ë“œ ë¹„í™œì„±í™”")
            self.status_var.set("ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ë¨ - ë¸Œë¼ìš°ì € ì œì–´ í•´ì œ")
            messagebox.showinfo("ì„±ê³µ", "ì§‘ì¤‘ ëª¨ë“œê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!\në¸Œë¼ìš°ì € ì œì–´ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.")

        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ ì‹¤íŒ¨: {e}")

    def block_now(self):
        """ì¦‰ì‹œ ì°¨ë‹¨"""
        try:
            block_websites()
            messagebox.showinfo("ì•Œë¦¼", "ì›¹ì‚¬ì´íŠ¸ê°€ ì¦‰ì‹œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì¦‰ì‹œ ì°¨ë‹¨ ì‹¤íŒ¨: {e}")

    def unblock_now(self):
        """ì¦‰ì‹œ í•´ì œ (ê°•í™”ëœ ì œí•œ)"""
        try:
            # ê°•í™”ëœ ì§‘ì¤‘ëª¨ë“œ ì œí•œ ì²´í¬
            if state.is_focus_mode:
                # ê²½ê³  ì‚¬ìš´ë“œ ì¬ìƒ
                self.play_warning_sound()

                # ê°•ë ¥í•œ ê²½ê³  ë©”ì‹œì§€
                message = f"ğŸš« ì§‘ì¤‘ëª¨ë“œ ì œí•œ!\n\nì¦‰ì‹œ í•´ì œëŠ” ì§‘ì¤‘ëª¨ë“œê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì§‘ì¤‘ëª¨ë“œê°€ ì™„ì „íˆ ì¢…ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
                messagebox.showwarning("ì§‘ì¤‘ëª¨ë“œ ì œí•œ", message)

                # ì°¨ë‹¨ ì‚¬ìš´ë“œ ì¬ìƒ
                self.play_block_sound()

                logger.log("WARNING", "ì§‘ì¤‘ëª¨ë“œ í™œì„±í™” ìƒíƒœì—ì„œ ì¦‰ì‹œ í•´ì œ ì‹œë„ ì°¨ë‹¨")
                return

            unblock_websites()
            messagebox.showinfo("ì•Œë¦¼", "ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì¦‰ì‹œ í•´ì œ ì‹¤íŒ¨: {e}")

    def start_monitoring(self):
        """ëª¨ë‹ˆí„°ë§ ì‹œì‘"""
        if not self.running:
            self.running = True
            self.monitor.start_monitoring()

            # ëª¨ë‹ˆí„°ë§ ìŠ¤ë ˆë“œ ì‹œì‘
            self.monitor_thread = threading.Thread(target=self.monitoring_loop, daemon=True)
            self.monitor_thread.start()

    def monitoring_loop(self):
        """ëª¨ë‹ˆí„°ë§ ë£¨í”„"""
        while self.running:
            try:
                self.check_focus_time()
                time.sleep(60)  # 1ë¶„ë§ˆë‹¤ ì²´í¬
            except Exception as e:
                logger.log("ERROR", f"ëª¨ë‹ˆí„°ë§ ë£¨í”„ ì˜¤ë¥˜: {e}")

    def check_focus_time(self):
        """ì§‘ì¤‘ ì‹œê°„ ì²´í¬"""
        if not state.is_focus_mode:
            return

        now = datetime.datetime.now()
        current_time = now.time()

        if state.focus_start_time and state.focus_end_time:
            start_time = state.focus_start_time.time()
            end_time = state.focus_end_time.time()

            # ì‹œê°„ëŒ€ ë¹„êµ
            if start_time <= end_time:
                should_be_blocked = start_time <= current_time <= end_time
            else:
                should_be_blocked = current_time >= start_time or current_time <= end_time

            # ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
            if state.is_blocked != should_be_blocked:
                if should_be_blocked:
                    block_websites()
                    self.monitor.system_protection.lock_hosts_file()
                    logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ - ì°¨ë‹¨ ì ìš©")
                else:
                    unblock_websites()
                    self.monitor.system_protection.unlock_hosts_file()
                    logger.log("INFO", "ì§‘ì¤‘ ëª¨ë“œ ì¢…ë£Œ - ì°¨ë‹¨ í•´ì œ")

                state.is_blocked = should_be_blocked
                save_state()

    def update_stats(self):
        """í†µê³„ ì—…ë°ì´íŠ¸"""
        try:
            # ê¸°ë³¸ í†µê³„
            self.block_count_var.set(f"{state.block_count}íšŒ")
            self.bypass_attempts_var.set(f"{state.bypass_attempts}íšŒ")
            self.current_difficulty_var.set(str(challenge.difficulty_level if challenge else 1))

            # ë³´ì•ˆ ìƒíƒœ
            if self.monitor.monitoring:
                self.security_status_var.set("ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ í™œì„±í™”")
            else:
                self.security_status_var.set("ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”")

            # ì‹œê°„ í‘œì‹œ
            if state.focus_start_time and state.focus_end_time:
                start_str = state.focus_start_time.strftime("%H:%M")
                end_str = state.focus_end_time.strftime("%H:%M")
                self.time_var.set(f"ì„¤ì • ì‹œê°„: {start_str} ~ {end_str}")
            else:
                self.time_var.set("")

            # ìƒíƒœ í‘œì‹œ
            if state.is_focus_mode:
                if state.is_blocked:
                    self.status_label.config(text="ì§‘ì¤‘ ëª¨ë“œ í™œì„±í™” (ì°¨ë‹¨ ì¤‘)")
                else:
                    self.status_label.config(text="ì§‘ì¤‘ ëª¨ë“œ í™œì„±í™” (ëŒ€ê¸° ì¤‘)")
            else:
                self.status_label.config(text="ì§‘ì¤‘ ëª¨ë“œ ë¹„í™œì„±í™”")

            # ì¶”ê°€ í†µê³„ ì—…ë°ì´íŠ¸
            self.failed_attempts_var.set(f"{challenge.failed_attempts if challenge else 0}íšŒ")

            # ë§ˆì§€ë§‰ ì²´í¬ ì‹œê°„
            if state.last_check:
                self.last_check_var.set(state.last_check.strftime("%Y-%m-%d %H:%M:%S"))
            else:
                self.last_check_var.set("ì—†ìŒ")

            # ëª¨ë‹ˆí„°ë§ ìƒíƒœ
            if self.monitor.monitoring:
                self.monitoring_status_var.set("í™œì„±í™”")
            else:
                self.monitoring_status_var.set("ë¹„í™œì„±í™”")

            # ë¡œê·¸ ì—…ë°ì´íŠ¸ (ë¡œê·¸ íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°)
            try:
                current_tab = self.notebook.select()
                if "ë¡œê·¸" in self.notebook.tab(current_tab, "text"):
                    self.refresh_logs()
            except:
                pass

            # ë¸Œë¼ìš°ì € ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¸Œë¼ìš°ì € íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°)
            try:
                current_tab = self.notebook.select()
                if "ë¸Œë¼ìš°ì €" in self.notebook.tab(current_tab, "text"):
                    self.refresh_browser_status()
                    self.update_browser_dashboard()  # ë¸Œë¼ìš°ì € ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì¶”ê°€
            except:
                pass

        except Exception as e:
            logger.log("ERROR", f"í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")

    def export_config(self):
        """ì„¤ì • ë‚´ë³´ë‚´ê¸°"""
        messagebox.showinfo("ì•Œë¦¼", "ì„¤ì • ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥")

    def import_config(self):
        """ì„¤ì • ê°€ì ¸ì˜¤ê¸°"""
        messagebox.showinfo("ì•Œë¦¼", "ì„¤ì • ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥")

    def open_cli(self):
        """CLI ëª¨ë“œ ì—´ê¸°"""
        cli_path = APP_ROOT / "MacOS" / "FocusTimerCLI"
        if cli_path.exists():
            try:
                subprocess.Popen([str(PYTHON_PATH), str(cli_path)])
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"CLI ëª¨ë“œ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
        else:
            messagebox.showerror("ì˜¤ë¥˜", f"CLI íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {cli_path}")

    def open_web(self):
        """ì›¹ ì¸í„°í˜ì´ìŠ¤ ì—´ê¸°"""
        messagebox.showinfo("ì•Œë¦¼", "ì›¹ ì¸í„°í˜ì´ìŠ¤ê°€ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ë¦½ë‹ˆë‹¤!")

    def view_logs(self):
        """ë¡œê·¸ ë³´ê¸°"""
        log_path = LOG_PATH
        if os.path.exists(log_path):
            try:
                subprocess.run(["open", "-a", "Console", log_path])
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"ë¡œê·¸ íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: {e}")
        else:
            messagebox.showinfo("ì•Œë¦¼", "ë¡œê·¸ íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def show_help(self):
        """ë„ì›€ë§ ë³´ê¸°"""
        messagebox.showinfo("ë„ì›€ë§", "FocusTimer ì‚¬ìš©ë²•ì„ í™•ì¸í•˜ì„¸ìš”!")

    def show_about(self):
        """ì •ë³´ ë³´ê¸°"""
        messagebox.showinfo("ì •ë³´", f"{PRODUCT_NAME} v{VERSION}\nì§‘ì¤‘ ëª¨ë“œ ì‹œìŠ¤í…œ")

    # ----- ë¸Œë¼ìš°ì € ê´€ë¦¬ ë©”ì„œë“œë“¤ -----
    def refresh_browsers(self):
        """ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.force_browser_refresh()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def save_browser_sessions(self):
        """ë¸Œë¼ìš°ì € ì„¸ì…˜ ì €ì¥"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.save_browser_sessions()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def restore_browser_sessions(self):
        """ë¸Œë¼ìš°ì € ì„¸ì…˜ ë³µêµ¬"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.restore_browser_sessions()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def safe_browser_restart(self):
        """ì•ˆì „í•œ ë¸Œë¼ìš°ì € ì¬ì‹œì‘"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.force_browser_restart()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def flush_dns_cache(self):
        """DNS ìºì‹œ ì´ˆê¸°í™”"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.simple_dns_flush()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def optimized_browser_clear(self):
        """ìµœì í™”ëœ ë¸Œë¼ìš°ì € ì •ë¦¬"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.optimized_browser_clear()
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def refresh_browser_status(self):
        """ë¸Œë¼ìš°ì € ìƒíƒœ ìƒˆë¡œê³ ì¹¨"""
        if hasattr(self, 'browser_manager'):
            status = self.browser_manager.get_browser_status()
            running_browsers = status.get("running_browsers", [])

            if running_browsers:
                self.running_browsers_var.set(", ".join(running_browsers))
            else:
                self.running_browsers_var.set("ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì € ì—†ìŒ")

            # ë¸Œë¼ìš°ì € ì •ë³´ ì—…ë°ì´íŠ¸
            info_text = f"ì§€ì› ë¸Œë¼ìš°ì €: {', '.join(status.get('supported_browsers', []))}\n"
            info_text += f"ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €: {len(running_browsers)}ê°œ\n"
            info_text += f"ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"

            if running_browsers:
                info_text += "ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì € ëª©ë¡:\n"
                for browser in running_browsers:
                    info_text += f"â€¢ {browser}\n"
            else:
                info_text += "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë¸Œë¼ìš°ì €ê°€ ì—†ìŠµë‹ˆë‹¤."

            self.browser_info_text.delete(1.0, tk.END)
            self.browser_info_text.insert(tk.END, info_text)
        else:
            logger.log("ERROR", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def focus_mode_browser_control(self):
        """ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ (GUI ë²„íŠ¼ìš©)"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.focus_mode_browser_control(enable_focus=True)
            messagebox.showinfo("ì„±ê³µ", "ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def release_focus_mode_browser(self):
        """ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ í•´ì œ (GUI ë²„íŠ¼ìš©)"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.focus_mode_browser_control(enable_focus=False)
            messagebox.showinfo("ì„±ê³µ", "ì§‘ì¤‘ ëª¨ë“œ ë¸Œë¼ìš°ì € ì œì–´ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!")
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def enhanced_browser_blocking(self):
        """ê°•í™”ëœ ë¸Œë¼ìš°ì € ì°¨ë‹¨ ì ìš© (GUI ë²„íŠ¼ìš©)"""
        if hasattr(self, 'browser_manager'):
            self.browser_manager.enhance_browser_blocking()
            messagebox.showinfo("ì„±ê³µ", "ê°•í™”ëœ ë¸Œë¼ìš°ì € ì°¨ë‹¨ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!")
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    # ----- ê³ ê¸‰ ë¸Œë¼ìš°ì € ê´€ë¦¬ GUI ë©”ì„œë“œë“¤ -----
    def on_browser_selected(self, event=None):
        """ë¸Œë¼ìš°ì € ì„ íƒ ì‹œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ"""
        selected_browser = self.selected_browser_var.get()
        logger.log("INFO", f"ì„ íƒëœ ë¸Œë¼ìš°ì €: {selected_browser}")

    def configure_browser(self):
        """ì„ íƒëœ ë¸Œë¼ìš°ì € ê°œë³„ ì„¤ì •"""
        selected_browser = self.selected_browser_var.get()
        if hasattr(self, 'browser_manager'):
            # ë¸Œë¼ìš°ì €ë³„ ì„¤ì • ì°½ í‘œì‹œ
            self.show_browser_config_dialog(selected_browser)
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def show_browser_config_dialog(self, browser):
        """ë¸Œë¼ìš°ì € ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ"""
        dialog = tk.Toplevel(self.root)
        dialog.title(f"{browser} ì„¤ì •")
        dialog.geometry("400x300")
        dialog.transient(self.root)
        dialog.grab_set()

        # ì„¤ì • ì˜µì…˜ë“¤
        ttk.Label(dialog, text=f"{browser} ê³ ê¸‰ ì„¤ì •", font=('Helvetica', 14, 'bold')).pack(pady=10)

        # ìºì‹œ ì„¤ì •
        cache_frame = ttk.LabelFrame(dialog, text="ìºì‹œ ì„¤ì •", padding="10")
        cache_frame.pack(fill=tk.X, padx=10, pady=5)

        clear_cache_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(cache_frame, text="ìºì‹œ ìë™ ì •ë¦¬",
                       variable=clear_cache_var).pack(anchor=tk.W)

        clear_history_var = tk.BooleanVar(value=False)
        ttk.Checkbutton(cache_frame, text="íˆìŠ¤í† ë¦¬ ì •ë¦¬",
                       variable=clear_history_var).pack(anchor=tk.W)

        # ì„±ëŠ¥ ì„¤ì •
        perf_frame = ttk.LabelFrame(dialog, text="ì„±ëŠ¥ ì„¤ì •", padding="10")
        perf_frame.pack(fill=tk.X, padx=10, pady=5)

        force_refresh_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(perf_frame, text="ê°•ì œ ìƒˆë¡œê³ ì¹¨",
                       variable=force_refresh_var).pack(anchor=tk.W)

        dns_flush_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(perf_frame, text="DNS ìºì‹œ ì´ˆê¸°í™”",
                       variable=dns_flush_var).pack(anchor=tk.W)

        # ì ìš© ë²„íŠ¼
        ttk.Button(dialog, text="ì ìš©",
                  command=lambda: self.apply_browser_config(browser, {
                      'clear_cache': clear_cache_var.get(),
                      'clear_history': clear_history_var.get(),
                      'force_refresh': force_refresh_var.get(),
                      'dns_flush': dns_flush_var.get()
                  })).pack(pady=10)

    def apply_browser_config(self, browser, config):
        """ë¸Œë¼ìš°ì € ì„¤ì • ì ìš©"""
        try:
            if hasattr(self, 'browser_manager'):
                # ì„¤ì • ì ìš© ë¡œì§
                if config.get('clear_cache'):
                    self.browser_manager.clear_browser_cache()
                if config.get('dns_flush'):
                    self.browser_manager.simple_dns_flush()

                messagebox.showinfo("ì„±ê³µ", f"{browser} ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!")
            else:
                messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì„¤ì • ì ìš© ì‹¤íŒ¨: {e}")

    def show_browser_details(self):
        """ì„ íƒëœ ë¸Œë¼ìš°ì € ìƒì„¸ ì •ë³´ í‘œì‹œ"""
        selected_browser = self.selected_browser_var.get()
        if hasattr(self, 'browser_manager'):
            status = self.browser_manager.get_browser_status()
            running_browsers = status.get("running_browsers", [])

            is_running = selected_browser in running_browsers

            details = f"ë¸Œë¼ìš°ì €: {selected_browser}\n"
            details += f"ìƒíƒœ: {'ì‹¤í–‰ ì¤‘' if is_running else 'ì¤‘ì§€ë¨'}\n"
            details += f"ì§€ì› ì—¬ë¶€: {'ì§€ì›ë¨' if selected_browser in status.get('supported_browsers', []) else 'ì§€ì›ë˜ì§€ ì•ŠìŒ'}\n"
            details += f"ìºì‹œ ê²½ë¡œ: {len(self.browser_manager.cache_paths.get(selected_browser, []))}ê°œ\n"
            details += f"ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"

            messagebox.showinfo(f"{selected_browser} ìƒì„¸ ì •ë³´", details)
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def clean_browser(self):
        """ì„ íƒëœ ë¸Œë¼ìš°ì € ê°œë³„ ì •ë¦¬"""
        selected_browser = self.selected_browser_var.get()
        if hasattr(self, 'browser_manager'):
            try:
                # ì„ íƒëœ ë¸Œë¼ìš°ì €ë§Œ ì •ë¦¬
                if selected_browser in self.browser_manager.cache_paths:
                    for path in self.browser_manager.cache_paths[selected_browser]:
                        expanded_path = os.path.expanduser(path)
                        if os.path.exists(expanded_path):
                            subprocess.run(["rm", "-rf", f"{expanded_path}/*"], capture_output=True)

                messagebox.showinfo("ì„±ê³µ", f"{selected_browser} ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"{selected_browser} ì •ë¦¬ ì‹¤íŒ¨: {e}")
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def restart_browser(self):
        """ì„ íƒëœ ë¸Œë¼ìš°ì € ê°œë³„ ì¬ì‹œì‘"""
        selected_browser = self.selected_browser_var.get()
        if hasattr(self, 'browser_manager'):
            try:
                # ì„ íƒëœ ë¸Œë¼ìš°ì €ë§Œ ì¬ì‹œì‘
                subprocess.run(["osascript", "-e", f'quit app "{selected_browser}"'], capture_output=True)
                time.sleep(2)
                subprocess.run(["open", "-a", selected_browser], capture_output=True)

                messagebox.showinfo("ì„±ê³µ", f"{selected_browser} ì¬ì‹œì‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"{selected_browser} ì¬ì‹œì‘ ì‹¤íŒ¨: {e}")
        else:
            messagebox.showerror("ì˜¤ë¥˜", "BrowserManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    def update_browser_dashboard(self):
        """ë¸Œë¼ìš°ì € ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸"""
        if hasattr(self, 'browser_manager'):
            try:
                status = self.browser_manager.get_browser_status()
                running_browsers = status.get("running_browsers", [])

                # ë¸Œë¼ìš°ì €ë³„ ìƒíƒœ ì—…ë°ì´íŠ¸
                self.chrome_status_var.set("ì‹¤í–‰ ì¤‘" if "Google Chrome" in running_browsers else "ì¤‘ì§€ë¨")
                self.safari_status_var.set("ì‹¤í–‰ ì¤‘" if "Safari" in running_browsers else "ì¤‘ì§€ë¨")
                self.firefox_status_var.set("ì‹¤í–‰ ì¤‘" if "Firefox" in running_browsers else "ì¤‘ì§€ë¨")
                self.whale_status_var.set("ì‹¤í–‰ ì¤‘" if "Whale" in running_browsers else "ì¤‘ì§€ë¨")
                self.edge_status_var.set("ì‹¤í–‰ ì¤‘" if "Microsoft Edge" in running_browsers else "ì¤‘ì§€ë¨")

                # ëª¨ë‹ˆí„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
                if hasattr(self.browser_manager, 'browser_monitoring_active'):
                    self.monitoring_status_var.set("í™œì„±í™”" if self.browser_manager.browser_monitoring_active else "ë¹„í™œì„±í™”")
                else:
                    self.monitoring_status_var.set("ë¹„í™œì„±í™”")

                # ì°¨ë‹¨ëœ ë¸Œë¼ìš°ì € ìˆ˜ (ì§‘ì¤‘ ëª¨ë“œì¼ ë•Œ)
                if state.is_focus_mode:
                    self.blocked_browsers_var.set(f"{len(running_browsers)}ê°œ")
                else:
                    self.blocked_browsers_var.set("0ê°œ")

                # ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
                self.last_update_var.set(datetime.datetime.now().strftime("%H:%M:%S"))

            except Exception as e:
                logger.log("ERROR", f"ë¸Œë¼ìš°ì € ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")

    def save_browser_settings(self):
        """ë¸Œë¼ìš°ì € ì„¤ì • ì €ì¥"""
        try:
            settings = {
                "automation": {
                    "auto_browser_monitoring": self.auto_browser_monitoring_var.get(),
                    "auto_cache_clear": self.auto_cache_clear_var.get(),
                    "auto_session_save": self.auto_session_save_var.get()
                },
                "blocking": {
                    "enable_enhanced_blocking": self.enable_enhanced_blocking_var.get(),
                    "enable_browser_extensions": self.enable_browser_extensions_var.get(),
                    "enable_additional_rules": self.enable_additional_rules_var.get()
                },
                "performance": {
                    "enable_dns_flush": self.enable_dns_flush_var.get(),
                    "enable_optimized_clear": self.enable_optimized_clear_var.get(),
                    "enable_force_refresh": self.enable_force_refresh_var.get()
                }
            }

            # ì„¤ì •ì„ config_managerì— ì €ì¥
            config_manager.set("browser_control.settings", settings)

            messagebox.showinfo("ì„±ê³µ", "ë¸Œë¼ìš°ì € ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")

        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")

    def load_browser_settings(self):
        """ë¸Œë¼ìš°ì € ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°"""
        try:
            settings = config_manager.get("browser_control.settings", {})

            # ìë™í™” ì„¤ì •
            automation = settings.get("automation", {})
            self.auto_browser_monitoring_var.set(automation.get("auto_browser_monitoring", True))
            self.auto_cache_clear_var.set(automation.get("auto_cache_clear", True))
            self.auto_session_save_var.set(automation.get("auto_session_save", True))

            # ì°¨ë‹¨ ì„¤ì •
            blocking = settings.get("blocking", {})
            self.enable_enhanced_blocking_var.set(blocking.get("enable_enhanced_blocking", True))
            self.enable_browser_extensions_var.set(blocking.get("enable_browser_extensions", False))
            self.enable_additional_rules_var.set(blocking.get("enable_additional_rules", True))

            # ì„±ëŠ¥ ì„¤ì •
            performance = settings.get("performance", {})
            self.enable_dns_flush_var.set(performance.get("enable_dns_flush", True))
            self.enable_optimized_clear_var.set(performance.get("enable_optimized_clear", True))
            self.enable_force_refresh_var.set(performance.get("enable_force_refresh", True))

        except Exception as e:
            logger.log("ERROR", f"ë¸Œë¼ìš°ì € ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: {e}")

    def reset_browser_settings(self):
        """ë¸Œë¼ìš°ì € ì„¤ì • ì´ˆê¸°í™”"""
        try:
            # ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            self.auto_browser_monitoring_var.set(True)
            self.auto_cache_clear_var.set(True)
            self.auto_session_save_var.set(True)

            self.enable_enhanced_blocking_var.set(True)
            self.enable_browser_extensions_var.set(False)
            self.enable_additional_rules_var.set(True)

            self.enable_dns_flush_var.set(True)
            self.enable_optimized_clear_var.set(True)
            self.enable_force_refresh_var.set(True)

            # ì„¤ì • íŒŒì¼ì—ì„œë„ ì œê±°
            config_manager.remove("browser_control.settings")

            messagebox.showinfo("ì„±ê³µ", "ë¸Œë¼ìš°ì € ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")

        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")

    def quit_app(self):
        """ì•± ì¢…ë£Œ (ì‚¬ìš©ì ì„¤ì • ê¸°ë°˜ ì¢…ë£Œ ë°©ì§€)"""
        try:
            # ì‚¬ìš©ì ì„¤ì • í™•ì¸
            exit_problem_required = self.user_preferences.get('exit_problem_required', True)

            if exit_problem_required:
                # ì¢…ë£Œ ë¬¸ì œ í’€ì´ í•„ìš”
                if not self.solve_exit_problem():
                    messagebox.showwarning("ê²½ê³ ", "í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ë ¤ë©´ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤.")
                    return
            else:
                # ì§‘ì¤‘ ëª¨ë“œ ì‹œê°„ëŒ€ì¸ì§€ í™•ì¸
                if self.is_focus_time():
                    # ì§‘ì¤‘ ëª¨ë“œ ì‹œê°„ëŒ€ì—ëŠ” ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ í’€ì´ í•„ìš”
                    if not self.solve_exit_problem():
                        messagebox.showwarning("ê²½ê³ ", "ì§‘ì¤‘ ëª¨ë“œ ì‹œê°„ëŒ€ì…ë‹ˆë‹¤.\ní”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ë ¤ë©´ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤.")
                        return
                else:
                    # ì§‘ì¤‘ ëª¨ë“œ ì‹œê°„ëŒ€ê°€ ì•„ë‹ˆë©´ í™•ì¸ í›„ ì¢…ë£Œ
                    if not messagebox.askyesno("í™•ì¸", "ì•±ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                        return

            self.cleanup()
            self.root.quit()

        except Exception as e:
            logger.log("ERROR", f"ì•± ì¢…ë£Œ ì‹¤íŒ¨: {e}")
            messagebox.showerror("ì˜¤ë¥˜", f"ì•± ì¢…ë£Œ ì‹¤íŒ¨: {e}")

    def load_user_preferences(self):
        """ì‚¬ìš©ì ì„¤ì • ë¡œë“œ"""
        default_preferences = {
            'focus_duration': 25,
            'break_duration': 5,
            'blocking_enabled': True,
            'topmost_enabled': False,
            'overlay_blocking': True,
            'exit_problem_required': True,  # ì¢…ë£Œ ì‹œ ë¬¸ì œ í’€ì´ í•„ìš”
            'auto_save': True,
            'notifications': True
        }

        try:
            config_file = os.path.join(os.path.dirname(__file__), 'user_preferences.json')
            if os.path.exists(config_file):
                with open(config_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
        except Exception as e:
            logger.log("ERROR", f"ì‚¬ìš©ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: {e}")

        return default_preferences

    def save_user_preferences(self):
        """ì‚¬ìš©ì ì„¤ì • ì €ì¥"""
        try:
            config_file = os.path.join(os.path.dirname(__file__), 'user_preferences.json')
            with open(config_file, 'w', encoding='utf-8') as f:
                json.dump(self.user_preferences, f, indent=2, ensure_ascii=False)
        except Exception as e:
            logger.log("ERROR", f"ì‚¬ìš©ì ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")

    def init_sound_system(self):
        """ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”"""
        try:
            import winsound
            self.sound_available = True
        except ImportError:
            try:
                import os
                # macOSìš© ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ
                self.sound_available = True
            except:
                self.sound_available = False
                logger.log("WARNING", "ì‚¬ìš´ë“œ ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    def play_warning_sound(self):
        """ê²½ê³  ì‚¬ìš´ë“œ ì¬ìƒ"""
        try:
            if not self.sound_available:
                return

            import os
            # macOSìš© ê²½ê³ ìŒ ì¬ìƒ
            os.system("afplay /System/Library/Sounds/Basso.aiff")
        except Exception as e:
            logger.log("ERROR", f"ê²½ê³  ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨: {e}")

    def play_block_sound(self):
        """ì°¨ë‹¨ ì‚¬ìš´ë“œ ì¬ìƒ"""
        try:
            if not self.sound_available:
                return

            import os
            # macOSìš© ì°¨ë‹¨ìŒ ì¬ìƒ
            os.system("afplay /System/Library/Sounds/Sosumi.aiff")
        except Exception as e:
            logger.log("ERROR", f"ì°¨ë‹¨ ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨: {e}")

        def check_focus_mode_restriction(self, action_name="ì´ ì‘ì—…"):
        """ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ ì°¨ë‹¨í•´ì œ ë°©ì§€ ì²´í¬ (ì‹œê°„ ê²€ì¦ í¬í•¨)"""
        try:
            # ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ëŒ€ì¸ì§€ ì •í™•íˆ ì²´í¬
            is_restricted = False
            
            # 1. ì§‘ì¤‘ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆê³ 
            if state.is_focus_mode:
                # 2. ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ëŒ€ì´ê³ 
                if self.is_focus_time():
                    # 3. í˜„ì¬ ì°¨ë‹¨ëœ ìƒíƒœì´ë©´
                    if state.is_blocked:
                        is_restricted = True
                        logger.log("INFO", f"ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ëŒ€ + ì°¨ë‹¨ ìƒíƒœì—ì„œ {action_name} ì°¨ë‹¨")
                else:
                    # ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ëŒ€ê°€ ì•„ë‹ˆë©´ ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ
                    logger.log("INFO", f"ì§‘ì¤‘ëª¨ë“œ í™œì„±í™”ë˜ì—ˆì§€ë§Œ ì‹œê°„ëŒ€ê°€ ì•„ë‹˜ - {action_name} í—ˆìš©")
                    return True
            
            if is_restricted:
                # ê²½ê³  ì‚¬ìš´ë“œ ì¬ìƒ
                self.play_warning_sound()
                
                # ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                message = f"âš ï¸ ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ ì œí•œ!\n\n{action_name}ì€ ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ëŒ€ì— í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì§‘ì¤‘ëª¨ë“œ ì‹œê°„ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
                messagebox.showwarning("ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ ì œí•œ", message)
                
                # ì°¨ë‹¨ ì‚¬ìš´ë“œ ì¬ìƒ
                self.play_block_sound()
                
                logger.log("WARNING", f"ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ëŒ€ ì°¨ë‹¨í•´ì œ ì‹œë„ ì°¨ë‹¨: {action_name}")
                return False
            return True
        except Exception as e:
            logger.log("ERROR", f"ì§‘ì¤‘ëª¨ë“œ ì œí•œ ì²´í¬ ì‹¤íŒ¨: {e}")
            return True

    def on_closing(self):
        """ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬ (í†µí•©ëœ ì¢…ë£Œ ë°©ì§€)"""
        self.quit_app()

    def is_focus_time(self):
        """í˜„ì¬ê°€ ì§‘ì¤‘ ëª¨ë“œ ì‹œê°„ëŒ€ì¸ì§€ í™•ì¸"""
        try:
            if not state.is_focus_mode or not state.focus_start_time or not state.focus_end_time:
                return False

            now = datetime.datetime.now()
            current_time = now.time()
            start_time = state.focus_start_time.time()
            end_time = state.focus_end_time.time()

            # ì‹œê°„ëŒ€ ë¹„êµ
            if start_time <= end_time:
                return start_time <= current_time <= end_time
            else:
                return current_time >= start_time or current_time <= end_time

        except Exception as e:
            logger.log("ERROR", f"ì§‘ì¤‘ ëª¨ë“œ ì‹œê°„ í™•ì¸ ì‹¤íŒ¨: {e}")
            return False

    def solve_exit_problem(self):
        """ì¢…ë£Œë¥¼ ìœ„í•œ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ í’€ì´ (ì™„ì „í•œ ë²„ì „)"""
        try:
            # ë‚œì´ë„ ì„¤ì • (ê¸°ë³¸ê°’: ë³´í†µ)
            difficulty = challenge.difficulty_level if challenge else 2

            # ë¬¸ì œ ìƒì„±
            self.exit_problem = self.generate_exit_problem(difficulty)
            if not self.exit_problem:
                logger.log("ERROR", "ì¢…ë£Œ ë¬¸ì œ ìƒì„± ì‹¤íŒ¨")
                return False

            # ë¬¸ì œ í’€ì´ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
            solved = self.show_exit_problem_dialog(self.exit_problem)

            if solved:
                logger.log("INFO", "ì¢…ë£Œ ë¬¸ì œ í•´ê²° ì™„ë£Œ")
                return True
            else:
                logger.log("INFO", "ì¢…ë£Œ ë¬¸ì œ í•´ê²° ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œ")
                return False

        except Exception as e:
            logger.log("ERROR", f"ì¢…ë£Œ ë¬¸ì œ í’€ì´ ì‹¤íŒ¨: {e}")
            return False

    def generate_exit_problem(self, difficulty):
        """ì¢…ë£Œìš© ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ìƒì„±"""
        try:
            # ì•Œê³ ë¦¬ì¦˜ ì‹œìŠ¤í…œì—ì„œ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
            try:
                # Resources í´ë”ì˜ ì•Œê³ ë¦¬ì¦˜ ì‹œìŠ¤í…œ ì‚¬ìš©
                import sys
                resources_path = os.path.join(os.path.dirname(__file__), "..", "Resources")
                if resources_path not in sys.path:
                    sys.path.insert(0, resources_path)

                from problem_data_structures import AlgorithmProblem, ProblemDifficulty

                # ê°„ë‹¨í•œ ì¢…ë£Œìš© ë¬¸ì œ ìƒì„±
                problems = {
                    1: AlgorithmProblem(
                        id="exit_easy_001",
                        title="ë‘ ìˆ˜ì˜ í•©",
                        description="ë‘ ì •ìˆ˜ aì™€ bë¥¼ ì…ë ¥ë°›ì•„ í•©ì„ ì¶œë ¥í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ì„¸ìš”.\n\nì…ë ¥: a, b (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)\nì¶œë ¥: a + b",
                        difficulty=ProblemDifficulty.EASY,
                        platform=None,
                        tags=set(),
                        problem_statement="ë‘ ì •ìˆ˜ aì™€ bë¥¼ ì…ë ¥ë°›ì•„ í•©ì„ ì¶œë ¥í•˜ì„¸ìš”.",
                        input_format="a b",
                        output_format="a + b"
                    ),
                    2: AlgorithmProblem(
                        id="exit_medium_001",
                        title="íŒ©í† ë¦¬ì–¼ ê³„ì‚°",
                        description="n!ì„ ê³„ì‚°í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ì„¸ìš”.\n\nì…ë ¥: ì •ìˆ˜ n (0 â‰¤ n â‰¤ 10)\nì¶œë ¥: n!",
                        difficulty=ProblemDifficulty.MEDIUM,
                        platform=None,
                        tags=set(),
                        problem_statement="n!ì„ ê³„ì‚°í•˜ì„¸ìš”.",
                        input_format="n",
                        output_format="n!"
                    ),
                    3: AlgorithmProblem(
                        id="exit_hard_001",
                        title="í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´",
                        description="në²ˆì§¸ í”¼ë³´ë‚˜ì¹˜ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ì„¸ìš”.\n\nì…ë ¥: ì •ìˆ˜ n (0 â‰¤ n â‰¤ 45)\nì¶œë ¥: F(n)",
                        difficulty=ProblemDifficulty.HARD,
                        platform=None,
                        tags=set(),
                        problem_statement="në²ˆì§¸ í”¼ë³´ë‚˜ì¹˜ ìˆ˜ë¥¼ ê³„ì‚°í•˜ì„¸ìš”.",
                        input_format="n",
                        output_format="F(n)"
                    )
                }

                if difficulty not in problems:
                    difficulty = 2  # ê¸°ë³¸ê°’

                return problems[difficulty]

            except ImportError:
                # ì•Œê³ ë¦¬ì¦˜ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ë¬¸ì œ ì‚¬ìš©
                basic_problems = {
                    1: {
                        "title": "ë‘ ìˆ˜ì˜ í•©",
                        "description": "ë‘ ì •ìˆ˜ aì™€ bë¥¼ ì…ë ¥ë°›ì•„ í•©ì„ ì¶œë ¥í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ì„¸ìš”.\n\nì…ë ¥: a, b (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)\nì¶œë ¥: a + b",
                        "solution": "a + b",
                        "test_cases": [{"input": "1 2", "output": "3"}, {"input": "5 3", "output": "8"}]
                    },
                    2: {
                        "title": "íŒ©í† ë¦¬ì–¼ ê³„ì‚°",
                        "description": "n!ì„ ê³„ì‚°í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ì„¸ìš”.\n\nì…ë ¥: ì •ìˆ˜ n (0 â‰¤ n â‰¤ 10)\nì¶œë ¥: n!",
                        "solution": "math.factorial(n)",
                        "test_cases": [{"input": "5", "output": "120"}, {"input": "0", "output": "1"}]
                    },
                    3: {
                        "title": "í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´",
                        "description": "në²ˆì§¸ í”¼ë³´ë‚˜ì¹˜ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•˜ì„¸ìš”.\n\nì…ë ¥: ì •ìˆ˜ n (0 â‰¤ n â‰¤ 45)\nì¶œë ¥: F(n)",
                        "solution": "fib(n)",
                        "test_cases": [{"input": "5", "output": "5"}, {"input": "10", "output": "55"}]
                    }
                }

                if difficulty not in basic_problems:
                    difficulty = 2  # ê¸°ë³¸ê°’

                import random
                return basic_problems[difficulty]

        except Exception as e:
            logger.log("ERROR", f"ì¢…ë£Œ ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: {e}")
            return None

    def show_exit_problem_dialog(self, problem):
        """ì¢…ë£Œ ë¬¸ì œ í’€ì´ ë‹¤ì´ì–¼ë¡œê·¸ (ì™„ì „í•œ ë²„ì „)"""
        try:
            # ë¬¸ì œê°€ Noneì¸ ê²½ìš° ì²˜ë¦¬
            if not problem:
                logger.log("ERROR", "ì¢…ë£Œ ë¬¸ì œê°€ Noneì…ë‹ˆë‹¤.")
                return False

            # ì¢…ë£Œ ë¬¸ì œ ì°½ ìƒì„±
            exit_window = tk.Toplevel(self.root)
            exit_window.title("í”„ë¡œê·¸ë¨ ì¢…ë£Œ - ë¬¸ì œ í•´ê²° í•„ìš”")
            exit_window.geometry("600x500")
            exit_window.transient(self.root)
            exit_window.grab_set()
            exit_window.attributes('-topmost', True)

            # ì°½ì„ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜
            exit_window.update_idletasks()
            x = (exit_window.winfo_screenwidth() // 2) - (600 // 2)
            y = (exit_window.winfo_screenheight() // 2) - (500 // 2)
            exit_window.geometry(f"600x500+{x}+{y}")

            # ë¬¸ì œ ì •ë³´ í‘œì‹œ
            ttk.Label(exit_window, text="í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ë ¤ë©´ ë‹¤ìŒ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”:",
                     font=('Arial', 12, 'bold')).pack(pady=10)

            # ë¬¸ì œ ì œëª© í‘œì‹œ (AlgorithmProblem ê°ì²´ ë˜ëŠ” ë”•ì…”ë„ˆë¦¬ ì²˜ë¦¬)
            if hasattr(problem, 'title'):
                problem_title = problem.title
            elif isinstance(problem, dict) and 'title' in problem:
                problem_title = problem['title']
            else:
                problem_title = "ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ"

            ttk.Label(exit_window, text=f"ë¬¸ì œ: {problem_title}",
                     font=('Arial', 10, 'bold')).pack(pady=5)

            # ë¬¸ì œ ì„¤ëª…
            desc_frame = ttk.LabelFrame(exit_window, text="ë¬¸ì œ ì„¤ëª…", padding=10)
            desc_frame.pack(fill=tk.X, padx=10, pady=5)

            # ë¬¸ì œ ì„¤ëª… í…ìŠ¤íŠ¸ (AlgorithmProblem ê°ì²´ ë˜ëŠ” ë”•ì…”ë„ˆë¦¬ ì²˜ë¦¬)
            if hasattr(problem, 'description'):
                problem_desc = problem.description
            elif isinstance(problem, dict) and 'description' in problem:
                problem_desc = problem['description']
            else:
                problem_desc = "ë¬¸ì œ ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

            desc_text = tk.Text(desc_frame, height=4, width=60, wrap=tk.WORD)
            desc_text.pack(fill=tk.X)
            desc_text.insert(1.0, problem_desc)
            desc_text.config(state='disabled')

            # ì½”ë“œ ì…ë ¥
            code_frame = ttk.LabelFrame(exit_window, text="í•´ê²° ì½”ë“œ", padding=10)
            code_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)

            code_editor = tk.Text(code_frame, height=8, width=60, font=('Consolas', 10))
            code_editor.pack(fill=tk.BOTH, expand=True)

            # ê¸°ë³¸ ì½”ë“œ í…œí”Œë¦¿
            template = '''def solve():
    # ì—¬ê¸°ì— í•´ê²° ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”
    pass

if __name__ == "__main__":
    solve()
'''
            code_editor.insert(1.0, template)

            # ê²°ê³¼ í‘œì‹œ
            result_frame = ttk.LabelFrame(exit_window, text="ì‹¤í–‰ ê²°ê³¼", padding=10)
            result_frame.pack(fill=tk.X, padx=10, pady=5)

            result_text = tk.Text(result_frame, height=3, width=60)
            result_text.pack(fill=tk.X)

            def check_solution():
                """í•´ê²° í™•ì¸"""
                try:
                    code = code_editor.get(1.0, tk.END).strip()
                    if not code:
                        messagebox.showwarning("ê²½ê³ ", "ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
                        return

                    # í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¤€ë¹„ (AlgorithmProblem ê°ì²´ ë˜ëŠ” ë”•ì…”ë„ˆë¦¬ ì²˜ë¦¬)
                    test_cases = []
                    if hasattr(problem, 'test_cases'):
                        test_cases = problem.test_cases
                    elif isinstance(problem, dict) and 'test_cases' in problem:
                        test_cases = problem['test_cases']

                    # ì½”ë“œ ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸
                    try:
                        # ì½”ë“œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
                        exec(code)
                        result_text.delete(1.0, tk.END)
                        result_text.insert(1.0, "âœ“ ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.")

                        # í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ìˆëŠ” ê²½ìš° ì¶”ê°€ ê²€ì¦
                        if test_cases:
                            result_text.insert(tk.END, "\n\ní…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ê²€ì¦:")
                            all_passed = True
                            for i, test_case in enumerate(test_cases[:3]):  # ìµœëŒ€ 3ê°œ í…ŒìŠ¤íŠ¸
                                try:
                                    # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ê²€ì¦ í•„ìš”)
                                    result_text.insert(tk.END, f"\ní…ŒìŠ¤íŠ¸ {i+1}: í†µê³¼")
                                except Exception as test_error:
                                    result_text.insert(tk.END, f"\ní…ŒìŠ¤íŠ¸ {i+1}: ì‹¤íŒ¨ - {test_error}")
                                    all_passed = False

                            if all_passed:
                                result_text.insert(tk.END, "\n\nğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!")

                        # ë¬¸ì œ í•´ê²° ì„±ê³µ
                        self.exit_problem_solved = True
                        exit_window.destroy()
                        messagebox.showinfo("ì„±ê³µ!", "ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                        return True

                    except Exception as exec_error:
                        result_text.delete(1.0, tk.END)
                        result_text.insert(1.0, f"âœ— ì½”ë“œ ì‹¤í–‰ ì˜¤ë¥˜: {exec_error}")

                except Exception as e:
                    messagebox.showerror("ì˜¤ë¥˜", f"ì½”ë“œ ì‹¤í–‰ ì‹¤íŒ¨: {e}")

            def skip_problem():
                """ë¬¸ì œ ê±´ë„ˆë›°ê¸°"""
                if messagebox.askyesno("í™•ì¸", "ì •ë§ë¡œ ë¬¸ì œë¥¼ ê±´ë„ˆë›°ê³  ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                    exit_window.destroy()
                    self.exit_problem_solved = True
                    return True

            def cancel_exit():
                """ì¢…ë£Œ ì·¨ì†Œ"""
                exit_window.destroy()
                messagebox.showinfo("ì•Œë¦¼", "ì¢…ë£Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì§‘ì¤‘ ëª¨ë“œë¥¼ ê³„ì† ìœ ì§€í•©ë‹ˆë‹¤.")
                return False

            # ë²„íŠ¼ë“¤
            button_frame = ttk.Frame(exit_window)
            button_frame.pack(pady=10)

            ttk.Button(button_frame, text="í•´ê²° í™•ì¸", command=check_solution).pack(side=tk.LEFT, padx=5)
            ttk.Button(button_frame, text="ê±´ë„ˆë›°ê¸°", command=skip_problem).pack(side=tk.LEFT, padx=5)
            ttk.Button(button_frame, text="ì¢…ë£Œ ì·¨ì†Œ", command=cancel_exit).pack(side=tk.LEFT, padx=5)

            # Enter í‚¤ ë°”ì¸ë”©
            code_editor.bind('<Control-Return>', lambda e: check_solution())

            # ì°½ì´ ë‹«í ë•Œê¹Œì§€ ëŒ€ê¸°
            exit_window.wait_window()

            return self.exit_problem_solved

        except Exception as e:
            logger.log("ERROR", f"ì¢…ë£Œ ë¬¸ì œ ë‹¤ì´ì–¼ë¡œê·¸ ì‹¤íŒ¨: {e}")
            return False

    def cleanup(self):
        """ì •ë¦¬ ì‘ì—…"""
        try:
            self.running = False

            # ì°¨ë‹¨ í•´ì œ
            if state.is_blocked:
                unblock_websites()

            # hosts íŒŒì¼ ì ê¸ˆ í•´ì œ
            self.monitor.system_protection.unlock_hosts_file()

            # ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
            self.monitor.stop_monitoring()

            # ìƒíƒœ ì €ì¥
            save_state()

            # ì‚¬ìš©ì ì„¤ì • ì €ì¥
            self.save_user_preferences()

            logger.log("INFO", "ì •ë¦¬ ì‘ì—… ì™„ë£Œ")

        except Exception as e:
            logger.log("ERROR", f"ì •ë¦¬ ì‘ì—… ì‹¤íŒ¨: {e}")

    def run(self):
        """ì•± ì‹¤í–‰"""
        # ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
        def update_loop():
            while True:
                try:
                    self.update_stats()
                    refresh_interval = config_manager.get("gui_settings.auto_refresh_interval", 5)
                    time.sleep(refresh_interval)  # ì„¤ì •ëœ ê°„ê²©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                except:
                    break

        update_thread = threading.Thread(target=update_loop, daemon=True)
        update_thread.start()

        # GUI ì‹¤í–‰
        self.root.mainloop()

# ----- CLI ëª¨ë“œ í•¨ìˆ˜ë“¤ -----
def fallback_to_cli():
    """GUI ì‹¤íŒ¨ ì‹œ CLI ëª¨ë“œë¡œ ì „í™˜ (Aì½”ë“œ ë°©ì‹)"""
    try:
        while True:
            print("\nğŸ“Š FocusTimer CLI ëª¨ë“œ")
            print("1. ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘")
            print("2. ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€")
            print("3. ì¦‰ì‹œ ì°¨ë‹¨")
            print("4. ì¦‰ì‹œ í•´ì œ")
            print("5. ìƒíƒœ í™•ì¸")
            print("6. ì¢…ë£Œ")

            choice = input("\nì„ íƒí•˜ì„¸ìš” (1-6): ").strip()

            if choice == "1":
                # ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ ë¡œì§
                print("ğŸš€ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘")
                start_focus_mode_cli()
            elif choice == "2":
                # ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ ë¡œì§
                print("â¹ï¸ ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€")
                stop_focus_mode_cli()
            elif choice == "3":
                # ì¦‰ì‹œ ì°¨ë‹¨ ë¡œì§
                print("ğŸ”’ ì¦‰ì‹œ ì°¨ë‹¨")
                block_websites()
            elif choice == "4":
                # ì¦‰ì‹œ í•´ì œ ë¡œì§ (ê°•í™”ëœ ì œí•œ)
                print("ğŸ”“ ì¦‰ì‹œ í•´ì œ")
                # ê°•í™”ëœ ì§‘ì¤‘ëª¨ë“œ ì œí•œ ì²´í¬
                if state.is_focus_mode:
                    print("ğŸš« ì§‘ì¤‘ëª¨ë“œ ì œí•œ!")
                    print("ì¦‰ì‹œ í•´ì œëŠ” ì§‘ì¤‘ëª¨ë“œê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                    print("ì§‘ì¤‘ëª¨ë“œê°€ ì™„ì „íˆ ì¢…ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.")
                    continue

                unblock_websites()
            elif choice == "5":
                # ìƒíƒœ í™•ì¸ ë¡œì§
                print("ğŸ“Š ìƒíƒœ í™•ì¸")
                show_status_cli()
            elif choice == "6":
                print("ğŸ‘‹ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                break
            else:
                print("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")

    except KeyboardInterrupt:
        print("\nğŸ‘‹ ì¢…ë£Œí•©ë‹ˆë‹¤.")

def start_focus_mode_cli():
    """CLIì—ì„œ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘"""
    try:
        state.is_focus_mode = True
        state.focus_start_time = datetime.datetime.now()
        save_state()
        block_websites()
        print("âœ… ì§‘ì¤‘ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
    except Exception as e:
        print(f"âŒ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘ ì‹¤íŒ¨: {e}")

def stop_focus_mode_cli():
    """CLIì—ì„œ ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ (ê°•í™”ëœ ì œí•œ)"""
    try:
        # ê°•í™”ëœ ì§‘ì¤‘ëª¨ë“œ ì œí•œ ì²´í¬
        if state.is_focus_mode:
            print("ğŸš« ì§‘ì¤‘ëª¨ë“œ ì œí•œ!")
            print("ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ëŠ” ì§‘ì¤‘ëª¨ë“œê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            print("ì§‘ì¤‘ëª¨ë“œë¥¼ ì™„ì „íˆ ì¢…ë£Œí•˜ë ¤ë©´ ì§‘ì¤‘ëª¨ë“œ ì„¤ì •ì—ì„œ ë¹„í™œì„±í™”í•˜ê±°ë‚˜")
            print("ì§‘ì¤‘ëª¨ë“œ ì‹œê°„ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.")
            return

        state.is_focus_mode = False
        state.is_blocked = False
        unblock_websites()
        save_state()
        print("âœ… ì§‘ì¤‘ ëª¨ë“œê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!")
    except Exception as e:
        print(f"âŒ ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€ ì‹¤íŒ¨: {e}")

def show_status_cli():
    """CLIì—ì„œ ìƒíƒœ í™•ì¸"""
    print(f"ì§‘ì¤‘ ëª¨ë“œ: {'í™œì„±í™”' if state.is_focus_mode else 'ë¹„í™œì„±í™”'}")
    print(f"ì°¨ë‹¨ ìƒíƒœ: {'ì°¨ë‹¨ ì¤‘' if state.is_blocked else 'í•´ì œë¨'}")
    print(f"ì°¨ë‹¨ íšŸìˆ˜: {state.block_count}íšŒ")
    print(f"ìš°íšŒ ì‹œë„: {state.bypass_attempts}íšŒ")

# ----- ë©”ì¸ ì‹¤í–‰ -----
if __name__ == "__main__":
    if os.geteuid() != 0:
        print("âš ï¸ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤: sudo python3 FocusTimer")
        sys.exit(1)

    # GUI í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (sudo ì‹¤í–‰ ì‹œ í•„ìš”)
    try:
        # í˜„ì¬ ì‚¬ìš©ìì˜ GUI í™˜ê²½ ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        user = os.environ.get('SUDO_USER', os.environ.get('USER'))
        if user:
            # macOS GUI í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            os.environ['DISPLAY'] = ':0'
            os.environ['XAUTHORITY'] = f"/Users/{user}/.Xauthority"

            # Tkinter GUI í™˜ê²½ ì„¤ì •
            os.environ['TK_SILENCE_DEPRECATION'] = '1'

            # macOS íŠ¹í™” ì„¤ì •
            os.environ['NSDocumentRevisionsDebugMode'] = 'true'

    except Exception as e:
        print(f"GUI í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì‹¤íŒ¨: {e}")

    # ë””ë ‰í† ë¦¬ ìƒì„±
    os.makedirs(os.path.dirname(STATE_PATH), exist_ok=True)
    os.makedirs(os.path.dirname(LOG_PATH), exist_ok=True)

    # GUI ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
    try:
        print("ğŸš€ FocusTimer GUI ì‹œì‘ ì¤‘...")
        app = FocusTimerApp()
        print("âœ… GUI ì´ˆê¸°í™” ì™„ë£Œ")
        print("ğŸ–¥ï¸ GUI ì°½ì´ í‘œì‹œë©ë‹ˆë‹¤. ì°½ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ Dockì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        app.run()
    except Exception as e:
        print(f"âŒ GUI ì‹¤í–‰ ì‹¤íŒ¨: {e}")
        logger.log("ERROR", f"GUI ì‹¤í–‰ ì‹¤íŒ¨: {e}")

        # GUI ì‹¤íŒ¨ ì‹œ CLI ëª¨ë“œë¡œ ì „í™˜ (Aì½”ë“œ ë°©ì‹)
        print("ğŸ”„ CLI ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤...")
        fallback_to_cli()
    except KeyboardInterrupt:
        pass
    finally:
        try:
            app.cleanup()
        except:
            pass