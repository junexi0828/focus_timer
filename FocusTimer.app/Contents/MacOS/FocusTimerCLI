#!/usr/bin/env python3
"""
FocusTimerCLI - ëª…ë ¹ì¤„ ì¸í„°í˜ì´ìŠ¤
í„°ë¯¸ë„ì—ì„œ FocusTimerë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” CLI ë„êµ¬
"""

import argparse
import sys
import json
import subprocess
from pathlib import Path

# ì•± ê²½ë¡œ ì„¤ì •
APP_ROOT = Path(__file__).parent.parent
RESOURCES_PATH = APP_ROOT / "Resources"
VENV_PATH = APP_ROOT.parent / "focus_timer_env"

# Python ê²½ë¡œ ì„¤ì • (ê°€ìƒí™˜ê²½ì´ ì—†ìœ¼ë©´ ì‹œìŠ¤í…œ Python ì‚¬ìš©)
if (VENV_PATH / "bin" / "python").exists():
    PYTHON_PATH = VENV_PATH / "bin" / "python"
else:
    PYTHON_PATH = Path("/usr/bin/python3")

class FocusTimerCLI:
    def __init__(self):
        self.config = self.load_config()

    def load_config(self):
        """ì„¤ì • íŒŒì¼ ë¡œë“œ"""
        config_path = RESOURCES_PATH / "config.json"
        try:
            if config_path.exists():
                with open(config_path, 'r') as f:
                    return json.load(f)
            else:
                print(f"ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {config_path}")
                return {}
        except Exception as e:
            print(f"ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return {}

    def start_focus_mode(self, start_time=None, end_time=None, difficulty=None):
        """ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘"""
        print("ğŸš€ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘...")

        # ì„¤ì • ì—…ë°ì´íŠ¸
        if start_time:
            self.config.setdefault("focus_mode", {})["default_start_time"] = start_time
        if end_time:
            self.config.setdefault("focus_mode", {})["default_end_time"] = end_time
        if difficulty:
            self.config.setdefault("focus_mode", {})["default_difficulty"] = difficulty

        # ì„¤ì • ì €ì¥
        self.save_config()

        # ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ì— ì‹ í˜¸ ì „ì†¡
        print("âœ… ì§‘ì¤‘ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def stop_focus_mode(self):
        """ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€"""
        print("â¹ï¸ ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€...")
        print("âœ… ì§‘ì¤‘ ëª¨ë“œê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def block_now(self):
        """ì¦‰ì‹œ ì°¨ë‹¨"""
        print("ğŸ”’ ì›¹ì‚¬ì´íŠ¸ ì¦‰ì‹œ ì°¨ë‹¨...")
        print("âœ… ì›¹ì‚¬ì´íŠ¸ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def unblock_now(self):
        """ì¦‰ì‹œ í•´ì œ"""
        print("ğŸ”“ ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ í•´ì œ...")
        print("âœ… ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!")

    def show_status(self):
        """ìƒíƒœ í‘œì‹œ"""
        print("ğŸ“Š FocusTimer ìƒíƒœ")
        print("=" * 30)

        # ì„¤ì • ì •ë³´
        focus_config = self.config.get("focus_mode", {})
        print(f"ì‹œì‘ ì‹œê°„: {focus_config.get('default_start_time', '09:00')}")
        print(f"ì¢…ë£Œ ì‹œê°„: {focus_config.get('default_end_time', '18:00')}")
        print(f"ë‚œì´ë„: {focus_config.get('default_difficulty', 1)}")

        # ë³´ì•ˆ ì„¤ì •
        security_config = self.config.get("security", {})
        print(f"íŒŒì¼ ëª¨ë‹ˆí„°ë§: {'í™œì„±í™”' if security_config.get('enable_file_monitoring', True) else 'ë¹„í™œì„±í™”'}")
        print(f"ìë™ ë³µêµ¬: {'í™œì„±í™”' if security_config.get('enable_auto_recovery', True) else 'ë¹„í™œì„±í™”'}")

    def show_help(self):
        """ë„ì›€ë§ í‘œì‹œ"""
        help_text = """
FocusTimer CLI - ëª…ë ¹ì¤„ ì¸í„°í˜ì´ìŠ¤

ì‚¬ìš©ë²•:
  focus-timer start [--start-time TIME] [--end-time TIME] [--difficulty LEVEL]
  focus-timer stop
  focus-timer block
  focus-timer unblock
  focus-timer status
  focus-timer help

ëª…ë ¹ì–´:
  start     ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘
  stop      ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€
  block     ì›¹ì‚¬ì´íŠ¸ ì¦‰ì‹œ ì°¨ë‹¨
  unblock   ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ í•´ì œ
  status    í˜„ì¬ ìƒíƒœ í‘œì‹œ
  help      ë„ì›€ë§ í‘œì‹œ

ì˜µì…˜:
  --start-time TIME     ì‹œì‘ ì‹œê°„ (HH:MM í˜•ì‹, ê¸°ë³¸ê°’: 09:00)
  --end-time TIME       ì¢…ë£Œ ì‹œê°„ (HH:MM í˜•ì‹, ê¸°ë³¸ê°’: 18:00)
  --difficulty LEVEL    ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ë‚œì´ë„ (1-5, ê¸°ë³¸ê°’: 1)

ì˜ˆì‹œ:
  focus-timer start --start-time 08:30 --end-time 17:30 --difficulty 3
  focus-timer block
  focus-timer status
"""
        print(help_text)

    def save_config(self):
        """ì„¤ì • ì €ì¥"""
        config_path = RESOURCES_PATH / "config.json"
        try:
            # ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
            config_path.parent.mkdir(parents=True, exist_ok=True)

            with open(config_path, 'w') as f:
                json.dump(self.config, f, indent=2)
            print("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
        except Exception as e:
            print(f"ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")

def main():
    parser = argparse.ArgumentParser(description="FocusTimer CLI")
    subparsers = parser.add_subparsers(dest='command', help='ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´')

    # start ëª…ë ¹ì–´
    start_parser = subparsers.add_parser('start', help='ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘')
    start_parser.add_argument('--start-time', help='ì‹œì‘ ì‹œê°„ (HH:MM)')
    start_parser.add_argument('--end-time', help='ì¢…ë£Œ ì‹œê°„ (HH:MM)')
    start_parser.add_argument('--difficulty', type=int, choices=[1, 2, 3, 4, 5], help='ë‚œì´ë„ (1-5)')

    # stop ëª…ë ¹ì–´
    subparsers.add_parser('stop', help='ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€')

    # block ëª…ë ¹ì–´
    subparsers.add_parser('block', help='ì›¹ì‚¬ì´íŠ¸ ì¦‰ì‹œ ì°¨ë‹¨')

    # unblock ëª…ë ¹ì–´
    subparsers.add_parser('unblock', help='ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ í•´ì œ')

    # status ëª…ë ¹ì–´
    subparsers.add_parser('status', help='í˜„ì¬ ìƒíƒœ í‘œì‹œ')

    # help ëª…ë ¹ì–´
    subparsers.add_parser('help', help='ë„ì›€ë§ í‘œì‹œ')

    args = parser.parse_args()

    cli = FocusTimerCLI()

    if args.command == 'start':
        cli.start_focus_mode(
            start_time=args.start_time,
            end_time=args.end_time,
            difficulty=args.difficulty
        )
    elif args.command == 'stop':
        cli.stop_focus_mode()
    elif args.command == 'block':
        cli.block_now()
    elif args.command == 'unblock':
        cli.unblock_now()
    elif args.command == 'status':
        cli.show_status()
    elif args.command == 'help':
        cli.show_help()
    else:
        cli.show_help()

if __name__ == "__main__":
    main()