#!/usr/bin/env python3
"""
FocusTimerCLI - ëª…ë ¹ì¤„ ì¸í„°í˜ì´ìŠ¤
í„°ë¯¸ë„ì—ì„œ FocusTimerë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” CLI ë„êµ¬
"""

import argparse
import sys
import json
import subprocess
from pathlib import Path
import os

# ì•± ê²½ë¡œ ì„¤ì •
APP_ROOT = Path(__file__).parent.parent
RESOURCES_PATH = APP_ROOT / "Resources"
VENV_PATH = APP_ROOT.parent / "focus_timer_env"

# Python ê²½ë¡œ ì„¤ì • (ê°€ìƒí™˜ê²½ì´ ì—†ìœ¼ë©´ ì‹œìŠ¤í…œ Python ì‚¬ìš©)
if (VENV_PATH / "bin" / "python").exists():
    PYTHON_PATH = VENV_PATH / "bin" / "python"
else:
    PYTHON_PATH = Path("/usr/bin/python3")

class FocusTimerCLI:
    def __init__(self):
        self.config = self.load_config()

    def load_config(self):
        """ì„¤ì • íŒŒì¼ ë¡œë“œ"""
        config_path = RESOURCES_PATH / "config.json"
        try:
            if config_path.exists():
                with open(config_path, 'r') as f:
                    return json.load(f)
            else:
                print(f"ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {config_path}")
                return {}
        except Exception as e:
            print(f"ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}")
            return {}

    def start_focus_mode(self, start_time=None, end_time=None, difficulty=None):
        """ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘"""
        print("ğŸš€ ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘...")

        # ì„¤ì • ì—…ë°ì´íŠ¸
        if start_time:
            self.config.setdefault("focus_mode", {})["default_start_time"] = start_time
        if end_time:
            self.config.setdefault("focus_mode", {})["default_end_time"] = end_time
        if difficulty:
            self.config.setdefault("focus_mode", {})["default_difficulty"] = difficulty

        # ì„¤ì • ì €ì¥
        self.save_config()

        # ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ì— ì‹ í˜¸ ì „ì†¡
        print("âœ… ì§‘ì¤‘ ëª¨ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def stop_focus_mode(self):
        """ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€"""
        print("â¹ï¸ ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€...")
        print("âœ… ì§‘ì¤‘ ëª¨ë“œê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def block_now(self):
        """ì¦‰ì‹œ ì°¨ë‹¨"""
        print("ğŸ”’ ì›¹ì‚¬ì´íŠ¸ ì¦‰ì‹œ ì°¨ë‹¨...")
        print("âœ… ì›¹ì‚¬ì´íŠ¸ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def unblock_now(self):
        """ì¦‰ì‹œ í•´ì œ"""
        print("ğŸ”“ ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ í•´ì œ...")
        print("âœ… ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!")

    def show_status(self):
        """ìƒíƒœ í‘œì‹œ"""
        print("ğŸ“Š FocusTimer ìƒíƒœ")
        print("=" * 30)

        # ì„¤ì • ì •ë³´
        focus_config = self.config.get("focus_mode", {})
        print(f"ì‹œì‘ ì‹œê°„: {focus_config.get('default_start_time', '09:00')}")
        print(f"ì¢…ë£Œ ì‹œê°„: {focus_config.get('default_end_time', '18:00')}")
        print(f"ë‚œì´ë„: {focus_config.get('default_difficulty', 1)}")

        # ë³´ì•ˆ ì„¤ì •
        security_config = self.config.get("security", {})
        print(f"íŒŒì¼ ëª¨ë‹ˆí„°ë§: {'í™œì„±í™”' if security_config.get('enable_file_monitoring', True) else 'ë¹„í™œì„±í™”'}")
        print(f"ìë™ ë³µêµ¬: {'í™œì„±í™”' if security_config.get('enable_auto_recovery', True) else 'ë¹„í™œì„±í™”'}")

    def show_help(self):
        """ë„ì›€ë§ í‘œì‹œ"""
        help_text = """
FocusTimer CLI - ëª…ë ¹ì¤„ ì¸í„°í˜ì´ìŠ¤

ì‚¬ìš©ë²•:
  focus-timer start [--start-time TIME] [--end-time TIME] [--difficulty LEVEL]
  focus-timer stop
  focus-timer block
  focus-timer unblock
  focus-timer status
  focus-timer logs
  focus-timer version
  focus-timer update
  focus-timer backup
  focus-timer restore
  focus-timer help

ëª…ë ¹ì–´:
  start     ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘
  stop      ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€
  block     ì›¹ì‚¬ì´íŠ¸ ì¦‰ì‹œ ì°¨ë‹¨
  unblock   ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ í•´ì œ
  status    í˜„ì¬ ìƒíƒœ í‘œì‹œ
  logs      ë¡œê·¸ íŒŒì¼ í™•ì¸
  version   ë²„ì „ ì •ë³´ í‘œì‹œ
  update    ì—…ë°ì´íŠ¸ í™•ì¸ ë° ì‹¤í–‰
  backup    ì„¤ì • ë°±ì—…
  restore   ì„¤ì • ë³µêµ¬
  help      ë„ì›€ë§ í‘œì‹œ

ì˜µì…˜:
  --start-time TIME     ì‹œì‘ ì‹œê°„ (HH:MM í˜•ì‹, ê¸°ë³¸ê°’: 09:00)
  --end-time TIME       ì¢…ë£Œ ì‹œê°„ (HH:MM í˜•ì‹, ê¸°ë³¸ê°’: 18:00)
  --difficulty LEVEL    ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ ë‚œì´ë„ (1-5, ê¸°ë³¸ê°’: 1)

ê´€ë¦¬ ëª…ë ¹ì–´:
  focus-timer service start|stop|restart|status
  focus-timer config show|edit|backup|restore
  focus-timer logs main|helper|error|clear
  focus-timer system info|check|repair

ì˜ˆì‹œ:
  focus-timer start --start-time 08:30 --end-time 17:30 --difficulty 3
  focus-timer block
  focus-timer status
  focus-timer logs main
  focus-timer service restart
  focus-timer update
"""
        print(help_text)

    def save_config(self):
        """ì„¤ì • ì €ì¥"""
        config_path = RESOURCES_PATH / "config.json"
        try:
            # ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
            config_path.parent.mkdir(parents=True, exist_ok=True)

            with open(config_path, 'w') as f:
                json.dump(self.config, f, indent=2)
            print("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
        except Exception as e:
            print(f"ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")

    def show_logs(self, log_type="main"):
        """ë¡œê·¸ íŒŒì¼ í™•ì¸"""
        log_files = {
            "main": "/var/log/FocusTimer/focus_timer.log",
            "helper": "/var/log/FocusTimer/helper.log",
            "error": "/var/log/FocusTimer/helper_error.log"
        }

        log_file = log_files.get(log_type, log_files["main"])

        if os.path.exists(log_file):
            print(f"ğŸ“Š {log_type.upper()} ë¡œê·¸ (ìµœê·¼ 20ì¤„):")
            print("=" * 50)
            with open(log_file, 'r') as f:
                lines = f.readlines()
                for line in lines[-20:]:
                    print(line.rstrip())
        else:
            print(f"âŒ ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {log_file}")

    def show_version(self):
        """ë²„ì „ ì •ë³´ í‘œì‹œ"""
        try:
            version = subprocess.check_output([
                "defaults", "read",
                "/Applications/FocusTimer.app/Contents/Info.plist",
                "CFBundleShortVersionString"
            ], text=True).strip()
            print(f"ğŸ“¦ FocusTimer ë²„ì „: {version}")
        except:
            print("âŒ ë²„ì „ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    def check_update(self):
        """ì—…ë°ì´íŠ¸ í™•ì¸"""
        print("ğŸ”„ ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘...")
        try:
            # ì›ê²© ë²„ì „ í™•ì¸
            response = subprocess.check_output([
                "curl", "-s",
                "https://api.github.com/repos/your-repo/focus-timer/releases/latest"
            ], text=True)

            # JSON íŒŒì‹± (ê°„ë‹¨í•œ ë°©ë²•)
            if '"tag_name"' in response:
                remote_version = response.split('"tag_name"')[1].split('"')[1].replace('v', '')
                print(f"ğŸŒ ì›ê²© ìµœì‹  ë²„ì „: {remote_version}")

                # ë¡œì»¬ ë²„ì „ í™•ì¸
                local_version = subprocess.check_output([
                    "defaults", "read",
                    "/Applications/FocusTimer.app/Contents/Info.plist",
                    "CFBundleShortVersionString"
                ], text=True).strip()

                print(f"ğŸ’» ë¡œì»¬ ë²„ì „: {local_version}")

                if remote_version > local_version:
                    print("âœ… ì—…ë°ì´íŠ¸ê°€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!")
                    update = input("ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
                    if update.lower() == 'y':
                        subprocess.run(["./installers/update_focustimer_app.sh"])
                else:
                    print("âœ… ì´ë¯¸ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤.")
            else:
                print("âŒ ì›ê²© ë²„ì „ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        except Exception as e:
            print(f"âŒ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨: {e}")

    def backup_config(self):
        """ì„¤ì • ë°±ì—…"""
        config_file = "/Applications/FocusTimer.app/Contents/Resources/config.json"
        backup_file = f"{config_file}.backup.$(date +%Y%m%d_%H%M%S)"

        if os.path.exists(config_file):
            subprocess.run(["sudo", "cp", config_file, backup_file])
            print(f"ğŸ’¾ ì„¤ì • ë°±ì—… ì™„ë£Œ: {backup_file}")
        else:
            print("âŒ ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    def restore_config(self):
        """ì„¤ì • ë³µêµ¬"""
        config_file = "/Applications/FocusTimer.app/Contents/Resources/config.json"
        backup_pattern = f"{config_file}.backup.*"

        # ë°±ì—… íŒŒì¼ ëª©ë¡ í™•ì¸
        backup_files = subprocess.check_output(["ls", "-t", backup_pattern], text=True).strip().split('\n')

        if backup_files and backup_files[0]:
            latest_backup = backup_files[0]
            print(f"ğŸ“‹ ìµœì‹  ë°±ì—…: {latest_backup}")
            restore = input("ì´ ë°±ì—…ì—ì„œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
            if restore.lower() == 'y':
                subprocess.run(["sudo", "cp", latest_backup, config_file])
                print("âœ… ì„¤ì • ë³µêµ¬ ì™„ë£Œ")
        else:
            print("âŒ ë°±ì—… íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    def service_control(self, action):
        """ì„œë¹„ìŠ¤ ì œì–´"""
        service_file = "/Library/LaunchAgents/com.focustimer.helper.plist"

        if action == "start":
            subprocess.run(["sudo", "launchctl", "load", service_file])
            print("âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ")
        elif action == "stop":
            subprocess.run(["sudo", "launchctl", "unload", service_file])
            print("â¹ï¸ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ")
        elif action == "restart":
            subprocess.run(["sudo", "launchctl", "unload", service_file])
            subprocess.run(["sudo", "launchctl", "load", service_file])
            print("ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ")
        elif action == "status":
            result = subprocess.run(["sudo", "launchctl", "list"], capture_output=True, text=True)
            if "com.focustimer.helper" in result.stdout:
                print("âœ… ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤")
            else:
                print("âŒ ì„œë¹„ìŠ¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤")

    def config_control(self, action):
        """ì„¤ì • ì œì–´"""
        config_file = "/Applications/FocusTimer.app/Contents/Resources/config.json"

        if action == "show":
            if os.path.exists(config_file):
                with open(config_file, 'r') as f:
                    print(f.read())
            else:
                print("âŒ ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        elif action == "edit":
            subprocess.run(["sudo", "nano", config_file])
        elif action == "backup":
            self.backup_config()
        elif action == "restore":
            self.restore_config()

    def system_info(self):
        """ì‹œìŠ¤í…œ ì •ë³´ í‘œì‹œ"""
        print("ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´:")
        print("=" * 30)

        # macOS ë²„ì „
        macos_version = subprocess.check_output(["sw_vers", "-productVersion"], text=True).strip()
        print(f"macOS: {macos_version}")

        # Python ë²„ì „
        python_version = subprocess.check_output(["python3", "--version"], text=True).strip()
        print(f"Python: {python_version}")

        # ì•± ë²„ì „
        try:
            app_version = subprocess.check_output([
                "defaults", "read",
                "/Applications/FocusTimer.app/Contents/Info.plist",
                "CFBundleShortVersionString"
            ], text=True).strip()
            print(f"FocusTimer: {app_version}")
        except:
            print("FocusTimer: ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ")

        # ì„œë¹„ìŠ¤ ìƒíƒœ
        result = subprocess.run(["sudo", "launchctl", "list"], capture_output=True, text=True)
        if "com.focustimer.helper" in result.stdout:
            print("ì„œë¹„ìŠ¤: ì‹¤í–‰ ì¤‘")
        else:
            print("ì„œë¹„ìŠ¤: ì¤‘ì§€ë¨")

        # ë””ìŠ¤í¬ ê³µê°„
        disk_space = subprocess.check_output(["df", "-h", "/Applications"], text=True).split('\n')[1].split()[4]
        print(f"ë””ìŠ¤í¬ ê³µê°„: {disk_space} ì‚¬ìš©")

def main():
    parser = argparse.ArgumentParser(description="FocusTimer CLI")
    subparsers = parser.add_subparsers(dest='command', help='ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´')

    # start ëª…ë ¹ì–´
    start_parser = subparsers.add_parser('start', help='ì§‘ì¤‘ ëª¨ë“œ ì‹œì‘')
    start_parser.add_argument('--start-time', help='ì‹œì‘ ì‹œê°„ (HH:MM)')
    start_parser.add_argument('--end-time', help='ì¢…ë£Œ ì‹œê°„ (HH:MM)')
    start_parser.add_argument('--difficulty', type=int, choices=[1, 2, 3, 4, 5], help='ë‚œì´ë„ (1-5)')

    # stop ëª…ë ¹ì–´
    subparsers.add_parser('stop', help='ì§‘ì¤‘ ëª¨ë“œ ì¤‘ì§€')

    # block ëª…ë ¹ì–´
    subparsers.add_parser('block', help='ì›¹ì‚¬ì´íŠ¸ ì¦‰ì‹œ ì°¨ë‹¨')

    # unblock ëª…ë ¹ì–´
    subparsers.add_parser('unblock', help='ì›¹ì‚¬ì´íŠ¸ ì°¨ë‹¨ í•´ì œ')

    # status ëª…ë ¹ì–´
    subparsers.add_parser('status', help='í˜„ì¬ ìƒíƒœ í‘œì‹œ')

    # logs ëª…ë ¹ì–´
    logs_parser = subparsers.add_parser('logs', help='ë¡œê·¸ íŒŒì¼ í™•ì¸')
    logs_parser.add_argument('type', nargs='?', default='main', choices=['main', 'helper', 'error'], help='ë¡œê·¸ íƒ€ì…')

    # version ëª…ë ¹ì–´
    subparsers.add_parser('version', help='ë²„ì „ ì •ë³´ í‘œì‹œ')

    # update ëª…ë ¹ì–´
    subparsers.add_parser('update', help='ì—…ë°ì´íŠ¸ í™•ì¸ ë° ì‹¤í–‰')

    # backup ëª…ë ¹ì–´
    subparsers.add_parser('backup', help='ì„¤ì • ë°±ì—…')

    # restore ëª…ë ¹ì–´
    subparsers.add_parser('restore', help='ì„¤ì • ë³µêµ¬')

    # service ëª…ë ¹ì–´
    service_parser = subparsers.add_parser('service', help='ì„œë¹„ìŠ¤ ì œì–´')
    service_parser.add_argument('action', choices=['start', 'stop', 'restart', 'status'], help='ì„œë¹„ìŠ¤ ì•¡ì…˜')

    # config ëª…ë ¹ì–´
    config_parser = subparsers.add_parser('config', help='ì„¤ì • ì œì–´')
    config_parser.add_argument('action', choices=['show', 'edit', 'backup', 'restore'], help='ì„¤ì • ì•¡ì…˜')

    # system ëª…ë ¹ì–´
    system_parser = subparsers.add_parser('system', help='ì‹œìŠ¤í…œ ì •ë³´')
    system_parser.add_argument('action', choices=['info', 'check', 'repair'], help='ì‹œìŠ¤í…œ ì•¡ì…˜')

    # help ëª…ë ¹ì–´
    subparsers.add_parser('help', help='ë„ì›€ë§ í‘œì‹œ')

    args = parser.parse_args()

    cli = FocusTimerCLI()

    if args.command == 'start':
        cli.start_focus_mode(
            start_time=args.start_time,
            end_time=args.end_time,
            difficulty=args.difficulty
        )
    elif args.command == 'stop':
        cli.stop_focus_mode()
    elif args.command == 'block':
        cli.block_now()
    elif args.command == 'unblock':
        cli.unblock_now()
    elif args.command == 'status':
        cli.show_status()
    elif args.command == 'logs':
        cli.show_logs(args.type)
    elif args.command == 'version':
        cli.show_version()
    elif args.command == 'update':
        cli.check_update()
    elif args.command == 'backup':
        cli.backup_config()
    elif args.command == 'restore':
        cli.restore_config()
    elif args.command == 'service':
        cli.service_control(args.action)
    elif args.command == 'config':
        cli.config_control(args.action)
    elif args.command == 'system':
        if args.action == 'info':
            cli.system_info()
        else:
            print(f"ì‹œìŠ¤í…œ {args.action} ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    elif args.command == 'help':
        cli.show_help()
    else:
        cli.show_help()

if __name__ == "__main__":
    main()